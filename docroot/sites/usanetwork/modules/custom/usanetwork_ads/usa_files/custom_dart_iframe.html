<!DOCTYPE html>
<!--[if lt IE 7 ]> <html class="ie6 no-js"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7 no-js"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8 no-js"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9 no-js"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!-->
<html class="no-js" lang="en" dir="ltr">
<!--<![endif]-->
<head>
<meta charset="utf-8" />
<title>Ad Iframe | USA Network</title>
<script>
if (typeof eTandomAd == "undefined") eTandomAd = "none";

var usa_debugFlag = false; /* just for testing */
var usa_debug = function(msg)
{
	if (usa_debugFlag)
	{
		/* just for testing */
		/*
		if (usa_deviceInfo.mobileDevice) {
			parent.jQuery('body').append('<div style="color:#ffffff"><hr><pre>' +JSON.stringify(msg, null, 4)+ '</pre></div>');
		}
		*/
		if (typeof console != 'undefined')
		{
			console.log(msg);
		}
	}
}

// get the device info of the parent
var usa_deviceInfo = parent.usa_deviceInfo;


// tag function similar to the DART.tag function
usa_outputAdTag = function(tag) {
  //usa_debug('usa_outputAdTag() called, using tag: '); usa_debug(tag);

  tag = typeof(tag) == 'string' ? eval('(' + tag + ')') : tag;

  if (usa_deviceInfo.smartphone) {
    // SMARTPHONE
    if (tag.sz == '728x90' || tag.sz == '728x90,970x66') {
        tag.sz = '300x50';
        tag.key_vals.sz[0] = {'val' : '300x50', 'eval': false};
    } else if (tag.sz == '300x250') {
      // no 300x250's on mobile, so exit, unless its the homepage and it will turn into a mobile unit
      return;
    }
  } else if (usa_deviceInfo.mobileDevice && !usa_deviceInfo.smartphone) {
    // TABLET
    if (tag.sz == '728x90,970x66' || tag.sz == '728x90') {
        // no OPA push down's for tablets thanks! and only if sponsored
        tag.sz == '728x90';
        tag.key_vals.sz[0] = {'val' : '728x90', 'eval': false};
    }
  } else {
    // DESKTOP

  }


  // as we are inside of an iframe we need to force units to use adj instea of adi
  tag.settings.options.method = 'adj';

  var tagname = tag.settings.options.method == 'adj' ? 'script' : 'iframe';
  var options = tag.settings.options.method == 'adj' ? 'type="text/javascript"' : 'frameborder="0" scrolling="no" width="' + tag.sz.split("x")[0] + '" height="' + tag.sz.split("x")[1] + '"';

  // Allow other modules to include js that can manipulate the tag object.
  var processed_tag = ($ !== undefined) ? $(document).triggerHandler('dart_tag_process', [tag]) : undefined;
  tag = processed_tag !== undefined ? processed_tag : tag;

  
  if (usa_deviceInfo.smartphone) {
    // SMARTPHONE
    tag.key_vals.sz[0] = {'val' : '300x50', 'eval': false};
    delete tag.key_vals.dcopt;
    delete tag.key_vals.tile;
    delete tag.key_vals.pm;
    delete tag.key_vals.tandomad;

    ad = '<' + tagname + ' ' + options + ' src="';
    ad +="http://ad.mo.doubleclick.net/DARTProxy/mobile.handler?k=N2620/mo.";
    ad += tag.site + "/";
    //ad += tag.zone;
    if (typeof tag.key_vals.sect != 'undefined') {
      var sectVal = (tag.key_vals.sect[0].eval) ? eval(tag.key_vals.sect[0].val) : tag.key_vals.sect[0].val;
      if (sectVal != '') {
        ad += sectVal + "_";
      }
    }
   if (typeof tag.key_vals.sub != 'undefined') {
      var subVal = (tag.key_vals.sub[0].eval) ? eval(tag.key_vals.sub[0].val) : tag.key_vals.sub[0].val;
      if (subVal != '') {
        ad += subVal;
      }
    }
    ad += ";mdeck=1";
    ad += "site=" + tag.site + ";";
    ad += keyVals(tag.key_vals);

    // usa_debug('Smartphone Device Detected, outputting mobile ad tag: ');
  } else if (usa_deviceInfo.mobileDevice && !usa_deviceInfo.smartphone) {
    // TABLET
    ad = '<' + tagname + ' ' + options + ' src="';
    ad += dart_url + "/";
    ad += tag.network_id !== '' ? tag.network_id + "/" : "";
    ad += tag.settings.options.method + "/";
    ad += tag.prefix + '.' + tag.site + "/"; // + tag.zone;
    if (typeof tag.key_vals.sect != 'undefined') {
      var sectVal = (tag.key_vals.sect[0].eval) ? eval(tag.key_vals.sect[0].val) : tag.key_vals.sect[0].val;
      if (sectVal != '') {
        ad += sectVal + "_";
      }
    }
    if (typeof tag.key_vals.sub != 'undefined') {
      var subVal = (tag.key_vals.sub[0].eval) ? eval(tag.key_vals.sub[0].val) : tag.key_vals.sub[0].val;
      if (subVal != '') {
        ad += subVal + '_tablet';
      } else {
        ad += 'tablet';
      }
    } else {
      ad += 'tablet';
    }
    ad += ";platform=tablet;!c=tablet";
    ad += ";" + keyVals(tag.key_vals);

    // usa_debug('Tablet Device Detected, outputting tablet ad tag: ');
  } else {
    // DESKTOP
    ad = '<' + tagname + ' ' + options + ' src="';
    ad += dart_url + "/";
    ad += tag.network_id !== '' ? tag.network_id + "/" : "";
    ad += tag.settings.options.method + "/";
    ad += tag.prefix + '.' + tag.site + "/"; // + tag.zone;
    if (typeof tag.key_vals.sect != 'undefined') {
      var sectVal = (tag.key_vals.sect[0].eval) ? eval(tag.key_vals.sect[0].val) : tag.key_vals.sect[0].val;
      if (sectVal != '') {
        ad += sectVal + "_";
      }
    }
    if (typeof tag.key_vals.sub != 'undefined') {
      var subVal = (tag.key_vals.sub[0].eval) ? eval(tag.key_vals.sub[0].val) : tag.key_vals.sub[0].val;
      if (subVal != '') {
        ad += subVal;
      }
    }
    ad += ";" + keyVals(tag.key_vals);

    // usa_debug('Desktop Detected, outputting desktop ad tag: ');
  }
  // Allow other modules to include js that can manipulate the concatenated tag string.
  rendered_ad = ($ !== undefined) ? $(document).triggerHandler('dart_tag_render', [ad]) : undefined;
  ad = rendered_ad !== undefined ? rendered_ad : ad;

  if (!usa_deviceInfo.smartphone)  {
    ad += '"></' + tagname + '>';
  } else {
    ad = ad.replace('pm=1;', ''); // temp hack until I work out where this is being appended
    ad += '&forecast=1&csit=1&dw=1"></' + tagname + '>';
  }

  //usa_debug(tag);
  usa_debug('AD TAG: ' + escape(ad));

  document.write(ad);

  return ad;
};

 function keyVals(vals) {
	  var ad = '';
	  for(var key in vals) {
	    value = vals[key];
	    for(var val in value) {
	      v = value[val];
	      ad += keyVal(key, v['val'], v['eval']);
	    }
	  }
	  return ad;
	}

 function keyVal(key, val, useEval) {
	  if (key != "<none>") {
	    kvp  = key + "=";
	    kvp += useEval ? eval(val) : val;
	    kvp += key == "ord" ? "?" : ";";
	  }
	  else {
	    kvp = useEval ? eval(val) : val;
	  }

	  return(kvp);
	}

/* rails code from current site */
var usa_defaultBgImg, usa_defaultBgAttach, usa_defaultBgPos, usa_defaultBgCol;

// this will set the rails once the page is done loading and call our usa_setRails function
jQuery(document).ready(function() {
	var p1 = null;
	var p2 = null;
	var p3 = null;
	var p4 = null;

	if((typeof railAdBg !='undefined') && railAdBg)
	{
		p1 = railAdBg;
	}

	if((typeof railAdBgColor !='undefined') && railAdBgColor)
	{
		p2 = railAdBgColor;
	}

	if((typeof railAdBgRepeat !='undefined') && railAdBgRepeat)
	{
		p3 = railAdBgRepeat;
	}

	if((typeof railAdBgClickthru !='undefined') && railAdBgClickthru)
	{
		p4 = railAdBgClickthru;
	}

	usa_debug('p1: '+p1+'\np2: '+p2+'\np3: '+p3+'\np4: '+p4);
	if ((p1 != null || p2 != null || p3 != null || p4 != null) && typeof parent.usa_setRails != 'undefined')
	{
		parent.usa_setRails(p1, p2, p3, p4);
	}
});

function getUrlVars() {
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++) {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}

var dart_url = parent.dart_url || "http://ad.doubleclick.net";
var tile = parent.tile || 1;
var ord = parent.ord || (1000000000 + Math.floor(Math.random() * 900000000));

</script>

<style>
body {
	margin: 0px;
	padding: 0px;
	background: transparent;
}
</style>

</head>
<body>

	<script>
	// get dart ad tag from query string
	usa_debug(usa_deviceInfo);
	
	var tagKey = getUrlVars()['key'];
	usa_debug('IFRAME: tagKey: ' + tagKey);

	var tagObj = parent.usa_getCurrentTagObj(tagKey);
	usa_debug('IFRAME: tagObj: '); usa_debug(tagObj);

	usa_outputAdTag(tagObj);

	</script>
</body>
</html>

