<?php
/**
 * @file
 * Code for the usanetwork_catchall feature.
 */

include_once 'usanetwork_catchall.features.inc';
define('USA_CATCHALL_RELATED_CONTENT_ITEMS', 6);

/**
 *  Implements hook_menu().
 */
function usanetwork_catchall_menu() {
  $items = array();
  $items['ajax/usanetwork-catchall/get-related/%node/%/%'] = array(
    'title' => 'Related content',
    'page callback' => 'usanetwork_catchall_get_related_content_ajax',
    'page arguments' => array(3, 4, 5),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_theme().
 */

function usanetwork_catchall_theme($existing, $type, $theme, $path) {
  return array(
    'usanetwork_catchall_related_item' => array(
      'variables' => array(
        'classes' => NULL,
        'custom_classes' => NULL,
        'target_url' => NULL,
        'caption' => NULL,
        'title' => NULL,
        'additional' => NULL,
        'image_mobile' => NULL,
        'image_desktop' => NULL,
      ),
      'template' => 'templates/usanetwork-catchall-related-item',
    ),
    'usanetwork_catchall_related_items_block' => array(
      'variables' => array(
        'ad' => NULL,
        'related_items' => array(),
      ),
      'template' => 'templates/usanetwork-catchall-related-items-block',
    ),
    'usanetwork_catchall_related_items_container' => array(
      'variables' => array(
        'related_items_block' => NULL,
        'load_more_link' => NULL,
        'items_pre_page_limit' => NULL,
        'show_nid' => NULL,
      ),
      'template' => 'templates/usanetwork-catchall-related-items-container',
    ),
  );
}

/**
 * Implements hook_preprocess_HOOK().
 */
function usanetwork_catchall_preprocess_html(&$vars) {
  // Load node
  $node = menu_get_object();
  if ($node && $node->type == 'catchall_page') {
    $fixedwidth_field = field_get_items('node', $node, 'field_usa_catchall_fixedwidth');
    // add a body class if this checkbox has been selected
    if ($fixedwidth_field[0]['value'] == '1') {
      $vars['classes_array'][] = 'usa-fixed-width';
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function usanetwork_catchall_preprocess_page(&$vars) {
  // Load node, hide title on the frontend
  $node = menu_get_object();
  if ($node && $node->type == 'catchall_page') {
    $vars['title'] = '';

    //Settings for MPS reloadable Ad
    $field_automatic_refresh = _usanetwork_get_field_item('node', $node, 'field_automatic_refresh' ,'value');
    if ($field_automatic_refresh && $field_automatic_refresh == '1') {
      $field_refresh_time = _usanetwork_get_field_item('node', $node, 'field_refresh_time' ,'value');
      drupal_add_js(array('CatchallRefreshSettings' => array('time' => ($field_refresh_time) ? $field_refresh_time : '')), 'setting');
    }
  }
}

/*
 * Returns content for usanetwork_catchall_related_content_content block.
 */
function _usanetwork_catchall_related_content() {
  if (path_is_admin(current_path())) {
    return '';
  }

  $node = menu_get_object('node');
  if (!empty($node) && $node->type == 'catchall_page') {
    if (empty($node->field_tvs_show_latest_feed)) {
      return '';
    }
    else {
      $latest_content_flag_field = field_get_items('node', $node, 'field_tvs_show_latest_feed');

      if ($latest_content_flag_field[0]['value'] == 0) {
        return '';
      }
    }
    $show = field_get_items('node', $node, 'field_show');
    if (!empty($show)) {
      $show = is_array($show) ? reset($show) : $show;
      $show = node_load($show['target_id']);
      if (!empty($show)) {
        $you_may_also_like_item = usanetwork_tv_shows_get_ymal_item($show);
        $related_content = _usanetwork_tv_shows_cache_get_limited_related_catchall_content(
          $show, 0,
          !empty($you_may_also_like_item)
            ? USA_CATCHALL_RELATED_CONTENT_ITEMS - 1
            : USA_CATCHALL_RELATED_CONTENT_ITEMS
        );
        if (!empty($you_may_also_like_item)) {
          $related_content[] = $you_may_also_like_item;
        }
        if (!empty($related_content)) {
          if (!empty($related_content)) {
            drupal_add_js(drupal_get_path('module', 'usanetwork_tv_shows') . '/js/usanetwork_tv_shows_related_items_loader.js');
            drupal_add_js(array(
              'usanetwork_tv_show_nid' => $show->nid,
              'usanetwork_tv_show_page_context' => 'usanetwork-catchall',
            ), 'setting');
            $block_of_items = _usanetwork_catchall_render_related_content_items_block($related_content);
            return theme('usanetwork_catchall_related_items_container', array(
              'related_items_block' => $block_of_items,
              'load_more_link' => TRUE,
              'show_nid' => $show->nid,
              'items_pre_page_limit' => USA_CATCHALL_RELATED_CONTENT_ITEMS,
            ));
          }
        }
      }
    }
  }
  return '';
}


/*
* Renders block of items (default number of items in the block is 6)
 */
function _usanetwork_catchall_render_related_content_items_block($data, $start_from = 0, $limit = 1) {
  if (!empty($data)) {

    $ad_id = intval($start_from / $limit);

    $theme_variables = array(
      'related_items' => array(),
      'ad' => $start_from == 0 ? FALSE : TRUE,
      'ad_id' => $ad_id,
    );

    foreach ($data as $data_index => $data_item) {
      if (!empty($data_item->ymal)) {
        $theme_variables['related_items'][] = usanetwork_tv_shows_render_related_content_item_ymal($data_item);
      }
      else {
        $theme_variables['related_items'][] = _usanetwork_catchall_render_related_content_item_default($data_item);
      }
    }

    return theme('usanetwork_catchall_related_items_block', $theme_variables);
  }

  return '';
}


/**
 * Renders default item.
 */
function _usanetwork_catchall_render_related_content_item_default($data) {
  $classes = array();
  $desktop_image = $mobile_image = '';
  $target_url = '<front>';

  if (!empty($data->entity_type) && !empty($data->entity_id) && in_array($data->entity_type, array(
      'file',
      'node'
    ))
  ) {
    $target_url = url($data->entity_type . '/' . $data->entity_id);
  }

  if (!empty($data->raw_image_uri)) {
    $desktop_image = image_style_url('921x488', $data->raw_image_uri);
    $mobile_image = image_style_url('591x330', $data->raw_image_uri);
  }

  if (!empty($data->sponsored)) {
    $content_id = '/' . $data->entity_type . '/' . $data->entity_id;
  }

  $theme_variables = array(
    'custom_classes' => implode(" ", $classes),
    'target_url' => $target_url,
    'caption' => !empty($data->promo_topic)
        ? htmlspecialchars($data->promo_topic)
        : '',
    'title' => !empty($data->promo_title)
        ? htmlspecialchars($data->promo_title)
        : $data->title,
    'additional' => !empty($data->promo_description)
        ? htmlspecialchars($data->promo_description)
        : '',
    'image_desktop' => $desktop_image,
    'image_mobile' => $mobile_image,
    'media_icon' => $data->media_icon,
    'content_id' => isset($content_id) ? $content_id : FALSE,
  );

  return theme('usanetwork_catchall_related_item', $theme_variables);
}

function usanetwork_catchall_get_related_content_ajax($tv_show_node, $start_from = 0, $limit = 1) {
  $response = array(
    'found' => FALSE,
    'total' => 0,
    'overlimited' => FALSE,
    'rendered' => '',
  );

  $related_content = _usanetwork_tv_shows_cache_get_limited_related_catchall_content($tv_show_node, $start_from, $limit);

  if (!empty($related_content)) {
    $last_entry = end($related_content);
    $items_last = _usanetwork_tv_shows_cache_get_number_of_catchall_last_items($tv_show_node, $last_entry->entity_type, $last_entry->entity_id);

    $response['found'] = TRUE;
    $response['total'] = count($related_content);
    $response['rendered'] = _usanetwork_catchall_render_related_content_items_block($related_content, $start_from, $limit);

    if ($items_last == 0 || $items_last <= $limit) {
      $response['overlimited'] = TRUE;
    }
    else {
      $response['overlimited'] = FALSE;
    }

    return drupal_json_output($response);
  }
  elseif (empty($related_content) && $start_from > 0) {
    $response['overlimited'] = TRUE;
  }

  return drupal_json_output($response);
}
