<?php
/**
 * @file
 * Code for the usanetwork_catchall feature.
 */

include_once 'usanetwork_catchall.features.inc';
define('USA_CATCHALL_RELATED_CONTENT_ITEMS', 6);

/**
 *  Implements hook_menu().
 */
function usanetwork_catchall_menu() {
  $items = array();
  $items['ajax/usanetwork-catchall/get-related/%node/%/%'] = array(
    'title' => 'Related content',
    'page callback' => 'usanetwork_catchall_get_related_content_ajax',
    'page arguments' => array(3, 4, 5),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}


/**
 * Implements hook_preprocess_HOOK().
 */
function usanetwork_catchall_preprocess_html(&$vars) {
  // Load node
  $node = menu_get_object();
  if ($node && $node->type == 'catchall_page') {
    $fixedwidth_field = field_get_items('node', $node, 'field_usa_catchall_fixedwidth');
    // add a body class if this checkbox has been selected
    if ($fixedwidth_field[0]['value'] == '1') {
      $vars['classes_array'][] = 'usa-fixed-width';
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function usanetwork_catchall_preprocess_page(&$vars) {
  // Load node, hide title on the frontend
  $node = menu_get_object();
  if ($node && $node->type == 'catchall_page') {
    $vars['title'] = '';

    //Settings for MPS reloadable Ad
    $field_automatic_refresh = _usanetwork_get_field_item('node', $node, 'field_automatic_refresh' ,'value');
    if ($field_automatic_refresh && $field_automatic_refresh == '1') {
      $field_refresh_time = _usanetwork_get_field_item('node', $node, 'field_refresh_time' ,'value');
      drupal_add_js(array('CatchallRefreshSettings' => array('time' => ($field_refresh_time) ? $field_refresh_time : '')), 'setting');
    }
  }
}

/*
 * Returns content for usanetwork_catchall_related_content_content block.
 */
function _usanetwork_catchall_related_content() {
  if (path_is_admin(current_path())) {
    return '';
  }

  $node = menu_get_object('node');
  if (!empty($node) && $node->type == 'catchall_page') {
    if (empty($node->field_tvs_show_latest_feed)) {
      return '';
    }
    else {
      $latest_content_flag_field = field_get_items('node', $node, 'field_tvs_show_latest_feed');

      if ($latest_content_flag_field[0]['value'] == 0) {
        return '';
      }
    }
    $show = field_get_items('node', $node, 'field_show');
    if (!empty($show)) {
      $show = is_array($show) ? reset($show) : $show;
      $show = node_load($show['target_id']);
      if (!empty($show)) {
        $you_may_also_like_item = usanetwork_tv_shows_consumptionator_get_ymal_item($show);
        $related_content = _usanetwork_tv_shows_cache_get_limited_related_catchall_content(
          $show, 0,
          !empty($you_may_also_like_item)
            ? USA_CATCHALL_RELATED_CONTENT_ITEMS - 1
            : USA_CATCHALL_RELATED_CONTENT_ITEMS
        );
        if (!empty($you_may_also_like_item)) {
          $related_content[] = $you_may_also_like_item;
        }
        if (!empty($related_content)) {
          if (!empty($related_content)) {
            drupal_add_js(drupal_get_path('module', 'usanetwork_tv_shows') . '/js/usanetwork_tv_shows_related_items_loader.js');
            drupal_add_js(array(
              'usanetwork_tv_show_nid' => $show->nid,
              'usanetwork_tv_show_page_context' => 'usanetwork-catchall',
            ), 'setting');
            $block_of_items = usanetwork_tv_shows_consumptionator_render_related_content_items_block($related_content);
            return theme('usanetwork_tv_shows_consumptionator_related_items_container', array(
              'related_items_block' => $block_of_items,
              'load_more_link' => TRUE,
              'show_nid' => $show->nid,
              'items_pre_page_limit' => USA_CATCHALL_RELATED_CONTENT_ITEMS,
            ));
          }
        }
      }
    }
  }
  return '';
}


function usanetwork_catchall_get_related_content_ajax($tv_show_node, $start_from = 0, $limit = 1) {
  $response = array(
    'found' => FALSE,
    'total' => 0,
    'overlimited' => TRUE,
    'rendered' => '',
  );
  $related_content = _usanetwork_tv_shows_cache_get_limited_related_catchall_content($tv_show_node, $start_from, $limit + 1);
  if (!empty($related_content)) {
    if (count($related_content) > $limit) {
      $response['overlimited'] = FALSE;
      $related_content = array_slice($related_content, 0, $limit);
    }
    $response['rendered'] = usanetwork_tv_shows_consumptionator_render_related_content_items_block($related_content, $start_from, $limit);
    $response['total'] = count($related_content);
    $response['found'] = TRUE;
  }
  return drupal_json_output($response);
}
