<?php

/**
 * @file
 * Code for the Post feature.
 */
include_once 'usanetwork_consumptionator_post.features.inc';
include_once 'usanetwork_consumptionator_post.field.inc';

define('USANETWORK_FIELD_BLOG', 'field_blog');


/**
 *  Implements hook_menu().
 */
function usanetwork_consumptionator_post_menu() {
  $items = array();
  $items['ajax/usanetwork-post/get-related/%node/%/%'] = array(
    'title' => 'Related content',
    'page callback' => '_usanetwork_consumptionator_post_get_related_content_ajax',
    'page arguments' => array(3, 4, 5),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_block_info().
 */
function usanetwork_consumptionator_post_block_info() {

  $blocks['usanetwork_cons_post_related'] = array(
    'info' => t('Blog Consumptionator: Related Content'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  $blocks['usanetwork_cons_post_main'] = array(
    'info' => t('Blog Consumptionator: Main Block'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function usanetwork_consumptionator_post_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'usanetwork_cons_post_related':
      $block['subject'] = t('Latest Posts');
      $block['content'] = _usanetwork_consumptionator_post_related_content_block();
      break;
    case 'usanetwork_cons_post_main':
      $block['subject'] = t('Latest Posts');
      $block['content'] = _usanetwork_consumptionator_post_main_block();
      break;
  }
  return $block;
}

/**
 * Renders Block entity of related content items.
 */
function _usanetwork_consumptionator_post_related_content_block() {
  if (path_is_admin(current_path())) {
    return '';
  }

  $content = menu_get_object('node');

  if (!empty($content)) {
    $show_field = field_get_items('node', $content, 'field_show');

    if (!empty($show_field)) {
      $tv_show_node = node_load($show_field[0]['target_id']);


      $you_may_also_like_item = usanetwork_tv_shows_consumptionator_get_ymal_item($tv_show_node);

      $related_content = _usanetwork_tv_shows_cache_get_limited_related_content(
        $tv_show_node, $content->type, 0,
        !empty($you_may_also_like_item)
          ? USA_QUIZ_RELATED_CONTENT_ITEMS - 1
          : USA_QUIZ_RELATED_CONTENT_ITEMS
      );

      if (!empty($you_may_also_like_item)) {
        $related_content[] = $you_may_also_like_item;
      }

      if (!empty($related_content)) {
        drupal_add_js(drupal_get_path('module', 'usanetwork_tv_shows') . '/js/usanetwork_tv_shows_related_items_loader.js');
        drupal_add_js(array(
          'usanetwork_tv_show_nid' => $tv_show_node->nid,
          'usanetwork_tv_show_page_context' => 'usanetwork-post',
          'usanetwork_tv_show_offset' => !empty($you_may_also_like_item) ? -1 : 0,
        ), 'setting');

        $block_of_items = usanetwork_tv_shows_consumptionator_render_related_content_items_block($related_content);

        return theme('usanetwork_tv_shows_consumptionator_related_items_container', array(
          'related_items_block' => $block_of_items,
          'load_more_link' => TRUE,
          'show_nid' => $tv_show_node->nid,
          'items_pre_page_limit' => USA_QUIZ_RELATED_CONTENT_ITEMS,
        ));
      }
    }
  }
}

function _usanetwork_consumptionator_post_get_related_content_ajax($tv_show_node, $start_from = 0, $limit = 1) {
  $response = array(
    'found' => FALSE,
    'total' => 0,
    'overlimited' => TRUE,
    'rendered' => '',
  );
  $related_content = _usanetwork_tv_shows_cache_get_limited_related_content($tv_show_node, 'post', $start_from, $limit + 1);
  if (!empty($related_content)) {
    if (count($related_content) > $limit) {
      $response['overlimited'] = FALSE;
      $related_content = array_slice($related_content, 0, $limit);
    }
    $response['rendered'] = usanetwork_tv_shows_consumptionator_render_related_content_items_block($related_content, $start_from, $limit);
    $response['total'] = count($related_content);
    $response['found'] = TRUE;
  }
  return drupal_json_output($response);
}

/**
 * Renders main block for quiz landing page.
 */
function _usanetwork_consumptionator_post_main_block() {

  $node = menu_get_object('node');
  if (isset($node->type) && $node->type == 'post') {
    if (isset($node->field_gigya_share_bar)) {
      $sharebar = field_view_field('node', $node, 'field_gigya_share_bar');
      $sharebar['#title'] = t('Share');
    }
    if (!empty($node->field_promo_created_ovts)) {
      $field_created_ovts = field_get_items('node', $node, 'field_promo_created_ovts');
      $field_created_ovts = reset($field_created_ovts);
      $creating_date = $field_created_ovts['value'];
    }
    elseif(!empty($node->created)) {
      $creating_date = $node->created;
    }
    if (!empty($node->body)) {
      $field_body = field_get_items('node', $node, 'body');
      $field_body = reset($field_body);
      $body = $field_body['value'];
    }
    if (!empty($node->field_blog)) {
      $field_blog = field_get_items('node', $node, 'field_blog');
      $field_blog = reset($field_blog);
      $blog_tid = $field_blog['tid'];
    }
    $theme_variables = array(
      'title' => !empty($node->title) ? $node->title : '',
      'sharebar' => !empty($sharebar) ? render($sharebar) : '',
      'creating_date' => !empty($creating_date) ? date('F j, Y', $creating_date) : '',
      'body' => !empty($body) ? $body : '',
      'rendered_carousel' => !empty($blog_tid) ? _usanetwork_consumptionator_post_posts_carousel($blog_tid, $node->nid) : '',
    );
    return theme('usanetwork_quiz_main_block', $theme_variables);
  }
  return '';
}

/*
 * Renders posts carousel for blog.
*/
function _usanetwork_consumptionator_post_posts_carousel($blog_id, $post_id = NULL) {

  $node = menu_get_object('node');
  if (is_numeric($blog_id)) {
   // $q
    $node_wrapper = entity_metadata_wrapper('node', $node);
    $show_id = $node_wrapper->field_show->nid->value();
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node')
      ->entityCondition('bundle', 'quiz')
      ->fieldCondition('field_show', 'target_id', $show_id, '=');
    $explore_tag = !empty($node->field_explore_tag) ? $node_wrapper->field_explore_tag->value() : NULL;
    if (!empty($explore_tag)) {
      $query->fieldCondition('field_explore_tag', 'tid', $explore_tag->tid, '=');
    }
    $result = $query->execute();
    if (isset($result['node'])) {
      $quizes = entity_load('node', array_keys($result['node']));
      $rendered_items = array();
      foreach ($quizes as $quiz) {
        if (!empty($quiz->field_promo_image_override)) {
          $image = field_get_items('node', $quiz, 'field_promo_image_override');
          $image = reset($image);
        }
        $episode_variables = array(
          'title' => !empty($quiz->title) ? $quiz->title : '',
          'url' => url('node/' . $quiz->nid),
          'active' => ($node->nid == $quiz->nid) ? TRUE : FALSE,
          'icon_type' => usanetwork_core_api_get_media_icon('node', $quiz->nid),
        );
        $episode_variables['image'] = !empty($image['uri']) ? image_style_url('full_episodes_633x356', $image['uri']) : '';
        $episode_variables['image_mobile'] = !empty($image['uri']) ? image_style_url('111x74', $image['uri']) : '';
        $rendered_items['horizontal'][] = theme('usanetwork_quiz_quizes_carousel_item_h', $episode_variables);
        $episode_variables['image'] = !empty($image['uri']) ? image_style_url('111x74', $image['uri']) : '';
        $rendered_items['vertical'][] = theme('usanetwork_quiz_quizes_carousel_item_v', $episode_variables);
      }
      $advert_block = module_invoke('mps', 'block_view', 'topbox');
      if (!empty($advert_block['content'])) {
        $advert = render($advert_block['content']);
      }
      $theme_variables = array(
        'quizes' => !empty($rendered_items) ? $rendered_items : array(),
        'advert_block' => isset($advert) ? $advert : NULL,
        'block_title' => !empty($explore_tag) ? $explore_tag->name : t('All quizes'),
      );
      return theme('usanetwork_quiz_quizes_carousel', $theme_variables);
    }
  }
  return '';
}
