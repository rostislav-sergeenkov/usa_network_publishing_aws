<?php
/**
 * @file
 */

/*
 * Implements hook_theme().
 */
function usanetwork_custom_metatags_form_alter(&$form, &$form_state, $form_id) {
  if (in_array($form_id, array('tv_show_node_form', 'catchall_page_node_form', 'usa_homepage_node_form'))) {
    if (isset($form['#bundle']) && $form_id == $form['#bundle'] . '_node_form') {
      $entity = isset($form_state['node']) ? $form_state['node'] : FALSE;
      $entity_type = 'node';
    } else {
      return;
    }
    if (!$entity) {
      return;
    }

    list($entity_id, ,$bundle) = entity_extract_ids($entity_type, $entity);
    $form_state['entity'] = $entity;
    $form_state['entity_type'] = $entity_type;
    $form_state['entity_id'] = $entity_id;
    $form_state['bundle'] = $bundle;
    $defaults = _usanetwork_custom_metatags_entity_settings($entity, $entity_type);

    $form['metatags']['usanetwork_tags'] = array( 
        '#tree' => true,
        '#type' => 'fieldset',
        '#title' => t('Custom'),
        '#weight' => 150,
        '#access' => user_access('edit meta tags'),
        '#collapsible' => true,
        '#collapsed' => true,

    );

    $id = drupal_html_id('usanetwork-metatags-' . $bundle . '-' . $entity_id);

    $items_count = isset($form_state['metatags']['usanetwork_tags']['items_count']) ? $form_state['metatags']['usanetwork_tags']['items_count'] : count($defaults);
    _usanetwork_custom_metatags_metatags_elements($id, $form['metatags']['usanetwork_tags'], $defaults, $items_count);
    $form_state['metatags']['usanetwork_tags']['items_count'] = $items_count;
    $form['metatags']['usanetwork_tags']['tags']['#attributes']['id'] = $id;

    $form['#submit'][] = 'usanetwork_custom_metatags_form_entity_form_submit';
    if (!empty($form['actions']['submit']['#submit'])) {
      $form['actions']['submit']['#submit'][] = 'usanetwork_custom_metatags_form_entity_form_submit';
    }
  }
}

/**
 * Returns tags form elements
 */
function _usanetwork_custom_metatags_metatags_elements($id, &$parent, $defaults = array(), $items_count = null) {
  
  $parent['tags'] = array(
    '#type' => 'container',
  );

  if (isset($items_count)) {
    for ($delta = 0; $delta < $items_count; $delta++) {
      $parent['tags'][$delta] = _usanetwork_custom_metatags_meta_tags_elements(isset($defaults[$delta]) ? $defaults[$delta] : array());
    }
  }
  else {
    foreach ($defaults['tags'] as $delta => $values) {
      $parent['tags'][$delta] = _usanetwork_custom_metatags_meta_tags_elements($values);
    }
  }

  // Add the "Add more" button.
  $parent['tags']['add_more'] = array(
    '#type' => 'submit',
    '#value' => t('Add Meta Tag'),
    '#submit' => array('usanetwork_custom_metatags_add_metatag_submit'),
    '#ajax' => array(
      'callback' => 'usanetwork_custom_metatags_add_metatag_ajax_submit',
      'wrapper' => $id,
      'effect' => 'fade',
    ),
  );
}

/**
 * Return tag element.
 */
function _usanetwork_custom_metatags_meta_tags_elements($defaults = array()) {
  $form = array(
    '#type' => 'fieldset',
    '#tree' => TRUE,
  );;
  $form['usa_metatag_name'] = array(
    '#type' => 'textfield',
    '#title' => t('Meta Tag Name'),
    '#default_value' => $defaults['usa_metatag_name'],
  );
  $form['usa_metatag_value'] = array(
    '#type' => 'textfield',
    '#title' => t('Meta Tag Value'),
    '#default_value' => $defaults['usa_metatag_value'],
  );

  return $form;
}

/**
 * Returns entity specific settings.
 */
function _usanetwork_custom_metatags_entity_settings($entity, $entity_type) {
  $settings = variable_get('usanetwork_meta_tags_settings', array());
  list($entity_id, , $bundle) = entity_extract_ids($entity_type, $entity);
  $entity_settings = isset($settings[$entity_type][$bundle][$entity_id]) ? $settings[$entity_type][$bundle][$entity_id] : array();

  return $entity_settings;
}

/**
 * Ajax callback for add meta tags
 */
function usanetwork_custom_metatags_add_metatag_ajax_submit(&$form, &$form_state) {
  $button = $form_state['triggering_element'];

  // Go one level up in the form, to the widgets container.
  $element = drupal_array_get_nested_value($form, array_slice($button['#array_parents'], 0, -1));
  return $element;
  
}

/**
 * Submit callback for add mata tag
 */
function usanetwork_custom_metatags_add_metatag_submit($form, &$form_state) {
  $button = $form_state['triggering_element'];

  // Increment the items count.
  $form_state['metatags']['usanetwork_tags']['items_count']++;

  $form_state['rebuild'] = TRUE;
}

/**
 * Entity save submit callback
 * Saves meta tags settings
 */
function usanetwork_custom_metatags_form_entity_form_submit($form, &$form_state) {
  if (!isset($form_state['input']['metatags']['usanetwork_tags']) || !isset($form_state['entity'])) {
    return;
  }

  $entity = $form_state['entity'];
  $entity_type = $form_state['entity_type'];
  if (!empty($form_state['entity_id'])) {
    $entity_id = $form_state['entity_id'];
  } else {
    list($entity_id,,) = entity_extract_ids($entity_type, $entity);
  }
  if (empty($entity_id)) {
    return;
  }
  $bundle = $form_state['bundle'];

  $settings = variable_get('usanetwork_meta_tags_settings', array());
  $entity_settings = $form_state['input']['metatags']['usanetwork_tags']['tags'];

  // remove empty tags
  $variables = array();
  if (isset($entity_settings) && is_array($entity_settings)) {
    foreach ($entity_settings as $item) {
      if (!empty($item['usa_metatag_name'])) {
        $variables[] = $item;
      }
    }
  }
  $entity_settings = $variables;

  $settings[$entity_type][$bundle][$entity_id] = $entity_settings;
  variable_set('usanetwork_meta_tags_settings', $settings);
}

/**
 * Process meta tags for nodes.
 */
function usanetwork_custom_metatags_preprocess_page(&$variables) {
  
  if (isset($variables['node'])) {
    $node = $variables['node'];
    if (in_array($node->type, array('tv_show', 'catchall_page'))) {
      $settings = variable_get('usanetwork_meta_tags_settings', array()); 
      if ($settings['node'][$node->type][$node->nid]) {
        $weight = 50;
        foreach ($settings['node'][$node->type][$node->nid] as $key => $value) {
          $custom_tag = array(
            '#type' => 'html_tag',
            '#tag' => 'meta',
            '#attributes' => array(
              'name' => $value['usa_metatag_name'],
              'content' => $value['usa_metatag_value'],
            ),
            '#weight' => $weight,
          );
          drupal_add_html_head($custom_tag, "usanetwork_{$value['usa_metatag_name']}");
          $weight++;
        }
      }
    }
  }
}

/**
 * Process meta tags for nodes.
 */
function usanetwork_custom_metatags_preprocess_node(&$variables) {
  if (isset($variables['node'])) {
    $node = $variables['node'];
    if ($node->type == 'usa_homepage') {
      $settings = variable_get('usanetwork_meta_tags_settings', array()); 
      if ($settings['node'][$node->type][$node->nid]) {
        $weight = 50;
        foreach ($settings['node'][$node->type][$node->nid] as $key => $value) {
          $custom_tag = array(
            '#type' => 'html_tag',
            '#tag' => 'meta',
            '#attributes' => array(
              'name' => $value['usa_metatag_name'],
              'content' => $value['usa_metatag_value'],
            ),
            '#weight' => $weight,
          );
          drupal_add_html_head($custom_tag, "usanetwork_{$value['usa_metatag_name']}");
          $weight++;
        }
      }
    }
  }
}
