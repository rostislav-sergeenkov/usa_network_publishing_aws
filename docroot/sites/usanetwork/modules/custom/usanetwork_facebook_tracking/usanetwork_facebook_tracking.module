<?php
/**
 * @file
 * Drupal needs this blank file.
 */


define('USANETWORK_FACEBOOK_TRACKING_ENABLED', 'field_facebook_tracking_enabled');
define('USANETWORK_FACEBOOK_TRACKING_ID', '702197316510882');

/**
* Implements hook_preprocess_html()
*/
function usanetwork_facebook_tracking_page_build(&$page) {
  if (drupal_is_front_page()) {
    $homepage = usanetwork_home_get_homepage(array('usa_homepage'));
    if ($homepage) {
      $entity = usanetwork_home_get_homepage_node($homepage);
      $entity_type = 'node';
    }
  }
  elseif ($entity = menu_get_object('node')) {
    $entity_type = 'node';
  }
  elseif ($entity = menu_get_object('file')) {
    $entity_type = 'file';
  }
  if (!empty($entity) && !empty($entity_type)) {
    if (_usanetwork_facebook_tracking_enabled($entity, $entity_type)) {
      drupal_add_js(drupal_get_path('module', 'usanetwork_facebook_tracking') . '/js/usanetwork_facebook_tracking.js');
      drupal_add_js(array(
        'usanetwork_facebook_tracking' => array(
          'id' => USANETWORK_FACEBOOK_TRACKING_ID,
        ),
      ), 'setting');
      $page['footer']['usanetwork_facebook_tracking'] = array(
        '#markup' => usanetwork_facebook_tracking_html(),
      );
    }
  }
}

/**
 * Checks if tracking is enabled for entity.
 */
function _usanetwork_facebook_tracking_enabled($entity, $entity_type) {
  if (!empty($entity->{USANETWORK_FACEBOOK_TRACKING_ENABLED})) {
    $field_items = field_get_items($entity_type, $entity, USANETWORK_FACEBOOK_TRACKING_ENABLED);

    if (!empty($field_items)) {
      $enabled = reset($field_items);

      if ($enabled['value']) {
        return true;
      }
    }
  }
  return false;
}

/**
 * Returns HTML script tag for tracking facebook.
 */
function usanetwork_facebook_tracking_html() {
  return  '<noscript><img height="1" width="1" border="0" alt="" style="display:none" src="https://www.facebook.com/tr?id=' . USANETWORK_FACEBOOK_TRACKING_ID . '&amp;ev=NoScript" /></noscript>';
}
