<?php
/**
 * @file
 * Code for the usanetwork_home feature.
 */

define('USANETWORK_HOME_PRIMETIME_START_HOUR', 20);
define('USANETWORK_HOME_PRIMETIME_END_HOUR', 23);
define('USANETWORK_HOME_PRIMETIME_ITEMS_LENGTH', 4);

include_once 'usanetwork_home.features.inc';

/**
 * Implements hook_menu().
 */
function usanetwork_home_menu() {
  $items = array();

  $items['home'] = array(
    'title' => 'USA Network',
    'page callback' => 'usanetwork_home_landing',
    'access arguments' => array('access content'),
  );
  $items['home/home_admin/%'] = array(
    'title' => 'USA Network',
    'page callback' => 'usanetwork_home_admin_landing',
    'access arguments' => array('administer content'),
    'page arguments' => array(2),
  );
  //@ todo: write better fallbacks for the ajax
  // ajax for global nav more
  $items['globalnav_more'] = array(
    'page callback' => 'usanetwork_home_globalnav_more_ajax',
    'access callback' => 'user_access',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  // ajax for global nav shows
  $items['globalnav_shows'] = array(
    'page callback' => 'usanetwork_home_globalnav_shows_ajax',
    'access callback' => 'user_access',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  // Ajax for getting running now or next show. Pass user timezone string value
  // as the first parameter. Divide it by '-' character. For example: "Europe-Minsk".
  // Next parameter is running show order ('now', 'next', or 'now,next'.
  $items['ajax/get-running-show/%/%'] = array(
    'title' => 'Running show',
    'page callback' => 'usanetwork_home_get_running_show_ajax',
    'page arguments' => array(2, 3),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_block_info().
 */
function usanetwork_home_block_info() {
  $blocks = array();

  $blocks['usanetwork_home_promo_carousel'] = array(
    'info' => t('Homepage: Promo Carousel'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  $blocks['usanetwork_home_sm_featured'] = array(
    'info' => t('Homepage: Show Menu, featured items'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  $blocks['usanetwork_home_sm_primetime'] = array(
    'info' => t('Homepage: Show Menu, primetime tonight'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  $blocks['usanetwork_home_sm_upcoming'] = array(
    'info' => t('Homepage: Show Menu, upcoming show episodes'),
    'cache' => DRUPAL_NO_CACHE,
  );

  $blocks['usanetwork_show_menu'] = array(
    'info' => t('Usanetwork Show Menu'),
    'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function usanetwork_home_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'usanetwork_home_promo_carousel':
      $block['subject'] = '';
      $block['content'] = _usanetwork_home_promo_carousel();
      break;

    case 'usanetwork_home_sm_featured':
      $block['subject'] = t('Featured');
      $block['content'] = _usanetwork_home_show_menu_featured_block();
      break;

    case 'usanetwork_home_sm_primetime':
      $block['subject'] = t('Primetime tonight');
      $block['content'] = _usanetwork_home_show_menu_primetime_block();
      break;

    case 'usanetwork_home_sm_upcoming':
      $block['subject'] = t('Upcoming show episodes');
      $block['content'] = _usanetwork_home_show_menu_upcoming_episodes();
      break;

    case 'usanetwork_show_menu':
      $block['subject'] = t('Show menu');
      $block['content'] = _usanetwork_home_render_show_menu();
      break;
  }
  return $block;
}

/**
 * Implements hook_theme().
 */
function usanetwork_home_theme() {
  return array(
    'usanetwork_home_smnav_img_show' => array(
      'variables' => array(
        'title' => NULL,
        'image' => NULL,
        'cta_text' => NULL,
      ),
      'template' => 'templates/usanetwork-home-smnav-img-show',
    ),
    'usanetwork_home_smnav_img_show_container' => array(
      'variables' => array(
        'elements' => NULL
      ),
      'template' => 'templates/usanetwork-home-smnav-img-show-container',
    ),
    'usanetwork_home_smnav_primetime_item' => array(
      'variables' => array(
        'time' => NULL,
        'show_title' => NULL,
        'show_episode' => NULL,
        'data' => NULL,
      ),
      'template' => 'templates/usanetwork-home-smnav-primetime-item',
    ),
    'usanetwork_home_smnav_primetime_container' => array(
      'variables' => array(
        'elements' => NULL,
      ),
      'template' => 'templates/usanetwork-home-smnav-primetime-container',
    ),
    'usanetwork_home_smnav_upcoming_element' => array(
      'variables' => array(
        'image_url' => NULL,
        'image' => NULL,
        'show_name' => NULL,
        'episode_title' => NULL,
        'episode_day' => NULL,
        'episode_time' => NULL,
        'episode_interval' => NULL,
        'episode_description' => NULL,
      ),
      'template' => 'templates/usanetwork-home-smnav-upcoming-element',
    ),
    'usanetwork_home_smnav_upcoming_element_container' => array(
      'variables' => array(
        'elements' => NULL,
      ),
      'template' => 'templates/usanetwork-home-smnav-upcoming-element-container',
    )
  );
}

function _usanetwork_home_promo_carousel() {
  $content = array();
  
  $homepage = usanetwork_home_get_homepage(array('usa_homepage'));
  
  if ($homepage) {
    $nid = reset(array_keys($homepage['node']));
    $homepage_node = node_load($nid);
    $display_carousel = reset(field_get_items('node', $homepage_node, 'field_hp_promo_carousel_display'));
    if ($display_carousel['value'] == 1) {
      $db_select = db_select('node', 'n')
        ->fields('n', array('nid', 'title'));
      $db_select->condition('n.status', '1');
      $db_select->condition('n.type', 'usanetwork_promo');
      $db_select->leftJoin('field_data_field_hp_promo_carousel', 'fdfhpc', 'n.nid=fdfhpc.field_hp_promo_carousel_target_id');
      $db_select->condition('fdfhpc.entity_id', $nid);
      $db_select->orderBy('fdfhpc.delta');

      $db_result = $db_select->execute()->fetchAll();
      if ($db_result) {
        $promo_carousel = '';
        foreach ($db_result as $promo){
          $promo_carousel .= '<li class="carousel-item">' . drupal_render(node_view(node_load($promo->nid), 'carousel_promo')) . '</li>';
        }

        $promo_carousel = '<div class="carousel clearfix"><div class="carousel-viewport"><div class="home-carousel"><ul>'.$promo_carousel.'</ul></div></div></div>';

        $content['promo_carousel'] = array(
          '#markup' => $promo_carousel,
        );
      }
    }
  }
  return $content;
}

/**
 * Implements hook_preprocess_block().
 */
function usanetwork_home_preprocess_block(&$variables) {
  $block = $variables['block'];
  if ($block->bid == 'views-usa_video-front_full_episodes'
     || $block->bid == 'views-usa_mpx_video-front_full_epsds' 
     || $block->bid == 'usanetwork_home-usanetwork_home_promo_carousel') {
    $homepage = usanetwork_home_get_homepage(array('usa_homepage'));
    //carousel-promo

    if (!empty($homepage)) {
      $nid = reset(array_keys($homepage['node']));
      if ($nid && $homepage = node_load($nid)) {
        if ($block->bid == 'usanetwork_home-usanetwork_home_promo_carousel') {
          if (!empty($homepage->field_hp_promo_carousel_title)) {
            $title = reset(field_get_items('node', $homepage, 'field_hp_promo_carousel_title'));
            $block->subject = $title['safe_value'];
          } 
        } else {
          drupal_add_js(drupal_get_path('theme', 'aurora_usa') . '/javascripts/viewportchecker.js', 'file');
          if (!empty($homepage->field_hp_episodes_block_title)) {
            $title = reset(field_get_items('node', $homepage, 'field_hp_episodes_block_title'));
            $block->subject = $title['safe_value'];
          }
        }
      }
    }
  }
}

/**
 * Implements hook_preprocess_node().
 */
function usanetwork_home_preprocess_node(&$variables) {
  $node = $variables['node'];
  if ($node->type == 'usa_homepage') {
    if (!empty($node->field_hp_promos_block_title)) {
      $title = reset(field_get_items('node', $node, 'field_hp_promos_block_title'));
      $variables['featured_title'] = $title['safe_value'];
    }
  }
}

/**
 * Implements hook_image_default_styles().
 */
function usanetwork_home_image_default_styles() {
  $styles = array();

  $styles['episode_preview_temp'] = array(
    'effects' => array(
      array(
        'name' => 'image_scale_and_crop',
        'data' => array(
          'width' => 143,
          'height' => 81,
        ),
        'weight' => 0,
      ),
    ),
  );

  return $styles;
}

/**
 * Callback for the USA homepage
 */
function usanetwork_home_landing($day = NULL) {
  $render = array();
  $homepage = usanetwork_home_get_homepage(array('usa_homepage'), $day);

  // return the nodes as full
  if (!empty($homepage['node'])) {

    $render['homepage']['#prefix'] = '<div class="homepage-content">';
    $render['homepage']['#suffix'] = '</div>';
    $render['homepage']['inner'] = node_view_multiple(node_load_multiple(array_keys($homepage['node'])), 'full');

  }
  else {
    $render['status']['#markup'] = t('No Homepage content available.');
  }
  return $render;
}

/**
 * Callback for the USA homepage - admin preview pages
 */
function usanetwork_home_admin_landing($day = NULL) {
  $render = array();
  if (arg(2)) {
    $day = strtolower(arg(2));
  }

  $homepage = usanetwork_home_get_homepage(array('usa_homepage'), $day);

  // return the nodes as teasers
  // @todo - load fields or make a view mode for this
  if (!empty($homepage['node'])) {

    $render['homepage']['#prefix'] = '<div class="homepage-content">';
    $render['homepage']['#suffix'] = '</div>';
    $render['homepage']['inner'] = node_view_multiple(node_load_multiple(array_keys($homepage['node'])), 'full');

  }
  else {
    $render['status']['#markup'] = t('No Homepage content added for @day.', array('@day' => $day));
  }
  return $render;
}

/**
 * To fetch homepage node by title
 */
function usanetwork_home_get_homepage($types = array(), $day = NULL) {
//@TODO: remove $types
  if ($day === NULL) {
    $day = _usanetwork_home_get_day();
  }

  $query = db_select('node', 'n');
  $query->join('field_data_field_usa_hp_daylist', 'fd', 'fd.entity_id=n.nid');
  $query->fields('n', array('nid', 'vid', 'type'));
  $query->condition('fd.field_usa_hp_daylist_value', $day);

  $result = $query->execute()->fetchAllAssoc('nid');

  // Wrap result for maximal compatibility with old features
  if (!empty($result)) {
    return array(
      'node' => $result,
    );
  }

  return array();
}

/**
 * Implements hook_node_validate().
 */
function usanetwork_home_node_validate($node, $form, &$form_state) {
  if ($node->type == 'usa_homepage') {
    $nodeid = '';
    $home_day = '';
    $this_home_day = field_get_items('node', $node, 'field_usa_hp_daylist');
    if (!empty($node->nid)) {
      //editing content
      $nodeid = $node->nid;
    }
    if (!empty($this_home_day['0']['value'])) {
      $home_day = $this_home_day['0']['value'];
    }
    $query = db_select('field_data_field_usa_hp_daylist', 'day', array('target' => 'slave'));
    $query->leftjoin('node', 'n', 'n.nid = day.entity_id AND n.type = \'usa_homepage\'');
    $query->fields('day', array('field_usa_hp_daylist_value'));
    $query->condition('day.bundle', 'usa_homepage', '=');
    $query->condition('day.field_usa_hp_daylist_value', $home_day, '=');
    //check for all other homepage nodes(on editing content) excluding the current content
    $query->condition('day.entity_id', $nodeid, '<>');
    //check for showing only published contents
    $query->condition('n.status', '1', '=');

    $num_of_results = $query->execute()->rowCount();
    if($num_of_results != 0) {
      form_set_error('', t('There is already a published homepage present for ' . ucfirst($home_day)));
    }
  }
}

/**
 * Implements hook_form_FORD_ID_alter().
 */
function usanetwork_home_form_usa_homepage_node_form_alter(&$form, &$form_state) {

  $form['field_hp_promo_carousel_title']['#states'] = array(
    'visible' => array(
      ':input[name="field_hp_promo_carousel_display[und]"]' => array('checked' => true)
      )
    );

  $form['field_hp_promo_carousel']['#states'] = array(
    'visible' => array(
      ':input[name="field_hp_promo_carousel_display[und]"]' => array('checked' => true)
      )
    );

  $seo_page_title_language = $form['field_seo_page_title']['#language'];
  if (!isset($form['field_seo_page_title'][$seo_page_title_language][0]['value']['#default_value']) || 
    empty($form['field_seo_page_title'][$seo_page_title_language][0]['value']['#default_value'])) {
    $form['field_seo_page_title'][$seo_page_title_language][0]['value']['#default_value'] = variable_get('site_name', '');
  }
}

/**
 * Implements hook_form_FORD_ID_alter().
 */
function usanetwork_home_form_usanetwork_settings_form_alter(&$form, &$form_state) {
  $form['home'] = array(
    '#type' => 'fieldset',
    '#title' => t('Homepages'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
    '#tree' => TRUE,
  );

  $publish_time = variable_get('usanetwork_home_publish_time', '6:00 AM');
  if (preg_match('|(\d{1,2})\:(\d{2}) ([AMP]{2})|Uis', $publish_time, $matches)) {
    $hour = (int) $matches[1];
    $minute = (int) $matches[2];
    $part = $matches[3];
  }
  else {
    $hour = 6;
    $minute = 0;
    $part = 'AM';
  }
  $form['home']['publish'] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array(
        'container-inline'
      ),
    ),
  );
  $form['home']['publish']['usanetwork_home_publish_time'] = array(
    '#type' => 'select',
    '#title' => t('Publish time'),
    '#default_value' => $hour,
    '#options' => array_slice(range(0, 12, 1), 1, NULL, TRUE),
    '#element_validate' => array('_usanetwork_home_publish_validate'),
    '#tree' => FALSE,
  );
  $minutes = range(0, 59, 1);
  for ($i = 0; $i < 10; $i++) {
    $minutes[$i] = '0'.$minutes[$i];
  }
  $form['home']['publish']['minute'] = array(
    '#type' => 'select',
    '#title' => ':',
    '#default_value' => $minute,
    '#options' => $minutes,
  );
  $form['home']['publish']['part'] = array(
    '#type' => 'select',
    '#title' => '',
    '#default_value' => $part,
    '#options' => array(
      'AM' => 'AM',
      'PM' => 'PM',
    ),
  );
}

/**
 * Validate callback for publish time.
 */
function _usanetwork_home_publish_validate($element, &$form_state, $form) {
  $values =& $form_state['values'];
  $publish = $values['usanetwork_home_publish_time'] . ':';
  if ($values['home']['publish']['minute'] < 10) {
    $publish .= '0';
  }
  $publish .= $values['home']['publish']['minute'] . ' ' . $values['home']['publish']['part'];
  unset($values['home']['publish']);
  form_set_value($element, $publish, $form_state);
}

/**
 * Block callback for the globalnav shows block
 * rip of home landing
 */
function usanetwork_home_globalnav_shows_block() {
  $render = array();
  $homepage = usanetwork_home_get_homepage(array('usa_homepage'));

  // return the nodes as global_nav_block_shows
  if (!empty($homepage['node'])) {
    $render['globalnav_shows']['#prefix'] = '<div class="globalnav-shows">shows';
    $render['globalnav_shows']['#suffix'] = '</div>';
    $render['globalnav_shows']['inner'] = node_view_multiple(node_load_multiple(array_keys($homepage['node'])), 'global_nav_block_shows');
  }
  else {
    return;
  }
  return $render;
}

/**
 * Block callback for the globalnav shows block
 */
function usanetwork_home_globalnav_more_block() {
  $render = array();
  $homepage = usanetwork_home_get_homepage(array('usa_homepage'));

  // return the nodes as global_nav_block_more
  if (!empty($homepage['node'])) {
    $render['globalnav_shows']['#prefix'] = '<div class="globalnav-more">more';
    $render['globalnav_shows']['#suffix'] = '</div>';
    $render['globalnav_shows']['inner'] = node_view_multiple(node_load_multiple(array_keys($homepage['node'])), 'global_nav_block_more');
  }
  else {
    return;
  }
  return $render;
}

/**
 * Retrieve more thingie and place them in the drawer
 *
 * @param string $ajax
 *   Ajax or nojs.
 *
 * @return array
 *   Return an array of ajax commands.
 */
function usanetwork_home_globalnav_more_ajax($type = 'ajax') {
  drupal_add_library('system', 'drupal.ajax');
  $homepage = usanetwork_home_get_homepage(array('usa_homepage'));

  $data = array();
  if (!empty($homepage['node'])) {
    $data['globalnav_more'] = render(node_view_multiple(node_load_multiple(array_keys($homepage['node'])), 'global_nav_block_more'));
  }

  if ($type == 'ajax') {
    $commands = array();
    $content = '<div class="globalnav-content-more" id="globalnav-more-replaced">' . $data['globalnav_more'] . '</div>';
    // Replace empty div with content.
    $commands[] = ajax_command_replace('#globalnav-more', $content);

    $page = array(
      '#type' => 'ajax',
      '#commands' => $commands,
    );
    ajax_deliver($page);
  }
  else {
    return '';
  }
}

/**
 * Retrieve more thingie and place them in the drawer
 *
 * @param string $ajax
 *   Ajax or nojs.
 *
 * @return array
 *   Return an array of ajax commands.
 */
function usanetwork_home_globalnav_shows_ajax($type = 'ajax') {
  drupal_add_library('system', 'drupal.ajax');
  $homepage = usanetwork_home_get_homepage(array('usa_homepage'));

  $data = array();
  if (!empty($homepage['node'])) {
    $data['globalnav_shows'] = render(node_view_multiple(node_load_multiple(array_keys($homepage['node'])), 'global_nav_block_shows'));
  }

  if ($type == 'ajax') {
    $commands = array();

    $content = '<div class="globalnav-content-shows" id="globalnav-shows-replaced">' . $data['globalnav_shows'] . '</div>';
    // Replace empty div with content.
    $commands[] = ajax_command_replace('#globalnav-shows', $content);

    $page = array(
      '#type' => 'ajax',
      '#commands' => $commands,
    );
    ajax_deliver($page);
  }
  else {
    return '';
  }
}

/**
 * Retrieve more thingie and place them in the syndicate drawer
 */
function usanetwork_home_globalnav_shows_banner() {
  $homepage = usanetwork_home_get_homepage(array('usa_homepage'));

  $data = array();
  if (!empty($homepage['node'])) {
    $data['globalnav_shows'] = render(node_view_multiple(node_load_multiple(array_keys($homepage['node'])), 'global_nav_block_shows'));
  }
  
  $content = '<div class="globalnav-content-shows globalnav-content-replaced" id="globalnav-shows-replaced">' . $data['globalnav_shows'] . '</div>';

  return $content;
 
}


/**
 * Retrieve more thingie and place them in the syndicate drawer
 */
function usanetwork_home_globalnav_more_banner() {
  $homepage = usanetwork_home_get_homepage(array('usa_homepage'));

  $data = array();
  if (!empty($homepage['node'])) {
    $data['globalnav_more'] = render(node_view_multiple(node_load_multiple(array_keys($homepage['node'])), 'global_nav_block_more'));
  }

  $content = '<div class="globalnav-content-more globalnav-content-replaced" id="globalnav-more-replaced">' . $data['globalnav_more'] . '</div>';

  return $content;

}

/**
 * Returns current day according to publish time.
 */
function _usanetwork_home_get_day() {
  $publish = strtotime(variable_get('usanetwork_home_publish_time', '6:00 AM'));
  if ($publish <= REQUEST_TIME) {
    $day = strtolower(date('l'));
  }
  else {
    $day = strtolower(date('l', strtotime('yesterday')));
  }

  return $day;
}

/**
 * Render a field value
 */
function _usanetwork_home_get_field_value($field) {
  $homepage = usanetwork_home_get_homepage(array('usa_homepage'), $day);

  if (!empty($homepage['node'])) {
    $nid = reset(array_keys($homepage['node']));
    $node_obj = node_load($nid);
    $field_datas = field_get_items('node', $node_obj, $field);
    if (is_array($field_datas)) {
      $field_data = reset($field_datas);
      return check_plain($field_data['value']);
    }
  }
  return '';
}

/**
  * Implements hook_preprocess_html()
  * custom titles for home pages
  */
function usanetwork_home_preprocess_html(&$vars) {
  if (drupal_is_front_page()) {
    $head_title = _usanetwork_home_get_field_value('field_seo_page_title');
    if ($head_title != '')
    $vars['head_title'] = $head_title;
  }  
}

/**
 * Renders featured content block.
 * The callback is only FOR TESTING and POC!
 */
function _usanetwork_home_show_menu_featured_block() {
  $output = array();
  $homepage = usanetwork_home_get_homepage(array('usa_homepage'));

  if (!empty($homepage['node'])) {
    $node_data = reset($homepage['node']);
    $node = node_load($node_data->nid);

    $field_hp_nav_img_shows = field_get_items('node', $node, 'field_hp_nav_img_shows');

    if (!empty($field_hp_nav_img_shows)) {
      foreach ($field_hp_nav_img_shows as $field_reference) {
        $reference_node = node_load($field_reference['target_id']);

        if ($reference_node) {
          $image_url = NULL;
          $image_field = field_get_items('node', $reference_node, 'field_gobal_nav_image');

          $cta_text = NULL;
          $cta_field = field_get_items('node', $reference_node, 'field_global_nav_cta_text');

          if (!empty($image_field)) {
            $image_field = reset($image_field);
            $image_url = file_create_url($image_field['uri']);
          }

          if (!empty($cta_field)) {
            $cta_field = reset($cta_field);
            $cta_text = $cta_field['value'];
          }

          $output[] = theme('usanetwork_home_smnav_img_show', array(
            'title' => $reference_node->title,
            'image' => $image_url,
            'cta_text' => $cta_text,
          ));
        }
      }
    }
  }

  if (!empty($output)) {
    return theme('usanetwork_home_smnav_img_show_container', array('elements' => $output));
  }

  return '';
}

/**
 * Implamants callback for ajax/get-running-show/%.
 *
 * @param string $user_timezone - Pass user timezone string value as parameter.
 * Divide it by '-' character. For example: "Europe-Minsk".
 *
 * @param string $periods - Pass string for getting show by period of time.
 * You can pass 'now', 'next' or 'now,next'
 */
function usanetwork_home_get_running_show_ajax($user_timezone, $periods = 'now,next') {
  $user_timezone_correlation = _usanetwork_home_get_user_timezome_correlation($user_timezone);
  $data = array(
    'timezone_correlation' => $user_timezone_correlation,
  );

  // Remove whitespaces if it exist and explode by comma character
  $show_periods = explode(',', str_replace(' ', '', $periods));

  if (!empty($show_periods)) {
    foreach ($show_periods as $show_period) {
      // Get item of show period. It can be empty if period is not defined
      $show_period_item = _usanetwork_home_get_running_show($show_period, $user_timezone_correlation);

      // Filter empty results
      if (!empty($show_period_item)) {
        $data[$show_period] = $show_period_item;
      }
    }
  }

  return drupal_json_output($data);
}

/**
 * Returns show by period type.
 * @param string $period = 'now' || 'next'
 */
function _usanetwork_home_get_running_show($period = 'now', $user_timezone_correlation = 0) {
  if (!module_exists('program_guide')) {
    return;
  }

  $period_callbacks = array(
    'now' => '_usanetwork_home_get_running_now_show',
    'next' => '_usanetwork_home_get_running_next_show',
  );

  if (!empty($period) && isset($period_callbacks[$period])) {
    $program_object = $period_callbacks[$period]($user_timezone_correlation);

    if (!empty($program_object)) {
      $program_entity = entity_load('program', array($program_object->guid));

      if (!empty($program_entity) && isset($program_entity[$program_object->guid])) {
        return reset($program_entity);
      }

      return $program_entity;
    }
  }

  return NULL;
}

/**
 * Returns query object with current running show.
 */
function _usanetwork_home_get_running_now_show($user_timezone_correlation = 0) {
  $request_time = REQUEST_TIME + $user_timezone_correlation;

  $query = db_select('programs', 'p');
  $query->fields('p', array());
  $query->condition('p.start_time', $request_time, '<');
  $query->condition('p.end_time', $request_time, '>');
  $query->range(0, 1);

  return $query->execute()->fetch();
}

/**
 * Returns query object with next running show.
 */
function _usanetwork_home_get_running_next_show($user_timezone_correlation = 0) {
  $request_time = REQUEST_TIME + $user_timezone_correlation;

  $query = db_select('programs', 'p');
  $query->fields('p', array());
  $query->condition('p.start_time', $request_time, '>');
  $query->orderBy('p.start_time', 'ASC');
  $query->range(0, 1);

  return $query->execute()->fetch();
}

/**
 * Ajusts $timestamp with $user_timezone correlation.
 */
function _usanetwork_home_get_user_timezome_correlation($user_timezone, $timestamp = REQUEST_TIME) {
  $dateTime = new DateTime();
  $dateTime->setTimestamp($timestamp);

  $user_timezone = str_replace('-', '/', $user_timezone);

  try {
    $dateTimeZone = new DateTimeZone($user_timezone);

    if ($dateTimeZone) {
      return $dateTimeZone->getOffset($dateTime);
    }
  }
  catch (Exception $e) {}

  return 0;
}

/**
 * Renders primetime block.
 */
function _usanetwork_home_show_menu_primetime_block() {
  $elements = array();
  $programs = _usanetwork_home_show_menu_get_primetime_items();

  if (!empty($programs)) {
    foreach ($programs as $program) {
      $elements[] = theme('usanetwork_home_smnav_primetime_item', array(
        'time' => array(
          'value' => date('g:i', $program->start_time),
          'interval' => date('A', $program->start_time),
        ),
        'show_title' => $program->parent_title,
        'show_episode' => $program->title,
      ));
    }
  }

  if (!empty($elements)) {
    return theme('usanetwork_home_smnav_primetime_container', array(
      'elements' => $elements,
    ));
  }

  return '';
}

/**
 * Returns primetime items.
 */
function _usanetwork_home_show_menu_get_primetime_items() {
  $dateTime = new DateTime('now');
  $primeTimeStart = $dateTime->setTime(USANETWORK_HOME_PRIMETIME_START_HOUR, 0)->getTimestamp();
  $primeTimeEnd = $dateTime->setTime(USANETWORK_HOME_PRIMETIME_END_HOUR, 0)->getTimestamp();

  $query = db_select('programs', 'p');
  $query->fields('p', array());
  $query->condition('p.start_time', $primeTimeStart, '>=');
  $query->condition('p.end_time', $primeTimeEnd, '<=');
  $query->range(0, USANETWORK_HOME_PRIMETIME_ITEMS_LENGTH);
  $query->orderBy('p.start_time', 'ASC');

  return $query->execute()->fetchAll();
}

/**
 * Renders block of upcoming episodes.
 */
function _usanetwork_home_show_menu_upcoming_episodes() {
  $elements = array();
  $node = _usanetwork_home_show_menu_get_current_show_node();

  if (!empty($node)) {
    $episodes = _usanetwork_home_show_menu_get_upcomming_episodes($node);

    if (!empty($episodes)) {
      foreach ($episodes as $episode) {
        $preview_image = NULL;

        if (empty($episode->thumbnail_url) || empty($episode->description)) {
          continue;
        }

        $preview_image = theme('image_style', array(
          'style_name' => 'episode_preview_temp',
          'path' => $episode->thumbnail_url,
        ));

        $elements[] = theme('usanetwork_home_smnav_upcoming_element', array(
          'image_url' => $episode->thumbnail_url,
          'image' => $preview_image,
          'show_name' => $episode->parent_title,
          'episode_title' => $episode->title,
          'episode_day' => date('l', $episode->start_time),
          'episode_time' => date('g:i', $episode->start_time),
          'episode_interval' => date('A', $episode->start_time),
          'episode_description' => $episode->description,
        ));
      }
    }
  }

  if (!empty($elements)) {
    return theme('usanetwork_home_smnav_upcoming_element_container', array(
      'elements' => $elements,
    ));
  }

  return '';
}

/**
 * Returns current Show node.
 */
function _usanetwork_home_show_menu_get_current_show_node() {
  $menu_item = menu_get_item();

  if (!empty($menu_item['page_arguments'])) {
    $node = reset($menu_item['page_arguments']);

    if (isset($node->type) && $node->type == 'tv_show') {
      return $node;
    }
  }

  return NULL;
}

/**
 * Selects from program $length (default=2) upcoming episodes using title of Show node.
 */
function _usanetwork_home_show_menu_get_upcomming_episodes($show_node, $length = 2) {
  $query = db_select('programs', 'p');
  $query->leftJoin('mpx_video', 'v', 'p.guid=v.id');
  $query->fields('p', array());
  $query->fields('v', array('fid', 'video_id', 'title', 'description', 'thumbnail_url'));
  // $show_node->title - is only one relation between shows in programs and nodes
  $query->condition('p.parent_title', $show_node->title);
  $query->condition('p.start_time',REQUEST_TIME, '>');
  $query->range(0, $length);
  $query->orderBy('p.start_time', 'ASC');

  return $query->execute()->fetchAll();
}

/**
 * Renders Show Menu.
 */
function _usanetwork_home_render_show_menu() {
  $output = '';

  $panel = panels_mini_load('usanetwork_show_menu');

  if ($panel) {
    $output = panels_render_display($panel->display);
  }

  return $output;
}
