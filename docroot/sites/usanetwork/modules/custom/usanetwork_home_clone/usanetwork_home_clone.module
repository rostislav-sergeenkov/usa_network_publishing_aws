<?php

/**
 * Implements hook_form_FORM_ID_alter().
 * Alters usa_homepage_node_form.
 */
function usanetwork_home_clone_form_usa_homepage_node_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['field_usa_hp_daylist'])) {
    // Add copy dropdown and button
    $daylist = $form['field_usa_hp_daylist'][$form['field_usa_hp_daylist']['#language']];
    if (isset($daylist)) {
      $form['field_usa_hp_daylist']['#attributes']['class'][] = 'container-inline';
      // Add day list dropdown
      $form['field_usa_hp_daylist']['copy_to'] = array(
        '#title' => t('Copy this day to') . ':',
        '#type' => 'select',
        '#options' => $daylist['#options'],
        '#default_value' => $daylist['#default_value'],
      );
      // Add "Copy Now" button
      $form['field_usa_hp_daylist']['copy_now'] = array(
        '#type' => 'submit',
        '#value' => t('Copy Now'),
        '#submit' => array('usanetwork_home_clone_submit'),
        '#limit_validation_errors' => array(),
      );
      // Add "Save&Copy" button
      $form['field_usa_hp_daylist']['save_copy'] = array(
        '#type' => 'submit',
        '#value' => t('Save&Copy'),
        '#submit' => array('usanetwork_home_clone_submit'),
      );
    }
  }
}

/**
 * Submit handler for homepage "Copy Now" button
 */
function usanetwork_home_clone_submit($form, &$form_state) {
  $day = $form_state['input']['field_usa_hp_daylist']['copy_to'];

  // Check if we need to save original node
  if ($form_state['clicked_button']['#id'] == $form['field_usa_hp_daylist']['save_copy']['#id']) {
    // execute submit callbacks
    foreach ($form['#submit'] as $callback) {
      if (function_exists($callback)) {
        $callback($form, $form_state);
      }
    }
    // process input and save node
    node_form_submit($form, $form_state);
  }

  $source = $form_state['node'];
  // get the node id by day
  $nid = db_select('field_data_field_usa_hp_daylist', 'f')
    ->fields('f', array('entity_id'))
    ->condition('entity_type', 'node', '=')
    ->condition('bundle', 'usa_homepage', '=')
    ->condition('field_usa_hp_daylist_value', $day, '=')
    ->execute()
    ->fetchField();

  if ($nid) {
    $clone = node_load($nid);
    // copy  fields
    foreach ($form_state['field'] as $field_name => $field) {
      if ($field_name != 'field_usa_hp_daylist') {
        $clone->{$field_name} = $source->{$field_name};
      }
    }
    // set draft
    $clone->current_state = 'draft';
    $clone->state_flow->current = 'draft';
    // make it new revision
    unset($clone->vid);
    $clone->revision = true;
    try {
      node_save($clone);
      drupal_set_message(t('Homepage was copied to %day and set to draft.', array('%day' => $clone->title)));
      $form_state['redirect'] = 'node/' . $clone->nid . '/revisions/' . $clone->vid . '/edit';
      return;
    }
    catch (Exception $e) {
      // set the error
    }
  }

  form_error($form, t('Error cloning homepage. Please, try again later.'));
}
