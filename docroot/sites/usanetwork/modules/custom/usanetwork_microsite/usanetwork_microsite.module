<?php
/**
 * @file
 * Code for the usanetwork_microsite feature.
 */

include_once 'usanetwork_microsite.features.inc';


if (!defined('USA_PREFIX')) define('USA_PREFIX', '<h2>');
if (!defined('USA_SUFFIX')) define('USA_SUFFIX', '</h2>');
function usa_print($msg) {
  return USA_PREFIX . $msg . USA_SUFFIX;
}

include_once 'usanetwork_microsite.admin.inc';

/**
 * Implements hook_menu().
 */
function usanetwork_microsite_menu() {
//echo usa_print('usanetwork_microsite_menu');
  $items = array();
/*
  $items['node/%/#section=%/%'] = array(
    'title' => 'Microsite Page',
    'page callback' => 'usanetwork_dig_show_page_process',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
  );
*/
// @TODO: SET THE FOLLOWING SO IT DOESN'T LOOK AT EVERY NODE!!!
//  $items['node/%'] = array(
  $items['node/54211'] = array(
    'title' => 'Dig',
    'page callback' => 'usanetwork_dig_show_page',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
  );

  return $items;
}

function _usanetwork_microsite_get_info($nid) {
//echo USA_PREFIX . '_usanetwork_microsite_get_info()' . USA_SUFFIX;
  $params = array();
  $node = node_load($nid);
  if ($node->type == 'usanetwork_microsite') {
//dpm($node);

    // set variables
    $lang = (!empty($node->language)) ? $node->language : 'und';
    $params['lang'] = $lang;
    $params['show'] = (!empty($node->field_show[$lang][0]['target_id'])) ? $node->field_show[$lang][0]['target_id'] : '';
    $params['theme'] = (!empty($node->field_ms_theme[$lang][0]['value'])) ? $node->field_ms_theme[$lang][0]['value'] : '';
    $params['profile_image'] = (!empty($node->field_ms_small_logo[$lang][0]['filename'])) ? $node->field_ms_small_logo[$lang][0]['filename'] : '';
    $params['tune_in'] = (!empty($node->field_ms_tune_in[$lang][0]['value'])) ? $node->field_ms_tune_in[$lang][0]['value'] : '';
    $params['section_separator'] = (!empty($node->field_ms_section_separator[$lang][0]['value'])) ? $node->field_ms_section_separator[$lang][0]['value'] : '';
    $section = array();
    foreach($node->field_ms_section[$lang] as $key => $array) {
      $s_node_id = $node->field_ms_section[$lang][$key]['value'];
      $s_node = entity_load('field_collection_item', array($s_node_id));
//dpm($s_node_id);
//dpm($s_node);

      $section = array();
      $section['section_enabled'] = $s_node[$s_node_id]->field_ms_section_enabled[$lang][0]['value'];
      if ($section['section_enabled']) {
        $section['title'] = (!empty($s_node[$s_node_id]->field_ms_section_title[$lang][0]['value'])) ? $s_node[$s_node_id]->field_ms_section_title[$lang][0]['value'] : '';
        $section['bg_image'] = (!empty($s_node[$s_node_id]->field_ms_section_bg_image[$lang][0]['filename'])) ? $s_node[$s_node_id]->field_ms_section_bg_image[$lang][0]['filename'] : '';
        $section['type'] = (!empty($s_node[$s_node_id]->field_ms_section_type[$lang][0]['value'])) ? $s_node[$s_node_id]->field_ms_section_type[$lang][0]['value'] : '';

        // aspots
        $aspots = array();
        foreach($s_node[$s_node_id]->field_usa_hp_arefs[$lang] as $key2 => $array2) {
          $aspot_node_id = $s_node[$s_node_id]->field_usa_hp_arefs[$lang][$key2]['target_id'];
          $aspots[] = (array)node_load($aspot_node_id);
          // add aspot info to javascript
          //_usanetwork_aspot_preprocess_node($aspot_node_id);
        }
        $section['aspot'] = $aspots;

        // bspot -- there should be only 1
        $section['bspot'] = (!empty($s_node[$s_node_id]->field_usa_hp_brefs[$lang][0]['target_id'])) ? (array)node_load($s_node[$s_node_id]->field_usa_hp_brefs[$lang][0]['target_id']) : '';

        // cspot -- there should be only 1
        $section['cspot'] = (!empty($s_node[$s_node_id]->field_usa_hp_crefs[$lang][0]['target_id'])) ? (array)node_load($s_node[$s_node_id]->field_usa_hp_crefs[$lang][0]['target_id']) : '';

        // media gallery
        $section['media_gallery'] = (!empty($s_node[$s_node_id]->field_media_gallery[$lang][0]['target_id'])) ? (array)node_load($s_node[$s_node_id]->field_media_gallery[$lang][0]['target_id']) : '';

        // about description
        $section['description'] = (!empty($s_node[$s_node_id]->field_ms_section_text[$lang][0]['value'])) ? $s_node[$s_node_id]->field_ms_section_text[$lang][0]['value'] : '';

        // people
        $people = array();
        foreach($s_node[$s_node_id]->field_person[$lang] as $person_key => $person_array) {
          $person_node_id = $s_node[$s_node_id]->field_person[$lang][$person_key]['target_id'];
//dpm($person_node_id);
          $person_node = (array)node_load($person_node_id);
//dpm($person_node);
          // get people quotes
          $people_quotes = array();
          if (count($person_node['field_quotation']) > 0) {
            foreach($person_node['field_quotation'][$lang] as $quote_key => $quote_array) {
              $quote_node_id = $person_node['field_quotation'][$lang][$quote_key]['value'];
              $quote_node = (array)entity_load('field_collection_item', array($quote_node_id));
//dpm($quote_node);
              $people_quotes[] = array(
                'quote' => $quote_node[$quote_node_id]->field_quote[$lang][0]['safe_value'],
                'source' => $quote_node[$quote_node_id]->field_usanetwork_source[$lang][0]['safe_value']
              );
            }
          }
          $people[] = array(
            'title' => $person_node['title'],
            'description' => $person_node['body'][$lang][0]['value'],
            'quotes' => $people_quotes
          );
        }
        $section['people'] = $people;

        // carousels
        $section['promo_carousel'] = (!empty($s_node[$s_node_id]->field_hp_promo_carousel[$lang][0]['target_id'])) ? $s_node[$s_node_id]->field_hp_promo_carousel[$lang][0]['target_id'] : '';

        // promo
        $section['featured_promo'] = (!empty($s_node[$s_node_id]->field_hp_promos[$lang][0]['target_id'])) ? $s_node[$s_node_id]->field_hp_promos[$lang][0]['target_id'] : '';

        // about quotations
        $about_quotations = array();
        foreach($s_node[$s_node_id]->field_quotation[$lang] as $quote_key => $quote_array) {
            $about_quote_node_id = $s_node[$s_node_id]->field_quotation[$lang][$quote_key]['value'];
            $about_node = (array)entity_load('field_collection_item', array($about_quote_node_id));
            $about_quotations[] = array(
              'quote' => $about_node[$about_quote_node_id]->field_quote[$lang][0]['safe_value'],
              'source' => $about_node[$about_quote_node_id]->field_usanetwork_source[$lang][0]['safe_value']
            );
        }
        $section['about_quotations'] = $about_quotations;

        // catch all
        $catchalls = array();
        foreach($s_node[$s_node_id]->field_ms_catchall_page[$lang] as $key3 => $array3) {
          $catchall_node_id = $s_node[$s_node_id]->field_ms_catchall_page[$lang][$key3]['target_id'];
          $catchalls[] = (array)node_load($catchall_node_id);
        }
        $section['catchalls'] = $catchalls;
        $section['featured_promo'] = (!empty($s_node[$s_node_id]->field_hp_promos[$lang][0]['target_id'])) ? $s_node[$s_node_id]->field_hp_promos[$lang][0]['target_id'] : '';
      }
      $params['section'][$key] = $section;
    }
    // set paths
    $params['theme_path'] = drupal_get_path('theme', 'aurora_usa') . '/usanetwork_microsite_themes/' . $params['theme'];
//dpm($params);

    usanetwork_dig_show_page($params);
  }

  return $params;
}

/**
 * usanetwork_dig_show_page
 * Sets $params array containing all content
 */
//function usanetwork_dig_show_page($nid) {
function usanetwork_dig_show_page($nid) {
  //if (!path_is_admin(current_path())) {
    $params = _usanetwork_microsite_get_info($nid);

    if (count($params) > 0) {
      // add css
      drupal_add_css(drupal_get_path('theme', 'aurora_usa') . '/usanetwork_microsite_themes/dig/css/ms_style.css');
      drupal_add_css(drupal_get_path('theme', 'aurora_usa') . '/usanetwork_microsite_themes/dig/css/trivia.css');

      // add js
      drupal_add_js(drupal_get_path('module', 'usanetwork_microsite') . '/js/jquery.easing.1.3.js');
      drupal_add_js(drupal_get_path('module', 'usanetwork_microsite') . '/js/jquery.easing.compatibility.js');
      drupal_add_js(drupal_get_path('module', 'usanetwork_microsite') . '/js/microsite_global.js');
      //drupal_add_js(drupal_get_path('theme', 'aurora_usa') . '/javascripts/show-flexslider.js');

      return theme('usanetwork_dig_show_page', $params);
    }
    else {
      // do nothing here
      // for some reason this function is being called more than once!!
      //echo('params not set yet');
    }
  //}
}


/**
 * Implements hook_theme().
 */
function usanetwork_microsite_theme() {
usa_print('usanetwork_microsite_theme');
  $theme_path = drupal_get_path('theme', 'aurora_usa');
// @TODO: FIND A WAY TO PASS $params['theme'] TO THE FILE TEMPLATE PATH
  $themes = array(
    'usanetwork_dig_show_page' => array(
      'template' => 'usanetwork_microsite',
      'path' => $theme_path . '/usanetwork_microsite_themes/dig/templates',
    ),
  );
  return $themes;
}

/**
 * Implements hook_permission
 */
function usanetwork_microsite_permission() {
  $perm = array(
    'view microsites' => array(
      'title' => t('View microsites'),
    ),
    'create microsites' => array(
      'title' => t('Create microsites'),
    ),
    'manage microsites' => array(
      'title' => t('Manage microsites'),
    )
  );
  return $perm;
}
