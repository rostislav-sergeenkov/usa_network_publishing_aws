<?php
/**
 * @file
 * Code for the usanetwork_microsite feature.
 */

define('USANETWORK_MICROSITE_NODE_TYPE', 'usanetwork_microsite');

include_once 'usanetwork_microsite.features.inc';


if (!defined('USA_PREFIX')) define('USA_PREFIX', '<h2>');
if (!defined('USA_SUFFIX')) define('USA_SUFFIX', '</h2>');
function usa_print($msg) {
  return USA_PREFIX . $msg . USA_SUFFIX;
}

include_once 'usanetwork_microsite.admin.inc';

/**
 * Implements hook_menu().
 */
function usanetwork_microsite_menu() {
  $items = array();

  $items['node/%node/microsite'] = array(
    'title' => 'Test',
    'page callback' => 'usanetwork_microsite_page_callback',
    'page arguments' => array('node', 1),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Microsite node rendering callback.
 */
function usanetwork_microsite_page_callback($entity_type, $node) {
  if (!empty($node) && $node->type == USANETWORK_MICROSITE_NODE_TYPE) {
    $theme_variables = _usanetwork_microsite_get_theme_variables($node);

    return theme('usanetwork_dig_show_page', $theme_variables);
  }
}

/**
 * Prepares theme variables for microsite theme.
 */
function _usanetwork_microsite_get_theme_variables($node) {
  $node_wrapper = entity_metadata_wrapper('node', $node);

  // Fill base variables
  $theme_variables = _usanetwork_microsite_theme_get_base_variables($node_wrapper);

  // Detect sections availability
  if (!empty($node->field_ms_section)) {
    $sections_variables = array();

    // Walk through connected sections
    foreach ($node_wrapper->field_ms_section as $section_wrapper) {
      // Fill base section values
      $section_base_variables = _usanetwork_microsite_theme_get_section_base_variables($section_wrapper);

      if (empty($section_base_variables)) {
        continue;
      }

      $sections_variables[] = _usanetwork_microsite_theme_get_section_theme_variables($section_base_variables, $section_wrapper);
    }

    $theme_variables['section'] = $sections_variables;
  }

  return $theme_variables;
}

/**
 * Returns theme base variables.
 */
function _usanetwork_microsite_theme_get_base_variables($node_wrapper) {
  $node = $node_wrapper->value();

  return array(
    'show' => !empty($node->field_show)
      ? $node_wrapper->field_show->nid->value()
      : NULL,
    'theme' => !empty($node->field_ms_theme)
      ? $node_wrapper->field_ms_theme->value()
      : NULL,
    'profile_image' => !empty($node->field_ms_small_logo)
      ? $node_wrapper->field_ms_small_logo->file->value()->uri
      : NULL,
    'tune_in' => !empty($node->field_ms_tune_in)
      ? $node_wrapper->field_ms_tune_in->value()
      : NULL,
    'section_separator' => !empty($node->field_ms_section_separator)
      ? $node_wrapper->field_ms_section_separator->value()
      : NULL,
  );
}

/**
 * Returns base variables of sections.
 */
function _usanetwork_microsite_theme_get_section_base_variables($section_wrapper) {
  $section_node = $section_wrapper->value();

  if (!empty($section_node->field_ms_section_enabled) && $section_wrapper->field_ms_section_enabled->value() == 1) {
    $is_enabled = TRUE;
  }

  // Do not process this section if it disabled
  if (!$is_enabled) {
    return array();
  }

  return array(
    'section_enabled' => $is_enabled,
    'title' => !empty($section_node->field_ms_section_title)
      ? $section_wrapper->field_ms_section_title->value()
      : NULL,
    'bg_image' => !empty($section_node->field_ms_section_bg_image)
      ? $section_wrapper->field_ms_section_bg_image->file->value()->uri
      : NULL,
    'type' => !empty($section_node->field_ms_section_type)
      ? $section_wrapper->field_ms_section_type->value()
      : NULL,
  );
}

/**
 * Renders theme elements of section.
 */
function _usanetwork_microsite_theme_get_section_theme_variables($section_base_variables, $section_wrapper) {
  $section_node = $section_wrapper->value();

  // Render all A-Spots
  if (!empty($section_node->field_usa_hp_arefs)) {
    $section_base_variables['aspots'] = _usanetwork_microsite_theme_render_multiple_node_items($section_wrapper->field_usa_hp_arefs, 'teaser');
  }

  // Render B-Spot
  if (!empty($section_node->field_usa_hp_brefs)) {
    $section_base_variables['bspots'] = _usanetwork_microsite_theme_render_single_node_item($section_wrapper->field_usa_hp_brefs, 'promo_teaser');
  }

  // Render C-Spots
  if (!empty($section_node->field_usa_hp_crefs)) {
    $section_base_variables['cspots'] = _usanetwork_microsite_theme_render_single_node_item($section_wrapper->field_usa_hp_crefs, 'promo_teaser');
  }

  // Render Media Gallery
  if (!empty($section_node->field_media_gallery)) {
    $section_base_variables['media_gallery'] = _usanetwork_microsite_theme_render_single_node_item($section_wrapper->field_media_gallery, 'full');
  }

  // Render Description
  if (!empty($section_node->field_ms_section_text)) {
    $section_base_variables['description'] = $section_wrapper->field_ms_section_text->value->value();
  }

  // Render Persons
  if (!empty($section_node->field_person)) {
    $persons = array();

    // Content type is broken, it's impossible to walk in it using EntityMetadataWrapper.
    $person_nodes = $section_wrapper->field_person->value();

    // 1 value is object, more that 1 is arra
    if (!is_array($person_nodes)) {
      $person_nodes = array($person_nodes);
    }

    foreach ($person_nodes as $current_person_node) {
      $person = array(
        'title' => $current_person_node->title,
        'description' => !empty($current_person_node->body)
          ? $current_person_node->body[$current_person_node->language][0]['value']
          : NULL,
        'quotes' => array(), // The Person content type currently does not have QUOTATION field.
      );

      $persons[] = $person;
    }

    $section_base_variables['people'] = $persons;
  }

  // Rendering Promo Carousel
  if (!empty($section_node->field_hp_promo_carousel)) {
    $section_base_variables['promo_carousel'] = _usanetwork_microsite_theme_render_single_node_item($section_wrapper->field_hp_promo_carousel, 'teaser');
  }

  // Rendering Features Promos
  if (!empty($section_node->field_hp_promos)) {
    $section_base_variables['featured_promo'] = _usanetwork_microsite_theme_render_single_node_item($section_wrapper->field_hp_promos, 'teaser');
  }

  // Render quotations
  if (!empty($section_node->field_quotation)) {
    $quotes = array();

    foreach ($section_wrapper->field_quotation as $quotation_wrapper) {
      $quotation_entity = $quotation_wrapper->value();

      $quote = array(
        'quote' => !empty($quotation_entity->field_quote)
          ? $quotation_wrapper->field_quote->value()
          : NULL,
        'source' => !empty($quotation_entity->field_usanetwork_source)
          ? $quotation_wrapper->field_usanetwork_source->value()
          : NULL,
      );

      $quotes[] = $quote;
    }

    $section_base_variables['about_quotations'] = $quotes;
  }

  // Render Catchalls
  if (!empty($section_node->field_ms_catchall_page)) {
    $catchalls = array();

    foreach ($section_wrapper->field_ms_catchall_page as $catchall_wrapper) {
      $catchall_node = $catchall_wrapper->value();
      $catchall_view = node_view($catchall_node, 'teaser');

      $catchalls[] = drupal_render($catchall_view);
    }

    $section_base_variables['catchalls'] = $catchalls;
  }

  return $section_base_variables;
}

/**
 * Renders all elements of node field.
 */
function _usanetwork_microsite_theme_render_multiple_node_items($node_wrapper_field, $view_mode = 'teaser') {
  $rendered_items = array();

  foreach ($node_wrapper_field as $field_wrapper) {
    $field_view = node_view($field_wrapper->value(), $view_mode);
    $rendered_items[] = drupal_render($field_view);
  }

  return $rendered_items;
}

/**
 * Renders first element of node field.
 */
function _usanetwork_microsite_theme_render_single_node_item($node_wrapper_field, $view_mode = 'teaser') {
  $node = _usanetwork_microsite_get_first_emwrapper_node($node_wrapper_field);
  $node_view = node_view($node, $view_mode);

  return drupal_render($node_view);
}

/**
 * Returns first node from multiply wrapped elements.
 */
function _usanetwork_microsite_get_first_emwrapper_node($entity_wrapper_object) {
  $node = $entity_wrapper_object->value();

  if (is_array($node)) {
    $node = reset($node);
  }

  return $node;
}

function _usanetwork_microsite_get_info($nid) {
//echo USA_PREFIX . '_usanetwork_microsite_get_info()' . USA_SUFFIX;
  $params = array();
  $node = node_load($nid);
  if ($node->type == 'usanetwork_microsite') {
//dpm($node);

    // set variables
    $lang = (!empty($node->language)) ? $node->language : 'und';
    $params['lang'] = $lang;
    $params['show'] = (!empty($node->field_show[$lang][0]['target_id'])) ? $node->field_show[$lang][0]['target_id'] : '';
    $params['theme'] = (!empty($node->field_ms_theme[$lang][0]['value'])) ? $node->field_ms_theme[$lang][0]['value'] : '';
    $params['profile_image'] = (!empty($node->field_ms_small_logo[$lang][0]['filename'])) ? $node->field_ms_small_logo[$lang][0]['filename'] : '';
    $params['tune_in'] = (!empty($node->field_ms_tune_in[$lang][0]['value'])) ? $node->field_ms_tune_in[$lang][0]['value'] : '';
    $params['section_separator'] = (!empty($node->field_ms_section_separator[$lang][0]['value'])) ? $node->field_ms_section_separator[$lang][0]['value'] : '';
    $section = array();
    foreach($node->field_ms_section[$lang] as $key => $array) {
      $s_node_id = $node->field_ms_section[$lang][$key]['value'];
      $s_node = entity_load('field_collection_item', array($s_node_id));
//dpm($s_node_id);
//dpm($s_node);

      $section = array();
      $section['section_enabled'] = $s_node[$s_node_id]->field_ms_section_enabled[$lang][0]['value'];
      if ($section['section_enabled']) {
        $section['title'] = (!empty($s_node[$s_node_id]->field_ms_section_title[$lang][0]['value'])) ? $s_node[$s_node_id]->field_ms_section_title[$lang][0]['value'] : '';
        $section['bg_image'] = (!empty($s_node[$s_node_id]->field_ms_section_bg_image[$lang][0]['filename'])) ? $s_node[$s_node_id]->field_ms_section_bg_image[$lang][0]['filename'] : '';
        $section['type'] = (!empty($s_node[$s_node_id]->field_ms_section_type[$lang][0]['value'])) ? $s_node[$s_node_id]->field_ms_section_type[$lang][0]['value'] : '';

        // aspots
        $aspots = array();
        foreach($s_node[$s_node_id]->field_usa_hp_arefs[$lang] as $key2 => $array2) {
          $aspot_node_id = $s_node[$s_node_id]->field_usa_hp_arefs[$lang][$key2]['target_id'];
          $aspots[] = (array)node_load($aspot_node_id);
          // add aspot info to javascript
          //_usanetwork_aspot_preprocess_node($aspot_node_id);
        }
        $section['aspot'] = $aspots;

        // bspot -- there should be only 1
        $section['bspot'] = (!empty($s_node[$s_node_id]->field_usa_hp_brefs[$lang][0]['target_id'])) ? (array)node_load($s_node[$s_node_id]->field_usa_hp_brefs[$lang][0]['target_id']) : '';

        // cspot -- there should be only 1
        $section['cspot'] = (!empty($s_node[$s_node_id]->field_usa_hp_crefs[$lang][0]['target_id'])) ? (array)node_load($s_node[$s_node_id]->field_usa_hp_crefs[$lang][0]['target_id']) : '';

        // media gallery
        $section['media_gallery'] = (!empty($s_node[$s_node_id]->field_media_gallery[$lang][0]['target_id'])) ? (array)node_load($s_node[$s_node_id]->field_media_gallery[$lang][0]['target_id']) : '';

        // about description
        $section['description'] = (!empty($s_node[$s_node_id]->field_ms_section_text[$lang][0]['value'])) ? $s_node[$s_node_id]->field_ms_section_text[$lang][0]['value'] : '';

        // people
        $people = array();
        foreach($s_node[$s_node_id]->field_person[$lang] as $person_key => $person_array) {
          $person_node_id = $s_node[$s_node_id]->field_person[$lang][$person_key]['target_id'];
//dpm($person_node_id);
          $person_node = (array)node_load($person_node_id);
//dpm($person_node);
          // get people quotes
          $people_quotes = array();
          if (count($person_node['field_quotation']) > 0) {
            foreach($person_node['field_quotation'][$lang] as $quote_key => $quote_array) {
              $quote_node_id = $person_node['field_quotation'][$lang][$quote_key]['value'];
              $quote_node = (array)entity_load('field_collection_item', array($quote_node_id));
//dpm($quote_node);
              $people_quotes[] = array(
                'quote' => $quote_node[$quote_node_id]->field_quote[$lang][0]['safe_value'],
                'source' => $quote_node[$quote_node_id]->field_usanetwork_source[$lang][0]['safe_value']
              );
            }
          }
          $people[] = array(
            'title' => $person_node['title'],
            'description' => $person_node['body'][$lang][0]['value'],
            'quotes' => $people_quotes
          );
        }
        $section['people'] = $people;

        // carousels
        $section['promo_carousel'] = (!empty($s_node[$s_node_id]->field_hp_promo_carousel[$lang][0]['target_id'])) ? $s_node[$s_node_id]->field_hp_promo_carousel[$lang][0]['target_id'] : '';

        // promo
        $section['featured_promo'] = (!empty($s_node[$s_node_id]->field_hp_promos[$lang][0]['target_id'])) ? $s_node[$s_node_id]->field_hp_promos[$lang][0]['target_id'] : '';

        // about quotations
        $about_quotations = array();
        foreach($s_node[$s_node_id]->field_quotation[$lang] as $quote_key => $quote_array) {
            $about_quote_node_id = $s_node[$s_node_id]->field_quotation[$lang][$quote_key]['value'];
            $about_node = (array)entity_load('field_collection_item', array($about_quote_node_id));
            $about_quotations[] = array(
              'quote' => $about_node[$about_quote_node_id]->field_quote[$lang][0]['safe_value'],
              'source' => $about_node[$about_quote_node_id]->field_usanetwork_source[$lang][0]['safe_value']
            );
        }
        $section['about_quotations'] = $about_quotations;

        // catch all
        $catchalls = array();
        foreach($s_node[$s_node_id]->field_ms_catchall_page[$lang] as $key3 => $array3) {
          $catchall_node_id = $s_node[$s_node_id]->field_ms_catchall_page[$lang][$key3]['target_id'];
          $catchalls[] = (array)node_load($catchall_node_id);
        }
        $section['catchalls'] = $catchalls;
        $section['featured_promo'] = (!empty($s_node[$s_node_id]->field_hp_promos[$lang][0]['target_id'])) ? $s_node[$s_node_id]->field_hp_promos[$lang][0]['target_id'] : '';
      }
      $params['section'][$key] = $section;
    }
    // set paths
    $params['theme_path'] = drupal_get_path('theme', 'aurora_usa') . '/usanetwork_microsite_themes/' . $params['theme'];
//dpm($params);

    usanetwork_dig_show_page($params);
  }

  return $params;
}

/**
 * usanetwork_dig_show_page
 * Sets $params array containing all content
 */
//function usanetwork_dig_show_page($nid) {
function usanetwork_dig_show_page($nid) {
  //if (!path_is_admin(current_path())) {
    $params = _usanetwork_microsite_get_info($nid);

    if (count($params) > 0) {
      // add css
      drupal_add_css(drupal_get_path('theme', 'aurora_usa') . '/usanetwork_microsite_themes/dig/css/ms_style.css');
      drupal_add_css(drupal_get_path('theme', 'aurora_usa') . '/usanetwork_microsite_themes/dig/css/trivia.css');

      // add js
      drupal_add_js(drupal_get_path('module', 'usanetwork_microsite') . '/js/jquery.easing.1.3.js');
      drupal_add_js(drupal_get_path('module', 'usanetwork_microsite') . '/js/jquery.easing.compatibility.js');
      drupal_add_js(drupal_get_path('module', 'usanetwork_microsite') . '/js/microsite_global.js');
      //drupal_add_js(drupal_get_path('theme', 'aurora_usa') . '/javascripts/show-flexslider.js');

      return theme('usanetwork_dig_show_page', $params);
    }
    else {
      // do nothing here
      // for some reason this function is being called more than once!!
      //echo('params not set yet');
    }
  //}
}

/**
 * Implements hook_theme().
 */
function usanetwork_microsite_theme() {
  // Never use 'print' or 'echo' in hook_hookname() functions. It could crash Drupal!
  //usa_print('usanetwork_microsite_theme');
  $theme_path = drupal_get_path('theme', 'aurora_usa');
  // @TODO: FIND A WAY TO PASS $params['theme'] TO THE FILE TEMPLATE PATH
  $themes = array(
    'usanetwork_dig_show_page' => array(
      'template' => 'usanetwork_microsite',
      'path' => $theme_path . '/usanetwork_microsite_themes/dig/templates',
      'variables' => array(
        'lang' => NULL,
        'show' => NULL,
        'theme' => NULL,
        'profile_image' => NULL,
        'profile_image' => NULL,
        'tune_in' => NULL,
        'section_separator' => NULL,
        'section' => array(),
        'theme_path' => NULL,
      ),
    ),
  );
  return $themes;
}

/**
 * Implements hook_permission
 */
function usanetwork_microsite_permission() {
  $perm = array(
    'view microsites' => array(
      'title' => t('View microsites'),
    ),
    'create microsites' => array(
      'title' => t('Create microsites'),
    ),
    'manage microsites' => array(
      'title' => t('Manage microsites'),
    )
  );
  return $perm;
}
