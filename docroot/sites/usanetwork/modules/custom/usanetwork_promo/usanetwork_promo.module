<?php
/**
 * @file
 * Code for the USANetwork Promo feature.
 */

include_once 'usanetwork_promo.features.inc';

/**
 * Implements template_preprocess_node().
 */
function usanetwork_promo_preprocess_node(&$vars) {
  $node = $vars['node'];
  
  if ($node->type == 'usanetwork_promo') {
    $action_type = field_get_items('node', $node, 'field_call_to_action_type');
    $action_term = taxonomy_term_load($action_type[0]['tid']);
    $vars['action_type'] = $action_term->name;
  }
}

/**
 * Implements hook_media_theplatform_mpx_import_media().
 */
function usanetwork_promo_media_theplatform_mpx_import_media($op, $media_item, $account) {

  $media_files = media_theplatform_mpx_get_files_by_guid($media_item['guid'], $account);

  foreach ($media_files as $file) { 
    if ($media_item['expiration_date'] && $media_item['expiration_date'] < REQUEST_TIME) {
    
      $db_select = db_select('field_data_field_promo_assoc_video', 'fdfpav')
        ->fields('fdfpav', array('entity_id'))
        ->condition('field_promo_assoc_video_target_id', $file->fid);
      $promos = $db_select->execute()->fetchCol();

      if ($promos) {
        foreach ($promos as $promo) {
          $db_select_bspot = db_select('field_data_field_usa_hp_brefs', 'fdfuhb')
            ->fields('fdfuhb', array('entity_id'))
            ->condition('field_usa_hp_brefs_target_id', $promo);
          $promo_bspot = $db_select_bspot->execute()->fetchField();

          if (!$promo_bspot) {
            $db_select_cspot = db_select('field_data_field_usa_hp_crefs', 'fdfuhc')
              ->fields('fdfuhc', array('entity_id'))
              ->condition('field_usa_hp_crefs_target_id', $promo);
            $promo_cspot = $db_select_cspot->execute()->fetchField();
          }

          if (!$promo_bspot && !$promo_cspot) {
            $promo_node = node_load($promo);
            $promo_node->status = 0;
            node_save($promo_node);
          }
        }
      }
    }
  }
}

/**
 * Helper for getting associated content for promo
 * @param type $promo - promo id or object
 * @return array with type of associated content and content
 */
function _usanetwork_promo_return_associated_content($promo) {
  if (!is_object($promo)) {
    $promo = node_load($promo);
  }
  
  $assoc_content = reset(field_get_items('node', $promo, 'field_promo_assoc_content')); 
  if ($assoc_content) {
    $assoc_content_node = node_load($assoc_content['target_id']);
    $assoc_content_type = $assoc_content_node->type;
    $assoc_content_value = $assoc_content_node;
  } else {
    $assoc_video = reset(field_get_items('node', $promo, 'field_promo_assoc_video'));
    if ($assoc_video) {
      $assoc_video_file = file_load($assoc_video['target_id']);
      $assoc_content_type = $assoc_video_file->filemime;
      $assoc_content_value = $assoc_video_file;
    } else {
      //if no associated content, returns the same promo
      $assoc_content_type = 'default_promo';
      $assoc_content_value = $promo;
    }
  } 
  
  return array(
    'promo' => $promo,
    'type' => $assoc_content_type,
    'content' => $assoc_content_value,
  );
}

/**
 * Helper for return array of featured content with needed values
 * @param type $promo - promo id or object
 * @return array of featured content
 */
function _usanetwork_promo_featured_content($promo) {
  $associated = _usanetwork_promo_return_associated_content($promo);
  
  $promo = $associated['promo'];
  $type = $associated['type'];
  $content = $associated['content'];
  
  $field_promo_text_line_1 = reset(field_get_items('node', $promo, 'field_promo_text_line_1'));
  if ($field_promo_text_line_1) {
    $promo_text_line_1 = $field_promo_text_line_1['value'];
  } 
  
  $icon_type_field = reset(field_get_items('node', $promo, 'field_call_to_action_type'));
  if ($icon_type_field) {
    $icon = taxonomy_term_load($icon_type_field['tid']);
    $icon_type = $icon->name . '-icon';
  }
  
  switch ($type) {
    case 'video/mpx':
      $file = $content;
      $show_field = reset(field_get_items('file', $file, 'field_show'));
      if ($show_field) {
        $show = node_load($show_field['target_id']);
        $title = $show->title;
        $show_class = usanetwork_tv_shows_color_show_css_class($show_field['target_id']);
      } 
      $wrapper = file_stream_wrapper_get_instance_by_uri($file->uri);
      $duration_field = reset(field_get_items('file', $file, 'field_mpx_duration'));
      if ($duration_field) {
        $duration = gmdate("H:i:s", $duration_field['value']);
      } 
      $featutred_content = array(
        'url' => url('file/' . $file->fid),
        'image_url' => $wrapper->getLocalThumbnailPath(),
        'title' => isset($title) ? $title : NULL,
        'subtitle' => NULL,
        'type' => $file->filename,
        'time' => isset($duration) ? $duration : NULL,
        'cta_text' => isset($promo_text_line_1) ? $promo_text_line_1 : NULL,
        'show_class' => isset($show_class) ? $show_class : '',
        'icon_type' => isset($icon_type) ? $icon_type : '',
        'published' => ($file->mpx_video_data['status'] == 1) ? TRUE : FALSE,
      );
      break ;
    case 'media_gallery':
      $node = $content;
      $show_field = reset(field_get_items('node', $node, 'field_show'));
      if ($show_field) {
        $show_class = usanetwork_tv_shows_color_show_css_class($show_field['target_id']);
      } 
      $field_cover_item = reset(field_get_items('node', $node, 'field_cover_item'));
      if ($field_cover_item) {
        $image = $field_cover_item['uri'];
      }
      $field_promo_text_line_2 = reset(field_get_items('node', $promo, 'field_promo_text_line_2'));
      if ($field_promo_text_line_2) {
        $subtitle = $field_promo_text_line_2['value'];
      }
      $featutred_content = array(
        'url' => url('node/' . $node->nid),
        'image_url' => isset($image) ? $image : NULL,
        'title' => $node->title,
        'subtitle' => isset($promo_text_line_1) ? $promo_text_line_1 : NULL,
        'type' => NULL,
        'time' => NULL,
        'cta_text' => isset($subtitle) ? $subtitle : NULL,
        'show_class' => isset($show_class) ? $show_class : '',
        'icon_type' => isset($icon_type) ? $icon_type : '',
        'published' => ($node->status == 1) ? TRUE : FALSE,
      );
      break ;
    case 'default_promo':
      $node = $content;
      $show_field = reset(field_get_items('node', $node, 'field_show'));
      if ($show_field) {
        $show_class = usanetwork_tv_shows_color_show_css_class($show_field['target_id']);
      } 
      $field_promo_regular_image = reset(field_get_items('node', $node, 'field_promo_regular_image'));
      if ($field_promo_regular_image) {
        $image = $field_promo_regular_image['uri'];
      }
      $field_promo_text_line_2 = reset(field_get_items('node', $promo, 'field_promo_text_line_2'));
      if ($field_promo_text_line_2) {
        $subtitle = $field_promo_text_line_2['value'];
      }
      $featutred_content = array(
        'url' => url('node/' . $node->nid),
        'image_url' => isset($image) ? $image : NULL,
        'title' => $node->title,
        'subtitle' => isset($promo_text_line_1) ? $promo_text_line_1 : NULL,
        'type' => NULL,
        'time' => NULL,
        'cta_text' => isset($subtitle) ? $subtitle : NULL,
        'show_class' => isset($show_class) ? $show_class : '',
        'icon_type' => isset($icon_type) ? $icon_type : '',
        'published' => ($node->status == 1) ? TRUE : FALSE,
      );
      break ;
  }
  
  return $featutred_content;
}
