<?php
/**
 * @file
 * Code for the USANetwork Promo feature.
 */

include_once 'usanetwork_promo.features.inc';

/**
 * Implements template_preprocess_node().
 */
function usanetwork_promo_preprocess_node(&$vars) {
  $node = $vars['node'];
  
  if ($node->type == 'usanetwork_promo') {
    $action_type = field_get_items('node', $node, 'field_call_to_action_type');
    $action_term = taxonomy_term_load($action_type[0]['tid']);
    $vars['action_type'] = $action_term->name;
  }
}

/**
 * Implements hook_media_theplatform_mpx_import_media().
 */
function usanetwork_promo_media_theplatform_mpx_import_media($op, $media_item, $account) {

  $media_files = media_theplatform_mpx_get_files_by_guid($media_item['guid'], $account);

  foreach ($media_files as $file) { 
    if ($media_item['expiration_date'] && $media_item['expiration_date'] < REQUEST_TIME) {
    
      $db_select = db_select('field_data_field_promo_assoc_video', 'fdfpav')
        ->fields('fdfpav', array('entity_id'))
        ->condition('field_promo_assoc_video_target_id', $file->fid);
      $promos = $db_select->execute()->fetchCol();

      if ($promos) {
        foreach ($promos as $promo) {
          $db_select_bspot = db_select('field_data_field_usa_hp_brefs', 'fdfuhb')
            ->fields('fdfuhb', array('entity_id'))
            ->condition('field_usa_hp_brefs_target_id', $promo);
          $promo_bspot = $db_select_bspot->execute()->fetchField();

          if (!$promo_bspot) {
            $db_select_cspot = db_select('field_data_field_usa_hp_crefs', 'fdfuhc')
              ->fields('fdfuhc', array('entity_id'))
              ->condition('field_usa_hp_crefs_target_id', $promo);
            $promo_cspot = $db_select_cspot->execute()->fetchField();
          }

          if (!$promo_bspot && !$promo_cspot) {
            $promo_node = node_load($promo);
            $promo_node->status = 0;
            node_save($promo_node);
          }
        }
      }
    }
  }
}

/**
 * Helper for getting associated content for promo
 * @param type $promo - promo id or object
 * @return array with type of associated content and content
 */
function _usanetwork_promo_return_associated_content($promo) {
  if (!is_object($promo)) {
    $promo = node_load($promo);
  }
  
  $assoc_content = reset(field_get_items('node', $promo, 'field_promo_assoc_content')); 
  if ($assoc_content) {
    $assoc_content_node = node_load($assoc_content['target_id']);
    $assoc_content_type = $assoc_content_node->type;
    $assoc_content_value = $assoc_content_node;
  } else {
    $assoc_video = reset(field_get_items('node', $promo, 'field_promo_assoc_video'));
    if ($assoc_video) {
      $assoc_video_file = file_load($assoc_video['target_id']);
      $assoc_content_type = $assoc_video_file->filemime;
      $assoc_content_value = $assoc_video_file;
    } else {
      //if no associated content, returns the same promo
      $assoc_content_type = 'default_promo';
      $assoc_content_value = $promo;
    }
  } 
  
  return array(
    'type' => $assoc_content_type,
    'content' => $assoc_content_value,
  );
}
