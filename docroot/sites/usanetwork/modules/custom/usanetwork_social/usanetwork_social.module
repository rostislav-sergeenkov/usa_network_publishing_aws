<?php
// @TODO: REview once personalization is enabled
/**
 * @file
 * Code for the usanetwork_social feature.
 */

include_once 'usanetwork_social.features.inc';

/**
 * Implementation of hook_menu().
 */
function usanetwork_social_menu() {
  // admin pages
  $items['admin/usanetwork/social-settings'] = array(
    'title' => t('Social Settings'),
    'description' => t('Administer USA Network social settings.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('usanetwork_social_settings_form'),
    'access arguments' => array('administer usanetwork'),
    'file' => 'usanetwork_social.admin.inc',
  );
  // GLOBAL SOCIAL PAGES
  // global social page
  $items['social'] = array(
    'title' => t('Global Social'),
    'page callback' => 'usanetwork_social_global_landing_page',
    'page arguments' => array(0),
    'access callback' => 'usanetwork_social_global_menu_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
  );
  // global trending page
  $items['social/trending'] = array(
    'title' => t('social buzz'),
    'page callback' => 'usanetwork_social_global_trending',
    'page arguments' => array(0),
    'access callback' => 'usanetwork_social_global_menu_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'weight' => 1
  );
  // global chat with fans page
  $items['social/chat-with-fans'] = array(
    'title' => t('chatter'),
    'page callback' => 'usanetwork_social_global_chat_with_fans',
    'page arguments' => array(0),
    'access callback' => 'usanetwork_social_global_menu_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'weight' => 2
  );
  // global twitter page
  $items['social/tweets'] = array(
    'title' => t('tweets'),
    'page callback' => 'usanetwork_social_global_twitter',
    'page arguments' => array(0),
    'access callback' => 'usanetwork_social_global_menu_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'weight' => 3
  );
  // global sync page
  $items['social/sync'] = array(
    'title' => t('usa sync'),
    'page callback' => 'usanetwork_social_global_sync',
    'page arguments' => array(0),
    'access callback' => 'usanetwork_social_global_menu_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'weight' => 4
  );

  // SHOW - LEVEL SOCIAL PAGES
  // tv show social page
  $items['node/%node/social'] = array(
    'title' => t('Social'),
    'page callback' => 'usanetwork_social_landing_page',
    'page arguments' => array(1),
    'access callback' => 'usanetwork_social_menu_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
    'weight' => 1
  );
  // tv show trending page
  $items['node/%node/social/latest'] = array(
    'title' => t('social buzz'),
    'page callback' => 'usanetwork_social_trending',
    'page arguments' => array(1),
    'access callback' => 'usanetwork_social_menu_access',
    'access arguments' => array(1),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 1
  );
  // tv show chat with fans page
  $items['node/%node/social/chat-with-fans'] = array(
    'title' => t('chatter'),
    'page callback' => 'usanetwork_social_chat_with_fans',
    'page arguments' => array(1),
    'access callback' => 'usanetwork_social_menu_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'weight' => 2
  );
  // tv show twitter page
  $items['node/%node/social/tweets'] = array(
    'title' => t('tweets'),
    'page callback' => 'usanetwork_social_twitter',
    'page arguments' => array(1),
    'access callback' => 'usanetwork_social_menu_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'weight' => 3
  );
  // tv show sync page
  $items['node/%node/social/sync'] = array(
    'title' => t('usa sync'),
    'page callback' => 'usanetwork_social_sync',
    'page arguments' => array(1),
    'access callback' => 'usanetwork_social_menu_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'weight' => 4
  );

  return $items;
}

/**
 * Implements hook_block_info().
 */
function usanetwork_social_block_info() {
  $blocks = array();
  $blocks['usa_show_social_tab_nav'] = array(
    'info' => t('USA: show social tab navigation'),
    'cache' => DRUPAL_NO_CACHE,
  );
  $blocks['usa_show_landing_social'] = array(
    'info' => t('USA: show landing social'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );
  $blocks['usa_show_landing_rebelmouse'] = array(
    'info' => t('USA: show landing social Rebel Mouse'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );
  $blocks['usa_show_social_getglue'] = array(
    'info' => t('USA: show social getglue'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function usanetwork_social_block_view($delta) {
  $block = array();
  //The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'usa_show_social_tab_nav':
      $block['subject'] = '';
      $block['content'] = usanetwork_social_show_tab_nav();
      break;
    case 'usa_show_landing_social':
      $block['subject'] = '';
      $block['content'] = usanetwork_social_show_landing();
      break;
    case 'usa_show_landing_rebelmouse':
      $block['subject'] = '';
      $block['content'] = usanetwork_social_show_landing_rebelmouse();
      break;
    case 'usa_show_social_getglue':
      $block['subject'] = '';
      $block['content'] = usanetwork_social_show_getglue();
      break;
  }
  return $block;
}

/**
 * Generate show social page tab navigation
 */
function usanetwork_social_show_tab_nav() {
  $output = '';
  $lang = LANGUAGE_NONE;

  if (arg(0) == 'social') {
    $links = menu_local_tasks(0);
  } else {
    $links = menu_local_tasks(0);
    $node = node_load(arg(1));
  }
  $items = array();

  foreach ($links['tabs']['output'] as $link) {
    $alias = drupal_get_path_alias(str_replace('%', arg(1), $link['#link']['path']));
    switch ($link['#link']['path']) {
      case 'node/%/social/latest':
        if (isset($node->field_show_trending[$lang][0]['value']) && !empty($node->field_show_trending[$lang][0]['value'])) {
          $items[] = l($link['#link']['title'], $alias);
        }
      break;
      case 'node/%/social/chat-with-fans':
        if (isset($node->field_show_chat_page[$lang][0]['value']) && !empty($node->field_show_chat_page[$lang][0]['value'])) {
          $items[] = l($link['#link']['title'], $alias);
        }
      break;
      case 'node/%/social/tweets':
        if (isset($node->field_show_twitter_page[$lang][0]['value']) && !empty($node->field_show_twitter_page[$lang][0]['value'])) {
          $items[] = l($link['#link']['title'], $alias);
        }
      break;
      case 'node/%/social/sync':
        if (isset($node->field_show_sync[$lang][0]['value']) && !empty($node->field_show_sync[$lang][0]['value'])) {
          $items[] = l($link['#link']['title'], $alias);
        }
      break;
      case 'social/sync':
        $showSync = variable_get('usanetwork_social_sync_show_global');
        if ($showSync) {
          $items[] = l($link['#link']['title'], $alias);
        }
      break;
      default:
        $items[] = l($link['#link']['title'], $alias);
    }
  }

  if (!empty($items)) {
    $output = theme('item_list', array('items' => $items));
  }

  return $output;
}


/**
 * Show the GetGlue widget on social pages
 */
function usanetwork_social_show_getglue($node = null) {
  $output = '';
  $lang = LANGUAGE_NONE;
  $arg = arg();

  if (empty($node) && isset($arg[1])) {
    $node = node_load($arg[1]);
  }

  if (!isset($node->nid)) {
    drupal_not_found();
  }
  else
  {
    $showGetglue = isset($node->field_show_getglue[$lang][0]['value']) ? $node->field_show_getglue[$lang][0]['value'] : 0;
    $getglueShow = isset($node->field_getglue_show[$lang][0]['value']) ? strval($node->field_getglue_show[$lang][0]['value']) : 0;
    $getglueSticker = isset($node->field_getglue_sticker_name[$lang][0]['value']) ? $node->field_getglue_sticker_name[$lang][0]['value'] : 0;
    $showName = (isset($node->title)) ? $node->title : '';
    $showAlias = drupal_get_path_alias('node/'.$node->nid);
    $showUrl = (!empty($showAlias)) ? $showAlias : 'node/'.$node->nid;
  }

  // return empty if show Getglue is not turned on
  // or if a show name or show sticker name has not been set for this show
  if (!$showGetglue
    || !$getglueShow
    || !$getglueSticker) {
    return $output;
  }

  $output .= '
              <div id="usanetwork_social_getglue">
                <script type="text/javascript" src="http://widgets.getglue.com/checkin.js"></script>
                <a href="http://getglue.com/tv_shows/'.$getglueShow.'" class="glue-checkin-widget" data-width="300" data-type="sticker" data-sticker="'.$getglueSticker.'" data-bgColor="#EFEFEF">'.$showName.'</a>
              </div>';

  return $output;
}


/**
 * Generate the show landing social block on the show homepage
 */
// @TODO: Add more validation here to make sure fields that are necessary
// have been set?
function usanetwork_social_show_landing($node = null, $items_per_page=3) {

  if (!path_is_admin(current_path())) {

    $output = '';
    $lang = LANGUAGE_NONE;
    $arg = arg();

    if (empty($node) && isset($arg[1])) {
      $node = node_load($arg[1]);
    }

    if (!isset($node->nid)) {
      drupal_not_found();
    }

    $found_social_icons = array();

    $echoAppKey = variable_get('usanetwork_social_chat_echo_app_key', '');
    $vars = 'var echoAppKey = "' . $echoAppKey . '"; ';

    // CHATTER SECTION
    $showChatPage = isset($node->field_show_chat_page[$lang][0]['value']) ? $node->field_show_chat_page[$lang][0]['value'] : 0;

    if ($showChatPage) {
    /* @TODO: CHECK THE FOLLOWING -- DV: COMMENTING THIS FOR NOW AS WE SHOULD NOT NEED POST COMMENTS SECTION ON THE SHOW HOMEPAGE SOCIAL BLOCK CHATTER SECTION?
      $submitTargetUrl = isset($node->field_chat_submittargeturl[$lang][0]['value']) ? $node->field_chat_submittargeturl[$lang][0]['value'] : '';
      $submitTargetUrl = empty($submitTargetUrl) ? variable_get('usanetwork_social_chat_submittargeturl', '') : $submitTargetUrl;

      $identityManagerUrl = isset($node->field_chat_identitymanagerurl[$lang][0]['value']) ? $node->field_chat_identitymanagerurl[$lang][0]['value'] : '';
      $identityManagerUrl = empty($identityManagerUrl) ? variable_get('usanetwork_social_chat_identitymanagerurl', '') : $identityManagerUrl;
    */
      $eql = isset($node->field_chat_eql_template[$lang][0]['value']) ? $node->field_chat_eql_template[$lang][0]['value'] : '';
      $eql = empty($eql) ? variable_get('usanetwork_social_chat_echo_query_template', '') : $eql;

      $tokens = array();
      $tokens['[CHILDRENOF]'] = isset($node->field_chat_childrenof[$lang][0]['value']) ? $node->field_chat_childrenof[$lang][0]['value'] : '';
      $tokens['[SHOW]'] = isset($node->field_chat_show[$lang][0]['value']) ? $node->field_chat_show[$lang][0]['value'] : '';
      $tokens['[FEED]'] = isset($node->field_chat_feed[$lang][0]['value']) ? $node->field_chat_feed[$lang][0]['value'] : '';
      $tokens['[STATE]'] = isset($node->field_chat_state[$lang][0]['value']) ? $node->field_chat_state[$lang][0]['value'] : '';
      $tokens['[SOURCE]'] = isset($node->field_chat_source[$lang][0]['value']) ? $node->field_chat_source[$lang][0]['value'] : '';
      $tokens['[MARKERS]'] = isset($node->field_chat_markers[$lang][0]['value']) ? $node->field_chat_markers[$lang][0]['value'] : '';
      $tokens['[TAGS]'] = isset($node->field_chat_tags[$lang][0]['value']) ? $node->field_chat_tags[$lang][0]['value'] : '';
      $tokens['[SORTORDER]'] = isset($node->field_chat_sortorder[$lang][0]['value']) ? $node->field_chat_sortorder[$lang][0]['value'] : '';
      $tokens['[SAFEHTML]'] = isset($node->field_chat_safehtml[$lang][0]['value']) ? $node->field_chat_safehtml[$lang][0]['value'] : '';
      $tokens['[ITEMSPERPAGE]'] = 'itemsPerPage:' . $items_per_page;
      $tokens['[CHILDREN]'] = 'children:0';

      $eql = str_replace(array_keys($tokens), array_values($tokens), $eql);

      $vars .= 'var chatWithFansEQL = "' . $eql . '"; ';
      $found_social_icons[] = 'showChatPage';
    }
    else {
      $vars .= 'var chatWithFansEQL = ""; ';
    }
    $vars .= 'var maxComments = "20"; ';
    $vars .= 'var maxWordsPerComment = 60; ';
    $vars .= 'var chatterSourceIcon = "'.file_create_url(file_build_uri('../../usanetwork/modules/custom/usanetwork_social/images/chatter_icon_red_16x16.gif')).'"; ';

		// TWEETS SECTION
    $showTwitter = isset($node->field_homepage_show_twitter_page[$lang][0]['value']) ? $node->field_homepage_show_twitter_page[$lang][0]['value'] : 0 ;
    if ($showTwitter) {
      $eql = isset($node->field_homepage_twitter_eql_templ[$lang][0]['value']) ? $node->field_homepage_twitter_eql_templ[$lang][0]['value'] : '';
      $eql = empty($eql) ? variable_get('usanetwork_social_twitter_echo_query_template', '') : $eql;

      $tokens = array();
      $tokens['[CHILDRENOF]'] = isset($node->field_homepage_twitter_childrnof[$lang][0]['value']) ? $node->field_homepage_twitter_childrnof[$lang][0]['value'] : '';
      $tokens['[SHOW]'] = isset($node->field_homepage_twitter_show[$lang][0]['value']) ? $node->field_homepage_twitter_show[$lang][0]['value'] : '';
      $tokens['[FEED]'] = isset($node->field_homepage_twitter_feed[$lang][0]['value']) ? $node->field_homepage_twitter_feed[$lang][0]['value'] : '';
      $tokens['[STATE]'] = isset($node->field_homepage_twitter_state[$lang][0]['value']) ? $node->field_homepage_twitter_state[$lang][0]['value'] : '';
      $tokens['[SOURCE]'] = isset($node->field_homepage_twitter_source[$lang][0]['value']) ? $node->field_homepage_twitter_source[$lang][0]['value'] : '';
      $tokens['[MARKERS]'] = isset($node->field_homepage_twitter_markers[$lang][0]['value']) ? $node->field_homepage_twitter_markers[$lang][0]['value'] : '';
      $tokens['[TAGS]'] = isset($node->field_homepage_twitter_tags[$lang][0]['value']) ? $node->field_homepage_twitter_tags[$lang][0]['value'] : '';
      $tokens['[SORTORDER]'] = isset($node->field_homepage_twitter_sortorder[$lang][0]['value']) ? $node->field_homepage_twitter_sortorder[$lang][0]['value'] : '';
      $tokens['[SAFEHTML]'] = isset($node->field_homepage_twitter_safehtml[$lang][0]['value']) ? $node->field_homepage_twitter_safehtml[$lang][0]['value'] : '';
      $tokens['[ITEMSPERPAGE]'] = 'itemsPerPage:' . $items_per_page; // isset($node->field_homepage_twitter_itemsperp[$lang][0]['value']) ? $node->field_homepage_twitter_itemsperp[$lang][0]['value'] : '';
      $tokens['[CHILDREN]'] = isset($node->field_homepage_twitter_children[$lang][0]['value']) ? $node->field_homepage_twitter_children[$lang][0]['value'] : '';

      $eql = str_replace(array_keys($tokens), array_values($tokens), $eql);
      $echoAppKey = variable_get('usanetwork_social_twitter_echo_app_key', '');

      // @TODO: SHOULD WE PULL IN TWITTER ECHO APP KEY, ETC? IF NOT, SHOULD WE MOVE ECHO APP KEY TO A MORE GLOBAL LOCATION AND HAVE JUST ONE OF THEM?
      $vars .= 'var twitterEQL = "' . $eql . '"; ';
      $found_social_icons[] = 'showTwitter';
    }
    else {
      $vars .= 'var twitterEQL = ""; ';
    }

    // FACEBOOK SECTION
    $showFacebook = isset($node->field_show_fb_page[$lang][0]['value']) ? $node->field_show_fb_page[$lang][0]['value'] : 0 ;
    if ($showFacebook) {
      $eql = isset($node->field_fb_eql_template[$lang][0]['value']) ? $node->field_fb_eql_template[$lang][0]['value'] : '';
      $eql = empty($eql) ? variable_get('usanetwork_social_facebook_echo_query_template', '') : $eql;

      $tokens = array();
      $tokens['[CHILDRENOF]'] = isset($node->field_fb_childrenof[$lang][0]['value']) ? $node->field_fb_childrenof[$lang][0]['value'] : '';
      $tokens['[SHOW]'] = isset($node->field_fb_show[$lang][0]['value']) ? $node->field_fb_show[$lang][0]['value'] : '';
      $tokens['[FEED]'] = isset($node->field_fb_feed[$lang][0]['value']) ? $node->field_fb_feed[$lang][0]['value'] : '';
      $tokens['[STATE]'] = isset($node->field_fb_state[$lang][0]['value']) ? $node->field_fb_state[$lang][0]['value'] : '';
      $tokens['[SOURCE]'] = isset($node->field_fb_source[$lang][0]['value']) ? $node->field_fb_source[$lang][0]['value'] : '';
      $tokens['[MARKERS]'] = isset($node->field_fb_markers[$lang][0]['value']) ? $node->field_fb_markers[$lang][0]['value'] : '';
      $tokens['[TAGS]'] = isset($node->field_fb_tags[$lang][0]['value']) ? $node->field_fb_tags[$lang][0]['value'] : '';
      $tokens['[SORTORDER]'] = isset($node->field_fb_sortorder[$lang][0]['value']) ? $node->field_fb_sortorder[$lang][0]['value'] : '';
      $tokens['[SAFEHTML]'] = isset($node->field_fb_safehtml[$lang][0]['value']) ? $node->field_fb_safehtml[$lang][0]['value'] : '';
      $tokens['[ITEMSPERPAGE]'] = 'itemsPerPage:' . $items_per_page; // isset($node->field_fb_itemsperpage[$lang][0]['value']) ? $node->field_fb_itemsperpage[$lang][0]['value'] : '';
      $tokens['[CHILDREN]'] = isset($node->field_fb_children[$lang][0]['value']) ? $node->field_fb_children[$lang][0]['value'] : '';

      $eql = str_replace(array_keys($tokens), array_values($tokens), $eql);
      $echoAppKey = variable_get('usanetwork_social_facebook_echo_app_key', '');

      // @TODO: SHOULD WE PULL IN FACEBOOK ECHO APP KEY, ETC? IF NOT, SHOULD WE MOVE ECHO APP KEY TO A MORE GLOBAL LOCATION AND HAVE JUST ONE OF THEM?
      $vars .= 'var facebookEQL = "' . $eql . '"; ';
      $found_social_icons[] = 'showFacebook';
    }
    else {
      $vars .= 'var facebookEQL = ""; ';
    }

    // PINTEREST SECTION
    $showPinterest = isset($node->field_show_pinterest_page[$lang][0]['value']) ? $node->field_show_pinterest_page[$lang][0]['value'] : 0 ;
    if ($showPinterest) {
      $pinterestUrl = isset($node->field_pinterest_url[$lang][0]['value']) ? $node->field_pinterest_url[$lang][0]['value'] : '';
      $pinterestUrl = empty($pinterestUrl) ? variable_get('usanetwork_social_pinterest_url', '') : $pinterestUrl;

      $vars .= 'var pinterestUrl = "' . $pinterestUrl . '"; ';
      $found_social_icons[] = 'showPinterest';
    }
    else {
      $vars .= 'var pinterestUrl = ""; ';
    }

    // GETGLUE SECTION
    $showGetGlue = isset($node->field_show_getglue[$lang][0]['value']) ? $node->field_show_getglue[$lang][0]['value'] : 0 ;
    if ($showGetGlue) {
      $getGlueShow = isset($node->field_getglue_show[$lang][0]['value']) ? $node->field_getglue_show[$lang][0]['value'] : '';
      $getGlueShow = empty($getGlueShow) ? variable_get('usanetwork_social_getglue_show', '') : $getGlueShow;
      $getGlueSticker = isset($node->field_getglue_sticker_name[$lang][0]['value']) ? $node->field_getglue_sticker_name[$lang][0]['value'] : '';
  //    $getGlueUrl = 'http://getglue.com/tv_shows/' . $getGlueShow . '/' .$getGlueSticker;
      $getGlueUrl = 'http://getglue.com/tv_shows/' . $getGlueShow;

      $vars .= 'var getGlueUrl = "' . $getGlueUrl . '"; ';
      $vars .= 'var getGlueShowName = "' . $getGlueShow . '"; '; // $showName . '"; ';
      $found_social_icons[] = 'showGetGlue';
    }
    else {
      $vars .= 'var getGlueUrl = ""; ';
      $vars .= 'var getGlueShowName = ""; '; // $showName . '"; ';
    }

    // INSTAGRAM SECTION
    $showInstagram = isset($node->field_show_instagram_page[$lang][0]['value']) ? $node->field_show_instagram_page[$lang][0]['value'] : 0 ;
    if ($showInstagram) {
      $instagramShowId = isset($node->field_instagram_show_id[$lang][0]['value']) ? $node->field_instagram_show_id[$lang][0]['value'] : '';
      $instagramShowId = empty($instagramShowId) ? variable_get('usanetwork_social_instagram_show_id', '') : $instagramShowId;

      $vars .= 'var instagramShowId = "' . $instagramShowId . '"; ';
      $found_social_icons[] = 'showInstagram';
    }
    else {
      $vars .= 'var instagramShowId = ""; ';
    }

    if (empty($found_social_icons)) {
      return "";
    }

    drupal_add_js($vars, array('type' => 'inline'));

    drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/jquery-plugins.js', 'external');
    drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/stream.js', 'external');
  //  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/show-homepage-social-chatter.js');
    drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/plugins/twitter-intents.js');
//    drupal_add_js('http://cdn.realtidbits.com/libs/v1/inlinemedia.js');
    drupal_add_js('http://cdn.echoenabled.com/sdk/v3/loader.js', 'external');
    drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/fbimages.plugin.js');
    drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/links.plugin.js');
    drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/switch.js');

    $output .= '<div id="usanetwork_social_show_homepage_chatter"><div id="usanetwork_social_chatter_title">';
    if ($showTwitter) {
      $output .= '<a id="navTwitter" href="#navTwitter"><span class="navTwitter">Tweets</span></a><span class="navSocial-empty-span"></span>';
    }
    if ($showChatPage) {
      $output .= '<a id="navChatter" href="#navChatter"><span class="navChatter">Character Chatter</span></a><span class="navSocial-empty-span"></span>';
    }
    if ($showFacebook) {
      $output .= '<a id="navFb" href="#navFb"><span class="navFb">FB</span></a><span class="navSocial-empty-span"></span>';
    }
    if ($showPinterest) {
      $output .= '<a id="navPinterest" href="#navPinterest"><span class="navPinterest">Pinterest</span></a><span class="navSocial-empty-span"></span>';
    }
    if ($showGetGlue) {
      $output .= '<a id="navGetGlue" href="#navGetGlue"><span class="navGetGlue">GetGlue</span></a><span class="navSocial-empty-span"></span>';
    }
    if ($showInstagram) {
      $output .= '<a id="navInstagram" href="#navInstagram"><span class="navInstagram">Instagram</span></a>';
    }
    $output .= '</div></div>';

        /*<div id="usanetwork_social_chatter_body">
          <a href="'.$showBaseUrl.'/social/chat-with-fans">
            <div id="usanetwork_social_show_comment"></div>
            <div id="usanetwork_social_join"><span class="usanetwork_social_pointer_image"></span><span class="usanetwork_social_join_msg">join the conversation</span></div>
          </a>
        </div>*/
    $output .= '<div id="echo-stream">&nbsp;</div>';
    $output .= '<div id="pinterest" class="widget-background"></div>';
    $output .= '<div id="get-glue" class="widget-background"><div id="sticker" style="padding-top:20px"></div></div>';
    $output .= '<div id="instagram" class="widget-background"></div>';
    $output .= '<div id="usanetwork_social_section_join">';
    $output .= '<span id="join-tweets">Check out more tweets<span class="usanetwork_social_join_msg" style="margin-left:15px;top:4px;"></span></span>';
    $output .= '<span id="join-chatter">Go chat with fans<span class="usanetwork_social_join_msg" style="margin-left:15px;top:4px;"></span></span>';
    $output .= '<span id="join-buzz">Get more social buzz<span class="usanetwork_social_join_msg" style="margin-left:15px;top:4px;"></span></span>';
    $output .= '<span class="usanetwork_social_pointer_image"></span>';
    $output .= '</div>';
    return $output;
  }
}

/**
 * Generate the show landing rebelmouse social block on the show homepage
 */
function usanetwork_social_show_landing_rebelmouse() {
  if (path_is_admin(current_path())) {
    return;
  }
  $output = '';
  $menu_object = _usanetwork_menu_get_object();
  if ($menu_object) {
    $output = usanetwork_social_trending($menu_object);
  }
   
  return $output;
}

  /**
  * Global social menu access callback
  */
function usanetwork_social_global_menu_access($node) {
  return user_access('access content');
}

  /**
  * Social menu access callback to restrict only tv_show nodes
  */
function usanetwork_social_menu_access($node) {
  return $node->type == 'tv_show' && user_access('access content');
}

  /**
  * Implements hook_form_FORM_ID_alter().
  */
function usanetwork_social_form_node_form_alter(&$form, &$form_state) {
  $lang = LANGUAGE_NONE;

  if ($form['type']['#value'] == 'tv_show') {
    // set the sitewide values as default values for each show

    // TWITTER
    // eql template
    if (!isset($form['field_twitter_eql_template'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_eql_template'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_eql_template'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_echo_query_template', '');
    }
    // childrenof
    if (!isset($form['field_twitter_childrenof'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_childrenof'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_childrenof'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_childrenof', '');
    }
    // feed
    if (!isset($form['field_twitter_feed'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_feed'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_feed'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_feed', '');
    }
    // state
    if (!isset($form['field_twitter_state'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_state'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_state'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_state', '');
    }
    // source
    if (!isset($form['field_twitter_source'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_source'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_source'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_source', '');
    }
    // markers
    if (!isset($form['field_twitter_markers'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_markers'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_markers'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_markers', '');
    }
    // tags
    if (!isset($form['field_twitter_tags'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_tags'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_tags'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_tags', '');
    }
    // sortorder
    if (!isset($form['field_twitter_sortorder'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_sortorder'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_sortorder'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_sortorder', '');
    }
    // safehtml
    if (!isset($form['field_twitter_safehtml'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_safehtml'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_safehtml'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_safehtml', '');
    }
    // itemsperpage
    if (!isset($form['field_twitter_itemsperpage'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_itemsperpage'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_itemsperpage'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_itemsperpage', '');
    }
    // children
    if (!isset($form['field_twitter_children'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_children'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_children'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_children', '');
    }

		// HOME PAGE TWITTER
    // eql template
    if (!isset($form['field_homepage_twitter_eql_templ'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_eql_templ'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_eql_templ'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_echo_query_template', '');
    }
    // childrenof
    if (!isset($form['field_homepage_twitter_childrnof'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_childrnof'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_childrnof'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_childrenof', '');
    }
    // feed
    if (!isset($form['field_homepage_twitter_feed'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_feed'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_feed'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_feed', '');
    }
    // state
    if (!isset($form['field_homepage_twitter_state'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_state'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_state'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_state', '');
    }
    // source
    if (!isset($form['field_homepage_twitter_source'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_source'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_source'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_source', '');
    }
    // markers
    if (!isset($form['field_homepage_twitter_markers'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_markers'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_markers'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_markers', '');
    }
    // tags
    if (!isset($form['field_homepage_twitter_tags'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_tags'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_tags'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_tags', '');
    }
    // sortorder
    if (!isset($form['field_homepage_twitter_sortorder'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_sortorder'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_sortorder'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_sortorder', '');
    }
    // safehtml
    if (!isset($form['field_homepage_twitter_safehtml'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_safehtml'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_safehtml'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_safehtml', '');
    }
    // itemsperpage
    if (!isset($form['field_homepage_twitter_itemsperp'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_itemsperp'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_itemsperp'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_itemsperpage', '');
    }
    // children
    if (!isset($form['field_homepage_twitter_children'][$lang][0]['value']['#default_value']) ||
      empty($form['field_homepage_twitter_children'][$lang][0]['value']['#default_value'])) {
      $form['field_homepage_twitter_children'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_children', '');
    }

    // FACEBOOK
    // eql template
    if (!isset($form['field_fb_eql_template'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_eql_template'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_eql_template'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_echo_query_template', '');
    }
    // childrenof
    if (!isset($form['field_fb_childrenof'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_childrenof'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_childrenof'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_childrenof', '');
    }
    // feed
    if (!isset($form['field_fb_feed'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_feed'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_feed'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_feed', '');
    }
    // state
    if (!isset($form['field_fb_state'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_state'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_state'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_state', '');
    }
    // source
    if (!isset($form['field_fb_source'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_source'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_source'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_source', '');
    }
    // markers
    if (!isset($form['field_fb_markers'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_markers'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_markers'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_markers', '');
    }
    // tags
    if (!isset($form['field_fb_tags'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_tags'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_tags'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_tags', '');
    }
    // sortorder
    if (!isset($form['field_fb_sortorder'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_sortorder'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_sortorder'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_sortorder', '');
    }
    // safehtml
    if (!isset($form['field_fb_safehtml'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_safehtml'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_safehtml'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_safehtml', '');
    }
    // itemsperpage
    if (!isset($form['field_fb_itemsperpage'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_itemsperpage'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_itemsperpage'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_itemsperpage', '');
    }
    // children
    if (!isset($form['field_fb_children'][$lang][0]['value']['#default_value']) ||
      empty($form['field_fb_children'][$lang][0]['value']['#default_value'])) {
      $form['field_fb_children'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_facebook_children', '');
    }

    // PINTEREST
    // pinterest url
    if (!isset($form['field_pinterest_url'][$lang][0]['value']['#default_value']) ||
      empty($form['field_pinterest_url'][$lang][0]['value']['#default_value'])) {
      $form['field_pinterest_url'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_pinterest_url', '');
    }

    // GETGLUE
    // pinterest url
    if (!isset($form['field_getglue_show'][$lang][0]['value']['#default_value']) ||
      empty($form['field_getglue_show'][$lang][0]['value']['#default_value'])) {
      $form['field_getglue_show'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_getglue_show', '');
    }

    // CHAT WITH FANS
    // eql template
    if (!isset($form['field_chat_eql_template'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_eql_template'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_eql_template'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_echo_query_template', '');
    }
    // childrenof
    if (!isset($form['field_chat_childrenof'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_childrenof'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_childrenof'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_childrenof', '');
    }
    // feed
    if (!isset($form['field_chat_feed'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_feed'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_feed'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_feed', '');
    }
    // state
    if (!isset($form['field_chat_state'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_state'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_state'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_state', '');
    }
    // source
    if (!isset($form['field_chat_source'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_source'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_source'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_source', '');
    }
    // markers
    if (!isset($form['field_chat_markers'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_markers'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_markers'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_markers', '');
    }
    // tags
    if (!isset($form['field_chat_tags'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_tags'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_tags'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_tags', '');
    }
    // sortorder
    if (!isset($form['field_chat_sortorder'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_sortorder'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_sortorder'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_sortorder', '');
    }
    // safehtml
    if (!isset($form['field_chat_safehtml'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_safehtml'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_safehtml'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_safehtml', '');
    }
    // itemsperpage
    if (!isset($form['field_chat_itemsperpage'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_itemsperpage'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_itemsperpage'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_itemsperpage', '');
    }
    // children
    if (!isset($form['field_chat_children'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_children'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_children'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_children', '');
    }
    // submitTargetUrl
    if (!isset($form['field_chat_submittargeturl'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_submittargeturl'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_submittargeturl'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_submittargeturl', '');
    }
    // identityManagerUrl
    if (!isset($form['field_chat_identitymanagerurl'][$lang][0]['value']['#default_value']) ||
      empty($form['field_chat_identitymanagerurl'][$lang][0]['value']['#default_value'])) {
      $form['field_chat_identitymanagerurl'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_chat_identitymanagerurl', '');
    }

    // SOCIAL BUZZ
    // baseUrl
    if (!isset($form['field_trend_base_url'][$lang][0]['value']['#default_value']) ||
      empty($form['field_trend_base_url'][$lang][0]['value']['#default_value'])) {
      $form['field_trend_base_url'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_trend_base_url', '');
    }
    // urlParams
    if (!isset($form['field_trend_url_params'][$lang][0]['value']['#default_value']) ||
      empty($form['field_trend_url_params'][$lang][0]['value']['#default_value'])) {
      $form['field_trend_url_params'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_trend_url_params', '');
    }

    // SYNC
    // desktopUrl
    if (!isset($form['field_sync_desktop_url'][$lang][0]['value']['#default_value']) ||
      empty($form['field_sync_desktop_url'][$lang][0]['value']['#default_value'])) {
      $form['field_sync_desktop_url'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_sync_desktop_url', '');
    }
    // phoneUrl
    if (!isset($form['field_sync_phone_url'][$lang][0]['value']['#default_value']) ||
      empty($form['field_sync_phone_url'][$lang][0]['value']['#default_value'])) {
      $form['field_sync_phone_url'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_sync_phone_url', '');
    }
  }
}

  /**
  * Local function for getting all published TV shows sorted alphabetically
  */
function _usanetwork_social_show_nids() {
  $show_nids = array();
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node');
  $query->entityCondition('bundle', array('tv_show'));
  $query->propertyCondition('status', 1);
  $query->propertyOrderBy('title', 'ASC');
  $query->range(0, 100);
  // execute the query
  $result = $query->execute();
  if (!empty($result['node'])) {
    $show_nids = array_keys($result['node']);
  }
  return $show_nids;
}

  /**
  * Menu callback of social global landing page
  */
function usanetwork_social_global_landing_page() {
  drupal_goto('social/trending');
}

  /**
  * Menu callback of social global social buzz (aka trending or latest) page
  */
function usanetwork_social_global_trending() {
  $output = '';
  drupal_set_title('Social Dashboard');
  $showTrending = variable_get('usanetwork_social_trend_show_global');
  $baseUrl = variable_get('usanetwork_social_trend_global_base_url');
  $basePath = variable_get('usanetwork_social_trend_global_base_path');
  $currentUrl = $GLOBALS['base_url'].'/'.request_path();
  $urlParams = variable_get('usanetwork_social_trend_global_url_params').'&referrer=http://'.$currentUrl;

  $query = $baseUrl.'/'.$basePath.'/?'.$urlParams;

  $output .= '<div class="usa-rebelmouse"><iframe src="'.$query.'" width="100%" scrolling="auto" height="500" frameborder="0"></iframe></div>';

  return $output;
}

  /**
  * Menu callback for social global chat with fans page
  */
function usanetwork_social_global_chat_with_fans() {
  $lang = LANGUAGE_NONE;
  $showInfo = array();
  $shows = _usanetwork_social_show_nids();
  drupal_set_title('Social Dashboard');

  if (is_array($shows) && !empty($shows)) {
    $nodes = node_load_multiple($shows);
    foreach ($nodes as $node) {
      $showChatPage = isset($node->field_show_chat_page[$lang][0]['value']) ? $node->field_show_chat_page[$lang][0]['value'] : 0;
      $showTokenName = isset($node->field_chat_show[$lang][0]['value']) ? $node->field_chat_show[$lang][0]['value'] : 0;
      $showAlias = drupal_get_path_alias('node/'.$node->nid);
      $showUrl = (!empty($showAlias)) ? $showAlias : 'node/'.$node->nid;
      if ($showChatPage && $showTokenName) {
        $showInfo[] = array(
          'title' => $node->title,
          'showTokenName' => $showTokenName,
          'showUrl' => $showUrl
        );
      }
    }
  }

  $output = '
    <div id="globalChatWithFans">
      <div>Join the Conversation: </div>
      <div id="showList"></div>
    </div>
    ';

  if (count($showInfo) > 0) {
    // jquery.xdomainrequest.min.js is needed to fix an IE9 jQuery POST, cross-domain (CORS) problem
    drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/jquery.xdomainrequest.min.js');
    $showArrayVar = '';
    $query = 'http://api.echoenabled.com/v2/mux';
    $queryParams = '';
    foreach ($showInfo as $array)
    {
      $showArrayVar .= '"'.$array['showTokenName'].'":["'.$array['title'].'", "'.$array['showUrl'].'"], ';
//      $queryParams .= '{"id":"search_'.$array['showTokenName'].'","method":"search","q":"(childrenof:http://chatter.usanetwork.com/'.$array['showTokenName'].'/public/comments -state:ModeratorDeleted,ModeratorFlagged,SystemFlagged,CommunityFlagged -user.state:ModeratorBanned) sortOrder:reverseChronological safeHTML:true itemsPerPage:1 children:0"},';
      $queryParams .= '{"id":"search_'.$array['showTokenName'].'","method":"search","q":"(childrenof:http://chatter.usanetwork.com/'.$array['showTokenName'].'/public/comments state:Untouched,ModeratorApproved -user.state:ModeratorBanned) itemsPerPage:1 children:0"},';
    }
    $showArrayVar = substr($showArrayVar, 0, -1);
    $queryParams = urlencode(substr($queryParams, 0, -1));
    $queryParams = 'appkey=prod.usanetwork&requests=['.$queryParams .']&callback=?';
    $queryStr = $query.'?'.$queryParams;

    $vars = 'var echoQuery="'.$query.'"; ';
    $vars .= 'var echoQueryParams = "'.$queryParams.'"; ';
    $vars .= 'var showArray = {'.$showArrayVar.'}; ';
    drupal_add_js($vars, array('type' => 'inline'));
    drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/global-chat-with-fans.js');
  }
  else
  {
    $output = str_replace('<div id="showList"></div>', '<div id="showList">No shows found. Please come back again soon.</div>', $output);
  }
  return $output;
}

  /**
  * Menu callback of social global twitter page
  */
function usanetwork_social_global_twitter() {
  $output = '';
  drupal_set_title('Social Dashboard');

  $tokens = array();

  $tokens['[CHILDRENOF]'] = variable_get('usanetwork_social_twitter_childrenof', '');
  $tokens['[FEED]'] = variable_get('usanetwork_social_twitter_feed', '');
  $tokens['[STATE]'] = variable_get('usanetwork_social_twitter_state', '');
  $tokens['[SOURCE]'] = variable_get('usanetwork_social_twitter_source', '');
  $tokens['[MARKERS]'] = variable_get('usanetwork_social_twitter_markers', '');
  $tokens['[TAGS]'] = variable_get('usanetwork_social_twitter_tags', '');
  $tokens['[SORTORDER]'] = variable_get('usanetwork_social_twitter_sortorder', '');
  $tokens['[SAFEHTML]'] = variable_get('usanetwork_social_twitter_safehtml', '');
  $tokens['[ITEMSPERPAGE]'] = variable_get('usanetwork_social_twitter_itemsperpage', '');
  $tokens['[CHILDREN]'] = variable_get('usanetwork_social_twitter_children', '');

  $tokens['[PATH]'] = variable_get('usanetwork_social_global_twitter_path', '');

  // eql template
  $eql_template = variable_get('usanetwork_social_global_twitter_echo_query_template', '');

  $eql = str_replace(array_keys($tokens), array_values($tokens), $eql_template);
  $echoAppKey = variable_get('usanetwork_social_twitter_echo_app_key', '');

  $vars = 'var echoAppKey = "' . $echoAppKey . '";';
  $vars .= 'var twitterEQL = "' . $eql . '"';
  drupal_add_js($vars, array('type' => 'inline'));

  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/jquery-plugins.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/stream.js');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/plugins/twitter-intents.js');
//  drupal_add_js('http://cdn.realtidbits.com/libs/v1/inlinemedia.js');
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/fbimages.plugin.js');
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/links.plugin.js');
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/twitter-page.js');

  $output .= '<div id="echo-stream">&nbsp;</div>';

  return $output;
}

  /**
  * Menu callback of social global sync page
  */
function usanetwork_social_global_sync() {
  drupal_set_title('Social Dashboard');
  $showSync = variable_get('usanetwork_social_sync_show_global');

  if ($showSync) {
    $desktopUrl = variable_get('usanetwork_social_sync_global_desktop_url');
    
    $phoneUrl = variable_get('usanetwork_social_sync_global_phone_url');

    $vars = 'var desktopUrl = "'.$desktopUrl.'";';
    $vars .= 'var phoneUrl = "'.$phoneUrl.'";';
    drupal_add_js($vars, array('type' => 'inline'));
    drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/sync.js');

    $output = '<div id="sync"><iframe id="syncIframe" width="100%" scrolling="no" align="top" height="806" frameborder="0" seamless="seamless" marginwidth="0" marginheight="0" src="" name="syncIframe"></iframe></div>';

    return $output;
  } else {
    $not_found_url = variable_get('site_404');
    drupal_goto($not_found_url);
  }
}

  /**
  * Menu callback of tv show social landing page
  */
function usanetwork_social_landing_page($node) {
  drupal_goto(drupal_get_path_alias('node/'.arg(1).'/social/latest'));
}

  /**
  * Menu callback of tv show social twitter page
  */
function usanetwork_social_twitter($node) {
  $output = '';
  $lang = LANGUAGE_NONE;

  if (!isset($node->nid)) {
    drupal_not_found();
  }

  // check if the show twitter page flag is enabled
  $showTwitter = isset($node->field_show_twitter_page[$lang][0]['value']) ? $node->field_show_twitter_page[$lang][0]['value'] : 0 ;
  if (!$showTwitter) {
    drupal_goto('node/'.$node->nid.'/social');
  }

  $eql = isset($node->field_twitter_eql_template[$lang][0]['value']) ? $node->field_twitter_eql_template[$lang][0]['value'] : '';
  $eql = empty($eql) ? variable_get('usanetwork_social_twitter_echo_query_template', '') : $eql;

  // if EQL is empty, show social landing page
  if (empty($eql)) {
    drupal_goto('node/'.$node->nid.'/social');
  }

  $tokens = array();

  $tokens['[CHILDRENOF]'] = isset($node->field_twitter_childrenof[$lang][0]['value']) ? $node->field_twitter_childrenof[$lang][0]['value'] : '';
  $tokens['[SHOW]'] = isset($node->field_twitter_show[$lang][0]['value']) ? $node->field_twitter_show[$lang][0]['value'] : '';
  $tokens['[FEED]'] = isset($node->field_twitter_feed[$lang][0]['value']) ? $node->field_twitter_feed[$lang][0]['value'] : '';
  $tokens['[STATE]'] = isset($node->field_twitter_state[$lang][0]['value']) ? $node->field_twitter_state[$lang][0]['value'] : '';
  $tokens['[SOURCE]'] = isset($node->field_twitter_source[$lang][0]['value']) ? $node->field_twitter_source[$lang][0]['value'] : '';
  $tokens['[MARKERS]'] = isset($node->field_twitter_markers[$lang][0]['value']) ? $node->field_twitter_markers[$lang][0]['value'] : '';
  $tokens['[TAGS]'] = isset($node->field_twitter_tags[$lang][0]['value']) ? $node->field_twitter_tags[$lang][0]['value'] : '';
  $tokens['[SORTORDER]'] = isset($node->field_twitter_sortorder[$lang][0]['value']) ? $node->field_twitter_sortorder[$lang][0]['value'] : '';
  $tokens['[SAFEHTML]'] = isset($node->field_twitter_safehtml[$lang][0]['value']) ? $node->field_twitter_safehtml[$lang][0]['value'] : '';
  $tokens['[ITEMSPERPAGE]'] = isset($node->field_twitter_itemsperpage[$lang][0]['value']) ? $node->field_twitter_itemsperpage[$lang][0]['value'] : '';
  $tokens['[CHILDREN]'] = isset($node->field_twitter_children[$lang][0]['value']) ? $node->field_twitter_children[$lang][0]['value'] : '';

  $eql = str_replace(array_keys($tokens), array_values($tokens), $eql);
  $echoAppKey = variable_get('usanetwork_social_twitter_echo_app_key', '');


  $vars = 'var echoAppKey = "' . $echoAppKey . '";';
  $vars .= 'var twitterEQL = "' . $eql . '"';
  drupal_add_js($vars, array('type' => 'inline'));

  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/jquery-plugins.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/stream.js');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/plugins/twitter-intents.js');
//  drupal_add_js('http://cdn.realtidbits.com/libs/v1/inlinemedia.js');
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/fbimages.plugin.js');
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/links.plugin.js');
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/twitter-page.js');

  $output .= '<div id="echo-stream">&nbsp;</div>';

  return $output;
}

  /**
  * Menu callback of tv show social sync page
  */
function usanetwork_social_sync($node) {
  $lang = LANGUAGE_NONE;

  $showSync = isset($node->field_show_sync[$lang][0]['value']) ? $node->field_show_sync[$lang][0]['value'] : 0;
  $desktopUrl = !empty($node->field_sync_desktop_url[$lang][0]['value']) ? $node->field_sync_desktop_url[$lang][0]['value'] : 0;
  $phoneUrl = !empty($node->field_sync_phone_url[$lang][0]['value']) ? $node->field_sync_phone_url[$lang][0]['value'] : 0;

  if (!$showSync || !$desktopUrl || !$phoneUrl) { 
//    drupal_goto('social/sync');
    $not_found_url = variable_get('site_404');
    drupal_goto($not_found_url);
  }

  $vars = 'var desktopUrl = "'.$desktopUrl.'";';
  $vars .= 'var phoneUrl = "'.$phoneUrl.'";';
  drupal_add_js($vars, array('type' => 'inline'));

  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/sync.js');

  $output = '<div id="sync"><iframe id="syncIframe" width="100%" scrolling="no" align="top" height="806" frameborder="0" seamless="seamless" marginwidth="0" marginheight="0" src="" name="syncIframe"></iframe></div>';

  return $output;
}


  /**
  * Menu callback of tv show social chat with fans page
  */
function usanetwork_social_chat_with_fans($node) {
  $output = '';
  $lang = LANGUAGE_NONE;

  if (!isset($node->nid)) {
    drupal_not_found();
  }

  $showChatWithFansPage = isset($node->field_show_chat_page[$lang][0]['value']) ? $node->field_show_chat_page[$lang][0]['value'] : 0;
  $showChatWithFansPostComments = isset($node->field_show_chat_post_comment[$lang][0]['value']) ? $node->field_show_chat_post_comment[$lang][0]['value'] : 0;

  $eql = isset($node->field_chat_eql_template[$lang][0]['value']) ? $node->field_chat_eql_template[$lang][0]['value'] : '';
  $eql = empty($eql) ? variable_get('usanetwork_social_chat_echo_query_template', '') : $eql;

  $submitTargetUrl = isset($node->field_chat_submittargeturl[$lang][0]['value']) ? $node->field_chat_submittargeturl[$lang][0]['value'] : '';
  $submitTargetUrl = empty($submitTargetUrl) ? variable_get('usanetwork_social_chat_submittargeturl', '') : $submitTargetUrl;

  $identityManagerUrl = isset($node->field_chat_identitymanagerurl[$lang][0]['value']) ? $node->field_chat_identitymanagerurl[$lang][0]['value'] : '';
  $identityManagerUrl = empty($identityManagerUrl) ? variable_get('usanetwork_social_chat_identitymanagerurl', '') : $identityManagerUrl;

  $showAlias = drupal_get_path_alias('node/'.$node->nid);
  $showBaseUrl = (!empty($showAlias)) ? $showAlias : 'node/'.$node->nid;

  // if EQL is empty or show Chat with Fans checkbox is not checked, show social landing page
  if (empty($eql) || $showChatWithFansPage != 1) {
    drupal_goto($showBaseUrl.'/social');
  }

  // chat-with-fans settings
  $tokens = array();

  $tokens['[CHILDRENOF]'] = isset($node->field_chat_childrenof[$lang][0]['value']) ? $node->field_chat_childrenof[$lang][0]['value'] : '';
  $tokens['[SHOW]'] = isset($node->field_chat_show[$lang][0]['value']) ? $node->field_chat_show[$lang][0]['value'] : '';
  $tokens['[FEED]'] = isset($node->field_chat_feed[$lang][0]['value']) ? $node->field_chat_feed[$lang][0]['value'] : '';
  $tokens['[STATE]'] = isset($node->field_chat_state[$lang][0]['value']) ? $node->field_chat_state[$lang][0]['value'] : '';
  $tokens['[SOURCE]'] = isset($node->field_chat_source[$lang][0]['value']) ? $node->field_chat_source[$lang][0]['value'] : '';
  $tokens['[MARKERS]'] = isset($node->field_chat_markers[$lang][0]['value']) ? $node->field_chat_markers[$lang][0]['value'] : '';
  $tokens['[TAGS]'] = isset($node->field_chat_tags[$lang][0]['value']) ? $node->field_chat_tags[$lang][0]['value'] : '';
  $tokens['[SORTORDER]'] = isset($node->field_chat_sortorder[$lang][0]['value']) ? $node->field_chat_sortorder[$lang][0]['value'] : '';
  $tokens['[SAFEHTML]'] = isset($node->field_chat_safehtml[$lang][0]['value']) ? $node->field_chat_safehtml[$lang][0]['value'] : '';
  $tokens['[ITEMSPERPAGE]'] = isset($node->field_chat_itemsperpage[$lang][0]['value']) ? $node->field_chat_itemsperpage[$lang][0]['value'] : '';
  $tokens['[CHILDREN]'] = isset($node->field_chat_children[$lang][0]['value']) ? $node->field_chat_children[$lang][0]['value'] : '';

  $eql = str_replace(array_keys($tokens), array_values($tokens), $eql);
  $submitTargetUrl = str_replace(array_keys($tokens), array_values($tokens), $submitTargetUrl);
  $echoAppKey = variable_get('usanetwork_social_chat_echo_app_key', '');
  $personalizationEnabled = (module_exists('usanetwork_personalization')) ? 1 : 0;

  $vars = 'var echoAppKey = "' . $echoAppKey . '"; ';
  $vars .= 'var chatWithFansEQL = "' . $eql . '"; ';
  $vars .= 'var chatSubmitTargetURL = "' . $submitTargetUrl . '"; ';
  $vars .= 'var chatIdentityManagerURL = "' . $identityManagerUrl . '"; ';
  $vars .= 'var chatShowPostComments = "' . $showChatWithFansPostComments . '"; ';
  $vars .= 'var chatterSourceIcon = "'.file_create_url(file_build_uri('../../usanetwork/modules/custom/usanetwork_social/images/chatter_icon_red_16x16.gif')).'"; ';
  $vars .= 'var defaultAvatar = "/' . drupal_get_path('module', 'usanetwork_personalization') . '/images/default_avatar_125x125.jpg"; ';
  $vars .= 'var personalizationEnabled = '.$personalizationEnabled.'; ';


  // chatterToTv settings
  $displayChatterToTv = isset($node->field_show_chatter_to_tv[$lang][0]['value']) ? $node->field_show_chatter_to_tv[$lang][0]['value'] : 0;
  $chatterToTvStartTime = isset($node->field_chat_to_tv_start_time[$lang][0]['value']) ? $node->field_chat_to_tv_start_time[$lang][0]['value'] : 0;
  $chatterToTvEndTime = isset($node->field_chat_to_tv_end_time[$lang][0]['value']) ? $node->field_chat_to_tv_end_time[$lang][0]['value'] : 0;
  $now = strtotime(date("M d Y H:i:s"));
  $showChatterToTv = 0;
  if ($displayChatterToTv && $chatterToTvStartTime <= $now && $now <= $chatterToTvEndTime)
  {
    $showChatterToTv = 1;
  }
  $chatterToTvTitle = isset($node->field_chat_to_tv_title[$lang][0]['value']) ? $node->field_chat_to_tv_title[$lang][0]['value'] : '';
  $chatterToTvDescription = isset($node->field_chat_to_tv_description[$lang][0]['value']) ? $node->field_chat_to_tv_description[$lang][0]['value'] : '';
  $chatterToTvCheckboxText = isset($node->field_chat_to_tv_checkbox_text[$lang][0]['value']) ? $node->field_chat_to_tv_checkbox_text[$lang][0]['value'] : '';
  $chatterToTvLegalCopy = isset($node->field_chat_to_tv_legal_copy[$lang][0]['value']) ? $node->field_chat_to_tv_legal_copy[$lang][0]['value'] : '';
  $chatterToTvEchoMarker = isset($node->field_chat_to_tv_echo_marker[$lang][0]['value']) ? $node->field_chat_to_tv_echo_marker[$lang][0]['value'] : '';
  $chatterToTvCommentPrefix = isset($node->field_chat_to_tv_comment_prefix[$lang][0]['value']) ? $node->field_chat_to_tv_comment_prefix[$lang][0]['value'] : '';


  $vars .= 'var showChatterToTv = '.$showChatterToTv.'; ';
  $vars .= 'var chatterToTvTitle = "' . addslashes($chatterToTvTitle) . '"; ';
  $vars .= 'var chatterToTvDescription = "' . addslashes($chatterToTvDescription) . '"; ';
  $vars .= 'var chatterToTvCheckboxText = "' . $chatterToTvCheckboxText . '"; ';
  $vars .= 'var chatterToTvLegalCopy = "' . addslashes($chatterToTvLegalCopy) . '"; ';
  $vars .= 'var chatterToTvEchoMarker = "' . $chatterToTvEchoMarker . '"; ';
  $vars .= 'var chatterToTvCommentPrefix = "' . $chatterToTvCommentPrefix . '"; ';
  drupal_add_js($vars, array('type' => 'inline'));

  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/jquery-plugins.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/stream.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/auth.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/sdk/v3/backplane.js', 'external');
  drupal_add_js('http://characterchatter.usanetwork.com/js/metadata-tweaks-plugin.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/submit.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/counter.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/plugins/form-auth.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/plugins/community-flag.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/plugins/like.js ', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/plugins/reply.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/plugins/whirlpools.js', 'external');
  drupal_add_js('http://cdn.echoenabled.com/clientapps/v2/plugins/submit-text-counter.js', 'external');
  // if personalization is enabled, hide the login / logout links
  if ($personalizationEnabled)
  {
    drupal_add_css('#chat-submit-form .echo-auth-login, #chat-submit-form .echo-auth-logout { display:none !important }', array('type' => 'inline'));
  }
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/chat-with-fans-page.js');

  $output .= '<div id="fb-root"></div>';
  $output .= '<div id="echo-login-form" style="display:none"></div>';

  if ($displayChatterToTv && $chatterToTvStartTime <= $now && $now <= $chatterToTvEndTime) {
    $output .= '<div id="chatterToTv"></div>';
  }

  $output .= '<div id="chat-submit-form">&nbsp;</div>';
  $output .= '<div id="chat-echo-stream">&nbsp;</div>';

  return $output;
}

  /**
  * Menu callback of tv show social trending page
  */
function usanetwork_social_trending($node) {
  $output = '';
  $lang = LANGUAGE_NONE;

  $title = $node->title;
  $showTrending = !empty($node->field_show_trending[$lang][0]['value']) ? $node->field_show_trending[$lang][0]['value'] : 0;
  $baseUrl = !empty($node->field_trend_base_url[$lang][0]['value']) ? $node->field_trend_base_url[$lang][0]['value'] : null;
  $showPath = !empty($node->field_trend_show_path[$lang][0]['value']) ? $node->field_trend_show_path[$lang][0]['value'] : null;
  $currentUrl = $GLOBALS['base_url'].'/'.request_path();
  $urlParams = !empty($node->field_trend_url_params[$lang][0]['value']) ? $node->field_trend_url_params[$lang][0]['value'] . '&referrer='.$currentUrl : null;

  if (!$showTrending || !$baseUrl || !$showPath || !$urlParams) {
    drupal_goto('social/trending');
  }

  $query = $baseUrl . '/' . $showPath . '/?' . $urlParams;

  $output .= '<div class="usa-rebelmouse"><iframe src="'.$query.'" width="100%" scrolling="auto" height="500" frameborder="0"></iframe></div>';

  return $output;
}


  /**
  * Implements hook_preprocess_html()
  */
function usanetwork_social_preprocess_html(&$vars) {
  $head_title = NULL;
  $node = menu_get_object();
  // global social
  switch ($_GET['q']) {
    // Social Buzz | Social | SITE_TITLE
    case 'social':
    case 'social/trending':
      $head_title = t('Social Buzz | Social | USA Network');
      break;
    // Chatter | Social | SITE_TITLE
    case 'social/chat-with-fans':
      $head_title = t('Chatter | Social | USA Network');
      break;
    // Tweets | Social | SITE_TITLE
    case 'social/tweets':
      $head_title = t('Tweets | Social | USA Network');
      break;
    // Sync | Social | SITE_TITLE
    case 'social/sync':
      $head_title = t('Sync | Social | USA Network');
      break;

    default:
      break;
  }
  // show node social pages
  if ($node && $node->type == "tv_show" && arg(3)) {
    switch (arg(3)) {
      // Social Buzz | Social | SHOW_NAME | SITE_TITLE
      case 'latest':
        $head_title = t("Social Buzz | Social | @showname | USA Network", array('@showname' => $node->title));
        break;
      // Chatter | Social | SHOW_NAME | SITE_TITLE
      case 'chat-with-fans':
        $head_title = t("Chatter | Social | @showname | USA Network", array('@showname' => $node->title));
        break;
      // Tweets | Social | SHOW_NAME | SITE_TITLE
      case 'tweets':
        $head_title = t("Tweets | Social | @showname | USA Network", array('@showname' => $node->title));
        break;
      // Sync | Social | SHOW_NAME | SITE_TITLE
      case 'sync':
        $head_title = t("Sync | Social | @showname | USA Network", array('@showname' => $node->title));
        break;
      default:
        break;
    }
  }
  // If there are things print the things
  if (!empty($head_title)) {
    $vars['head_title'] = $head_title;
  }
}


function usanetwork_social_ago($time)
{
  $periods = array("second", "minute", "hour", "day", "week", "month", "year", "decade");
  $lengths = array("60","60","24","7","4.35","12","10");

  $now = time();

  $difference = $now - $time;
  $tense = "ago";

  for($j = 0; $difference >= $lengths[$j] && $j < count($lengths)-1; $j++) {
    $difference /= $lengths[$j];
  }

  $difference = round($difference);

  if ($difference != 1)
  {
    $periods[$j].= "s";
  }

  return "$difference $periods[$j] ago ";
}

function usanetwork_social_server_side_chatter_box($node, $numCommentsToShow=2) {
  $lang = LANGUAGE_NONE;
  $output = '';

  if (isset($node->nid)) {
    $showChatPage = isset($node->field_show_chat_page[$lang][0]['value']) ? $node->field_show_chat_page[$lang][0]['value'] : 0;
    $showTokenName = isset($node->field_chat_show[$lang][0]['value']) ? $node->field_chat_show[$lang][0]['value'] : '';
    $showAlias = drupal_get_path_alias('node/'.$node->nid);
    $showUrl = (!empty($showAlias)) ? $showAlias : 'node/'.$node->nid;

  }

  // return empty block if its not a node page
  // or if chat with fans is not turned on for this show
  // or if a show token has not been set for this show
  if (!isset($node->nid) || !$showChatPage || !$showTokenName) {
    return $output;
  }

  $show = $showTokenName;

  switch ($show) {
    case 'covertaffairs':
      $queryShow = 'caffairs';
      break;
    case 'criminalintent':
      $queryShow = 'laworderci';
      break;
    case 'svu':
      $queryShow = 'losvu';
      break;
    default:
      $queryShow = $show;
      break;
  }

  $query = urlencode("(childrenof:http://chatter.usanetwork.com/".$queryShow."/public/comments -state:ModeratorDeleted,ModeratorFlagged,SystemFlagged,CommunityFlagged -user.state:ModeratorBanned) sortOrder:reverseChronological safeHTML:true itemsPerPage:".$numCommentsToShow." children:0");

  $echoApi = 'http://api.echoenabled.com/v1/search?appkey=prod.usanetwork&q='.$query;

  // get Echo query results
  $session = curl_init($echoApi);
  curl_setopt($session, CURLOPT_HEADER, false);
  //curl_setopt($session, CURLOPT_PROXY, 'localhost:1540');
  curl_setopt($session, CURLOPT_RETURNTRANSFER, true);
  $response = json_decode(trim(curl_exec($session)));

  if (isset($response->entries)) {
    $output .= '<div id="usanetwork_social_show_homepage_chatter">
      <div id="usanetwork_social_chatter_title"><span class="panel-chatter-box">Chatter</span></div>';
    foreach ($response->entries as $entries) {
      $username = (isset($entries->actor->title)) ? strval($entries->actor->title) : '';
      $avatar = (isset($entries->actor->avatar)) ? strval($entries->actor->avatar) : '//c0.echoenabled.com/images/avatar-default.png';
      $comment = strip_tags(strval($entries->object->content));
      $sourceIcon = (isset($entries->source->icon)) ? strval($entries->source->icon) : '';
      $sourceName = strval($entries->source->name);
      $sourceUri = (isset($entries->source->uri)) ? strval($entries->source->uri) : '';
      $markers = (isset($entries->object->markers) &&
        is_array($entries->object->markers) &&
        count($entries->object->markers) > 0) ? $entries->object->markers : null; // $entries->object->markers is an array

      if ($sourceName == 'usanetwork') {
        //$sourceIcon = file_create_url(file_build_uri('../../usanetwork/modules/custom/usanetwork_social/images/chatter_icon_red_16x16.gif'));
        $sourceUri = 'http://www.usanetwork.com';
      }

      $time = usanetwork_social_ago(strtotime(strval($entries->postedTime)));

      $output .= '
      <div class="echo-item-content">
        <div class="echo-item-container echo-item-container-root echo-item-depth-0">
          <div class="echo-item-avatar-wrapper">
            <div class="echo-item-avatar">
              <img src="'.$avatar.'" style="width: 48px; height: 48px;">
            </div>
          </div>
          <div class="echo-item-wrapper echo-item-wrapper-root">
            <div class="echo-item-subwrapper">
              <div class="echo-item-subcontainer">
                <div class="echo-item-frame">
                  <div class="echo-item-authorName echo-linkColor">'.$username.'</div>
                  <div class="echo-clear"></div>
                  <div class="echo-item-data">
                    <div class="echo-item-body echo-primaryColor">
                      <span>
                      <div class="note_title">'.$comment.'</div>
                      </span>
                    </div>
                  </div>
                  <div class="echo-item-footer echo-secondaryColor echo-secondaryFont">
                    <a href="'.$sourceUri.'"><img class="echo-item-sourceIcon echo-clickable" style="display: block;" src="'.$sourceIcon.'"></a>
                    <div class="echo-item-date">'.$time.'&nbsp;from&nbsp;<a class="echo-secondaryColor" href="javascript:void(0)">usanetwork</a></div>
                    <div class="echo-clear"></div>
                  </div>
                </div>
              </div>
              <div class="echo-clear"></div>
            </div>
          </div>
          <div class="echo-clear"></div>
        </div>
      </div>
      ';

    }
    $output .= '<a href="'.$showUrl.'/social/chat-with-fans">
      <div id="usanetwork_social_join">
          <span class="usanetwork_social_pointer_image"></span>
          <span class="usanetwork_social_join_msg">join the conversation</span></div>
        </a>
        </div>
      </div>';
  }

  return $output;
}

/**
 * Implements hook_node_insert()
 */
function usanetwork_social_node_insert($node) {
  $lang = LANGUAGE_NONE;

  if ($node->status == 1 && isset($node->event) && $node->event == 'to_published') {
    $ideamelt_entities = array('catchall_page', 'media_gallery', 'usanetwork_static_page', 'tv_episode', 'usa_video', 'usa_tve_video');

    if (in_array($node->type, $ideamelt_entities)) {
      _usanetwork_social_notify_ideamelt($node);
    }
  }
}

/**
 * Implements hook_node_update()
 */
function usanetwork_social_node_update($node) {
  $lang = LANGUAGE_NONE;

  if ($node->status == 1 && isset($node->event) && $node->event == 'to_published') {
    $ideamelt_entities = array('catchall_page', 'media_gallery', 'usanetwork_static_page', 'tv_episode', 'usa_video', 'usa_tve_video');

    $state = db_select('state_flow_history', 's')
               ->fields('s', array('state'))
               ->condition('entity_id', $node->nid, '=')
               ->orderBy('timestamp', 'DESC')
               ->range(0,1)
               ->execute()
               ->fetchField();
    if ($state == 'published' && in_array($node->type, $ideamelt_entities)) {
      _usanetwork_social_notify_ideamelt($node);
    }
  }
}

/**
 * Implements hook_revision_scheduler_operation_preprocess()
 */
function usanetwork_social_revision_scheduler_operation_preprocess($entity, $operation) {
  $ideamelt_entities = array('catchall_page', 'media_gallery', 'usanetwork_static_page', 'tv_episode', 'usa_video', 'usa_tve_video');
  if ($operation->operation == 'workbench_moderation_to_published' && in_array($entity->type, $ideamelt_entities)) {
    _usanetwork_social_notify_ideamelt($entity);
  }
}

/**
 * Helper function to notify ideamelt
 */
function _usanetwork_social_notify_ideamelt($node) {
  $lang = LANGUAGE_NONE;

  $data = array();
  $data['api_key'] = variable_get('usanetwork_social_ideamelt_api_key', '');
  $enable_ideamelt = variable_get('usanetwork_social_enable_ideamelt', 0);

  if (empty($data['api_key']) || empty($enable_ideamelt)) {
    return;
  }

  if ($node->type == 'usa_video' || $node->type == 'usa_tve_video') {
    if (isset($node->field_sent_ideamelt_notification[$lang][0]['value']) && empty($node->field_sent_ideamelt_notification[$lang][0]['value'])) {
      $node->field_sent_ideamelt_notification[$lang][0]['value'] = 1;
      node_save($node);
    } else {
      // send the notification only once per video node
      return;
    }
  } else {
    if (!isset($node->field_send_ideamelt_notification[$lang][0]['value']) || empty($node->field_send_ideamelt_notification[$lang][0]['value'])) {
      return;
    }
  }
  if ($node->type == 'catchall_page' || $node->type == 'usanetwork_static_page') {
    $object_tid = isset($node->field_ideamelt_object_type[$lang][0]['tid']) ? $node->field_ideamelt_object_type[$lang][0]['tid'] : '';
    $object_term = taxonomy_term_load($object_tid);
    $data['object_type'] = $object_term->name;
  } else if ($node->type == 'tv_episode') {
    $data['object_type'] = 'episode-guide';
  } else if ($node->type == 'media_gallery') {
    $data['object_type'] = 'photo-gallery';
  } else {
    return;
  }

  $data['action_type'] = isset($node->field_ideamelt_action_type[$lang][0]['value']) ? $node->field_ideamelt_action_type[$lang][0]['value'] : '';
  if (isset($node->field_show[$lang][0]['target_id']) && !empty($node->field_show[$lang][0]['target_id'])) {
    $data['user_url'] = url(drupal_get_path_alias('node/'.$node->field_show[$lang][0]['target_id']), array('absolute' => true));

    //TODO: remove the next line after the push to prod; this line is added to test ideamelt on dev and stage servers
    $data['user_url'] = str_replace(array('dev.usanetwork.com', 'stage.usanetwork.com', 'local.usanetwork'), 'www.usanetwork.com', $data['user_url']);
  } else {
    // if there are no shows associated with a node, don't send ideamelt notification
    return;
  }
  $data['object_url'] = url(drupal_get_path_alias('node/'.$node->nid), array('absolute' => true));
  //TODO: remove the next line after the push to prod; this line is added to test ideamelt on dev and stage servers
  $data['object_url'] = str_replace(array('dev.usanetwork.com', 'stage.usanetwork.com', 'local.usanetwork'), 'www.usanetwork.com', $data['object_url']);
  $ideamelt_url = 'http://api.ideamelt.com/v1/story/create/';
  $headers = array('Content-Type' => 'application/x-www-form-urlencoded');

  $response = drupal_http_request($ideamelt_url, array('headers' => $headers, 'method' => 'POST', 'data' => http_build_query($data)));
  $result = drupal_json_decode($response->data);

  if (isset($result['success']) && !empty($result['success'])) {
    watchdog('usanetwork_social', 'Error: Ideamelt notification for enitity id: ' . $node->nid .'; Response:'. $result['message_list']);
  }
}


function usanetwork_social_show_on_now_box($node, $numCommentsToShow=2) {
if (!path_is_admin(current_path())) {

  $output = '';
  $lang = LANGUAGE_NONE;
  $arg = arg();

  if (empty($node) && isset($arg[1])) {
  $node = node_load($arg[1]);
  }

  if (!isset($node->nid)) {
  drupal_not_found();
  }
  $echoAppKey = variable_get('usanetwork_social_chat_echo_app_key', '');
  $vars = 'var echoAppKey = "' . $echoAppKey . '"; ';

  // GET URL ALIAS FOR THE NODE
  $alias = drupal_get_path_alias('node/'.$node->nid);

  // SET VARIABLES THAT DETERMINE WHETHER TO SHOW EACH FEED TYPE
  $showTwitter = isset($node->field_show_twitter_page[$lang][0]['value']) ? $node->field_show_twitter_page[$lang][0]['value'] : 0 ;
  $showChatPage = isset($node->field_show_chat_page[$lang][0]['value']) ? $node->field_show_chat_page[$lang][0]['value'] : 0;
  $showFacebook = isset($node->field_show_fb_page[$lang][0]['value']) ? $node->field_show_fb_page[$lang][0]['value'] : 0 ;
  $showPinterest = isset($node->field_show_pinterest_page[$lang][0]['value']) ? $node->field_show_pinterest_page[$lang][0]['value'] : 0 ;
  $showGetGlue = isset($node->field_show_getglue[$lang][0]['value']) ? $node->field_show_getglue[$lang][0]['value'] : 0 ;
  $showInstagram = isset($node->field_show_instagram_page[$lang][0]['value']) ? $node->field_show_instagram_page[$lang][0]['value'] : 0 ;

  // PINTEREST SECTION
  if ($showPinterest) {
    $pinterestUrl = isset($node->field_pinterest_url[$lang][0]['value']) ? $node->field_pinterest_url[$lang][0]['value'] : '';
    $pinterestUrl = empty($pinterestUrl) ? variable_get('usanetwork_social_pinterest_url', '') : $pinterestUrl;
  }

  // GETGLUE SECTION
  if ($showGetGlue) {
    $getGlueShow = isset($node->field_getglue_show[$lang][0]['value']) ? $node->field_getglue_show[$lang][0]['value'] : '';
    $getGlueShow = empty($getGlueShow) ? variable_get('usanetwork_social_getglue_show', '') : $getGlueShow;
    $getGlueSticker = isset($node->field_getglue_sticker_name[$lang][0]['value']) ? $node->field_getglue_sticker_name[$lang][0]['value'] : '';
    $getGlueUrl = 'http://getglue.com/tv_shows/' . $getGlueShow;
  }

  // INSTAGRAM SECTION
    if ($showInstagram) {
      $instagramShowId = isset($node->field_instagram_show_id[$lang][0]['value']) ? $node->field_instagram_show_id[$lang][0]['value'] : '';
      $instagramShowId = empty($instagramShowId) ? variable_get('usanetwork_social_instagram_show_id', '') : $instagramShowId;
    }

  // TWITTER SECTION
  if ($showTwitter) {
    $eql = isset($node->field_twitter_eql_template[$lang][0]['value']) ? $node->field_twitter_eql_template[$lang][0]['value'] : '';
    $eql = empty($eql) ? variable_get('usanetwork_social_twitter_echo_query_template', '') : $eql;

    $tokens = array();
    $tokens['[CHILDRENOF]'] = isset($node->field_twitter_childrenof[$lang][0]['value']) ? $node->field_twitter_childrenof[$lang][0]['value'] : '';
    $tokens['[SHOW]'] = isset($node->field_twitter_show[$lang][0]['value']) ? $node->field_twitter_show[$lang][0]['value'] : '';
    $tokens['[FEED]'] = isset($node->field_twitter_feed[$lang][0]['value']) ? $node->field_twitter_feed[$lang][0]['value'] : '';
    $tokens['[STATE]'] = isset($node->field_twitter_state[$lang][0]['value']) ? $node->field_twitter_state[$lang][0]['value'] : '';
    $tokens['[SOURCE]'] = isset($node->field_twitter_source[$lang][0]['value']) ? $node->field_twitter_source[$lang][0]['value'] : '';
    $tokens['[MARKERS]'] = isset($node->field_twitter_markers[$lang][0]['value']) ? $node->field_twitter_markers[$lang][0]['value'] : '';
    $tokens['[TAGS]'] = isset($node->field_twitter_tags[$lang][0]['value']) ? $node->field_twitter_tags[$lang][0]['value'] : '';
    $tokens['[SORTORDER]'] = isset($node->field_twitter_sortorder[$lang][0]['value']) ? $node->field_twitter_sortorder[$lang][0]['value'] : '';
    $tokens['[SAFEHTML]'] = isset($node->field_twitter_safehtml[$lang][0]['value']) ? $node->field_twitter_safehtml[$lang][0]['value'] : '';
    $tokens['[ITEMSPERPAGE]'] = 'itemsPerPage:' . $numCommentsToShow; // isset($node->field_twitter_itemsperpage[$lang][0]['value']) ? $node->field_twitter_itemsperpage[$lang][0]['value'] : '';
    $tokens['[CHILDREN]'] = isset($node->field_twitter_children[$lang][0]['value']) ? $node->field_twitter_children[$lang][0]['value'] : '';

    $eql = urlencode(str_replace(array_keys($tokens), array_values($tokens), $eql));
    $echoAppKey = variable_get('usanetwork_social_twitter_echo_app_key', '');

    $echoApi = 'http://api.echoenabled.com/v1/search?appkey=prod.usanetwork&q='.$eql;

    $session = curl_init($echoApi);
    curl_setopt($session, CURLOPT_HEADER, false);
    //curl_setopt($session, CURLOPT_PROXY, 'localhost:1540');
    curl_setopt($session, CURLOPT_RETURNTRANSFER, true);
    $response = json_decode(trim(curl_exec($session)));

    if (isset($response->entries)) {
    $output .= '<div id="usanetwork_social_show_homepage_chatter">
      <div id="usanetwork_social_chatter_title">';
      if ($showTwitter) {
        $output .= '<a id="navTwitterOnNow" href="#navTwitter" name = "'.$node->nid.'"><span class="navTwitter onnow_social_nav onnow_social_selected">Tweets</span></a><span class="onNow-navSocial-empty-span"></span>';
      }
      if ($showChatPage) {
        $output .= '<a id="navChatterOnNow" href="#navChatter" name = "'.$node->nid.'"><span class="navChatter onnow_social_nav">Character Chatter</span></a><span class="onNow-navSocial-empty-span"></span>';
      }
      if ($showFacebook) {
        $output .= '<a id="navFbOnNow" href="#navFb" name = "'.$node->nid.'"><span class="navFb onnow_social_nav">FB</span></a><span class="onNow-navSocial-empty-span"></span>';
      }
      if ($showPinterest) {
        $output .= '<a id="navPinterestOnNow" href="#navPinterest" name = "'.$pinterestUrl.'"><span class="navPinterest onnow_social_nav">Pinterest</span></a><span class="onNow-navSocial-empty-span"></span>';
      }
      if ($showGetGlue) {
        $output .= '<a id="navGetGlueOnNow" href="#navGetGlue" name = "'.$getGlueUrl."urlshowseperator".$getGlueShow.'"><span class="navGetGlue onnow_social_nav">GetGlue</span></a><span class="onNow-navSocial-empty-span"></span>';
      }
      if ($showInstagram) {
        $output .= '<a id="navInstagramOnNow" href="#navInstagram" name = "'.$instagramShowId.'"><span class="navInstagram onnow_social_nav">Instagram</span></a>';
      }
    $output .=  '</div><div id="pinterest" class="widget-background"></div><div id="instagram" class="widget-background"></div><div id="get-glue" class="widget-background"><div id="sticker" style="padding-top:20px;" ></div></div>
      <div id="echo-stream" class="echo-ui echo-TwitterIntents-plugin"><div class="echo-stream-container echo-primaryFont echo-primaryBackgroundColor"><div class="echo-stream-header">
      <div class="echo-clear"></div>
      </div><div class="echo-stream-body"><span id = "socialblock_on_now_content">';
    foreach ($response->entries as $entries) {
      $username = (isset($entries->actor->title)) ? strval($entries->actor->title) : '';
      $link = (isset($entries->actor->links[0])) ? strval($entries->actor->links[0]) : '';
      $id = (isset($entries->object->id)) ? strval($entries->object->id) : '';
      $avatar = (isset($entries->actor->avatar)) ? strval($entries->actor->avatar) : '//c0.echoenabled.com/images/avatar-default.png';
      $comment = strip_tags(strval($entries->object->content));
      $sourceIcon = (isset($entries->source->icon)) ? strval($entries->source->icon) : '';
      $sourceName = strval($entries->source->name);
      $sourceUri = (isset($entries->source->uri)) ? strval($entries->source->uri) : '';
      if($sourceUri != '') {
        $tweetId = explode("/status/", $sourceUri);
      }
      //echo 'tweetId'.$tweetId[1];exit;
      $markers = (isset($entries->object->markers) &&
      is_array($entries->object->markers) &&
      count($entries->object->markers) > 0) ? $entries->object->markers : null; // $entries->object->markers is an array

      if ($sourceName == 'usanetwork') {
      $sourceUri = 'http://www.usanetwork.com';
      }
      $time = usanetwork_social_ago(strtotime(strval($entries->postedTime)));
      $output .= '
                <div class="echo-item-content">
                 <div class="echo-item-container echo-item-container-root echo-item-depth-0">
                    <div class="echo-item-avatar-wrapper">
                       <div class="echo-item-avatar"><a href="'.$link.'"><img src="'.$avatar.'" style="width: 48px; height: 48px;"></a></div>
                    </div>
                    <div class="echo-item-wrapper echo-item-wrapper-root">
                       <div class="echo-item-subwrapper">
                          <div class="echo-item-subcontainer">
                             <div class="echo-item-frame">
                                <div class="echo-item-modeSwitch echo-clickable" style="display: none;"></div>
                                <div class="echo-item-authorName echo-linkColor echo-item-tweetScreenName"><a href="'.$link.'">'.$username.'</a></div>
                                <span class="echo-item-tweetUserName"><a class="echo-secondaryFont echo-secondaryColor" href="'.$link.'">@'.$username.'</a></span>
                                <div class="echo-clear"></div>
                                <div class="echo-item-data">
                                   <div class="echo-item-re"></div>
                                   <div class="echo-item-body echo-primaryColor"> <span class="echo-item-text">'.$comment.'</span><span class="echo-item-textEllipses" style="display: none;">...</span><span class="echo-item-textToggleTruncated echo-linkColor echo-clickable" style="display: none;"></span></div>
                                </div>
                                <div class="echo-item-footer echo-secondaryColor echo-secondaryFont">
                                   <a href="'.$sourceUri.'"><img class="echo-item-sourceIcon echo-clickable" style="display: block;" src="http://cdn.echoenabled.com/images/favicons/twitter.png"></a>
                                   <div class="echo-item-date" style="display: none;">'.$time.'</div>
                                   <div class="echo-item-from">&nbsp;from&nbsp;<a href="https://twitter.com/saadz94/status/388261974410534912" class="echo-secondaryColor">Twitter</a></div>
                                   <div class="echo-item-via">&nbsp;via&nbsp;<a href="http://aboutecho.com/" class="echo-secondaryColor">Echo</a></div>
                                   <div class="echo-item-controls"><a class="echo-item-control echo-clickable echo-item-intentControl echo-secondaryColor echo-item-control-Reply" href="https://twitter.com/intent/tweet?in_reply_to='.$tweetId[1].'&amp;tweet_id='.$tweetId[1].'"><span class="echo-item-twitterIntentsIcon echo-item-twitterIntentsIconReply">&nbsp;</span><span>Reply</span></a><span class="echo-item-control-delim"> . </span><a class="echo-item-control echo-clickable echo-item-intentControl echo-secondaryColor echo-item-control-Retweet" href="https://twitter.com/intent/retweet?in_reply_to='.$tweetId[1].'&amp;tweet_id='.$tweetId[1].'"><span class="echo-item-twitterIntentsIcon echo-item-twitterIntentsIconRetweet">&nbsp;</span><span>Retweet</span></a><span class="echo-item-control-delim"> . </span><a class="echo-item-control echo-clickable echo-item-intentControl echo-secondaryColor echo-item-control-Favorite" href="https://twitter.com/intent/favorite?in_reply_to='.$tweetId[1].'&amp;tweet_id='.$tweetId[1].'"><span class="echo-item-twitterIntentsIcon echo-item-twitterIntentsIconFavorite">&nbsp;</span><span>Favorite</span></a></div>
                                  <div class="echo-clear"></div>

                                </div>
                             </div>
                          </div>
                          <div class="echo-clear"></div>
                       </div>
                    </div>
                    <div class="echo-clear"></div>
                    <div class="echo-item-childrenMarker"></div>
                 </div>
                 <div class="echo-item-expandChildren echo-item-container-child echo-trinaryBackgroundColor echo-clickable"><span class="echo-item-expandChildrenLabel echo-message-icon"></span></div>
                 <div class="echo-item-children"></div>
                 <div class="echo-item-childrenByCurrentActorLive"></div>
                </div>';
              }
            $output .= '</span></div></div></div>';
            $output .= '<div id="usanetwork_on_now_social_section_join">';
            $output .= '<div id="usanetwork_social_section_join">';
            $output .= '<span id="join-tweets" class = "onnow-social-section-join" style = "display:block;"><a href = "/'.$alias.'/social/tweets">Check out more tweets<span class="usanetwork_social_join_msg"></span></a></span>';
            $output .= '<span id="join-chatter" class = "onnow-social-section-join" style = "display:none;"><a href = "/'.$alias.'/social/chat-with-fans">Go chat with fans<span class="usanetwork_social_join_msg"></span></a></span>';
            $output .= '<span id="join-buzz" class = "onnow-social-section-join" style = "display:none;"><a href = "/'.$alias.'/social/latest">Get more social buzz<span class="usanetwork_social_join_msg"></span></a></span>';
            $output .= '<span class="usanetwork_social_pointer_image"></span>';
            $output .= '</div>';
            $output .= '</div>';
            $output .= '</div>';
        }
      return $output;
    }
  }
}

function usanetwork_social_show_on_now_chatter_response($node, $numCommentsToShow=2) {
  $lang = LANGUAGE_NONE;
  $output = '';

  if (isset($node->nid)) {
    $showChatPage = isset($node->field_show_chat_page[$lang][0]['value']) ? $node->field_show_chat_page[$lang][0]['value'] : 0;
    $showTokenName = isset($node->field_chat_show[$lang][0]['value']) ? $node->field_chat_show[$lang][0]['value'] : '';
    $showAlias = drupal_get_path_alias('node/'.$node->nid);
    $showUrl = (!empty($showAlias)) ? $showAlias : 'node/'.$node->nid;

  }

  // return empty block if its not a node page
  // or if chat with fans is not turned on for this show
  // or if a show token has not been set for this show
  if (!isset($node->nid) || !$showChatPage || !$showTokenName) {
    return $output;
  }

  $show = $showTokenName;

  switch ($show) {
    case 'covertaffairs':
      $queryShow = 'caffairs';
      break;
    case 'criminalintent':
      $queryShow = 'laworderci';
      break;
    case 'svu':
      $queryShow = 'losvu';
      break;
    default:
      $queryShow = $show;
      break;
  }

  $query = urlencode("(childrenof:http://chatter.usanetwork.com/".$queryShow."/public/comments -state:ModeratorDeleted,ModeratorFlagged,SystemFlagged,CommunityFlagged -user.state:ModeratorBanned) sortOrder:reverseChronological safeHTML:true itemsPerPage:".$numCommentsToShow." children:0");

  $echoApi = 'http://api.echoenabled.com/v1/search?appkey=prod.usanetwork&q='.$query;

  // get Echo query results
  $session = curl_init($echoApi);
  curl_setopt($session, CURLOPT_HEADER, false);
  //curl_setopt($session, CURLOPT_PROXY, 'localhost:1540');
  curl_setopt($session, CURLOPT_RETURNTRANSFER, true);
  $response = json_decode(trim(curl_exec($session)));

  if (isset($response->entries)) {
    foreach ($response->entries as $entries) {
      $username = (isset($entries->actor->title)) ? strval($entries->actor->title) : '';
      $avatar = (isset($entries->actor->avatar)) ? strval($entries->actor->avatar) : '//c0.echoenabled.com/images/avatar-default.png';
      $comment = strip_tags(strval($entries->object->content));
      $sourceIcon = (isset($entries->source->icon)) ? strval($entries->source->icon) : '';
      $sourceName = strval($entries->source->name);
      $sourceUri = (isset($entries->source->uri)) ? strval($entries->source->uri) : '';
      $markers = (isset($entries->object->markers) &&
        is_array($entries->object->markers) &&
        count($entries->object->markers) > 0) ? $entries->object->markers : null; // $entries->object->markers is an array

      if ($sourceName == 'usanetwork') {
        //$sourceIcon = file_create_url(file_build_uri('../../usanetwork/modules/custom/usanetwork_social/images/chatter_icon_red_16x16.gif'));
        $sourceUri = 'http://www.usanetwork.com';
      }

      $time = usanetwork_social_ago(strtotime(strval($entries->postedTime)));

      $output .= '
        <div class="echo-item-content">
         <div class="echo-item-container echo-item-container-root echo-item-depth-0">
            <div class="echo-item-avatar-wrapper">
               <div class="echo-item-avatar"><img src="'.$avatar.'" style="width: 48px; height: 48px;"></div>
            </div>
            <div class="echo-item-wrapper echo-item-wrapper-root">
               <div class="echo-item-subwrapper">
                  <div class="echo-item-subcontainer">
                     <div class="echo-item-frame">
                        <div class="echo-item-modeSwitch echo-clickable" style="display: none;"></div>
                        <span class="echo-item-tweetDate"></span>
                        <div class="echo-item-authorName echo-linkColor">'.$username.'</div>
                        <span class="echo-item-tweetUserName"></span>
                        <div class="echo-clear"></div>
                        <div class="echo-item-data">
                           <div class="echo-item-re"></div>
                           <div class="echo-item-body echo-primaryColor"> <span class="echo-item-text">'.$comment.'</span><span class="echo-item-textEllipses" style="display: none;">...</span><span class="echo-item-textToggleTruncated echo-linkColor echo-clickable" style="display: none;"></span></div>
                        </div>
                        <div class="echo-item-footer echo-secondaryColor echo-secondaryFont">
                           <a href="'.$sourceUri.'"><img class="echo-item-sourceIcon echo-clickable" style="display: block;" src="'.$sourceIcon.'"></a>
                           <div class="echo-item-date">'.$time.'</div>
                           <div class="echo-item-from">&nbsp;from&nbsp;<a href="javascript:void(0)" class="echo-secondaryColor">usanetwork</a></div>
                           <div class="echo-item-via"></div>
                           <div class="echo-item-controls"></div>
                           <div class="echo-clear"></div>
                        </div>
                     </div>
                  </div>
                  <div class="echo-clear"></div>
               </div>
            </div>
            <div class="echo-clear"></div>
            <div class="echo-item-childrenMarker"></div>
         </div>
         <div class="echo-item-expandChildren echo-item-container-child echo-trinaryBackgroundColor echo-clickable"><span class="echo-item-expandChildrenLabel echo-message-icon"></span></div>
         <div class="echo-item-children"></div>
         <div class="echo-item-childrenByCurrentActorLive"></div>
      </div>
      ';

    }
  }
  return $output;
}

function usanetwork_social_show_on_now_facebook_response($node, $numCommentsToShow=2) {
if (!path_is_admin(current_path())) {

  $output = '';
  $lang = LANGUAGE_NONE;
  $arg = arg();

  if (empty($node) && isset($arg[1])) {
  $node = node_load($arg[1]);
  }

  if (!isset($node->nid)) {
  drupal_not_found();
  }
  $echoAppKey = variable_get('usanetwork_social_chat_echo_app_key', '');
  $vars = 'var echoAppKey = "' . $echoAppKey . '"; ';
    // FACEBOOK SECTION
    $showFacebook = isset($node->field_show_fb_page[$lang][0]['value']) ? $node->field_show_fb_page[$lang][0]['value'] : 0 ;
    if ($showFacebook) {
      $eql = isset($node->field_fb_eql_template[$lang][0]['value']) ? $node->field_fb_eql_template[$lang][0]['value'] : '';
      $eql = empty($eql) ? variable_get('usanetwork_social_facebook_echo_query_template', '') : $eql;

      $tokens = array();
      $tokens['[CHILDRENOF]'] = isset($node->field_fb_childrenof[$lang][0]['value']) ? $node->field_fb_childrenof[$lang][0]['value'] : '';
      $tokens['[SHOW]'] = isset($node->field_fb_show[$lang][0]['value']) ? $node->field_fb_show[$lang][0]['value'] : '';
      $tokens['[FEED]'] = isset($node->field_fb_feed[$lang][0]['value']) ? $node->field_fb_feed[$lang][0]['value'] : '';
      $tokens['[STATE]'] = isset($node->field_fb_state[$lang][0]['value']) ? $node->field_fb_state[$lang][0]['value'] : '';
      $tokens['[SOURCE]'] = isset($node->field_fb_source[$lang][0]['value']) ? $node->field_fb_source[$lang][0]['value'] : '';
      $tokens['[MARKERS]'] = isset($node->field_fb_markers[$lang][0]['value']) ? $node->field_fb_markers[$lang][0]['value'] : '';
      $tokens['[TAGS]'] = isset($node->field_fb_tags[$lang][0]['value']) ? $node->field_fb_tags[$lang][0]['value'] : '';
      $tokens['[SORTORDER]'] = isset($node->field_fb_sortorder[$lang][0]['value']) ? $node->field_fb_sortorder[$lang][0]['value'] : '';
      $tokens['[SAFEHTML]'] = isset($node->field_fb_safehtml[$lang][0]['value']) ? $node->field_fb_safehtml[$lang][0]['value'] : '';
      $tokens['[ITEMSPERPAGE]'] = 'itemsPerPage:' . $numCommentsToShow; // isset($node->field_fb_itemsperpage[$lang][0]['value']) ? $node->field_fb_itemsperpage[$lang][0]['value'] : '';
      $tokens['[CHILDREN]'] = isset($node->field_fb_children[$lang][0]['value']) ? $node->field_fb_children[$lang][0]['value'] : '';

      $eql = urlencode(str_replace(array_keys($tokens), array_values($tokens), $eql));
      $echoAppKey = variable_get('usanetwork_social_facebook_echo_app_key', '');

      $echoApi = 'http://api.echoenabled.com/v1/search?appkey=prod.usanetwork&q='.$eql;
      $session = curl_init($echoApi);
      curl_setopt($session, CURLOPT_HEADER, false);
      //curl_setopt($session, CURLOPT_PROXY, 'localhost:1540');
      curl_setopt($session, CURLOPT_RETURNTRANSFER, true);
      $response = drupal_json_decode(trim(curl_exec($session)));
      if (isset($response['entries'])) {
        foreach ($response['entries'] as $entries) {
          $username = (isset($entries['actor']['title'])) ? strval($entries['actor']['title']) : '';
          $avatar = (isset($entries['actor']['avatar'])) ? strval($entries['actor']['avatar']) : '//c0.echoenabled.com/images/avatar-default.png';
          $comment = strip_tags(strval($entries['object']['content']));
          $sourceIcon = (isset($entries['source']['icon'])) ? strval($entries['source']['icon']) : '';
          $sourceName = strval($entries['source']['name']);
          $sourceUri = (isset($entries['source']['uri'])) ? strval($entries['source']['uri']) : '';

          if ($sourceName == 'usanetwork') {
            //$sourceIcon = file_create_url(file_build_uri('../../usanetwork/modules/custom/usanetwork_social/images/chatter_icon_red_16x16.gif'));
            $sourceUri = 'http://www.usanetwork.com';
          }

          $time = usanetwork_social_ago(strtotime(strval($entries['postedTime'])));

          $output .= '
          <div class="echo-item-content">
             <div class="echo-item-container echo-item-container-root echo-item-depth-0">
                <div class="echo-item-avatar-wrapper">
                   <div class="echo-item-avatar"><img src="'.$avatar.'" style="width: 48px; height: 48px;"></div>
                </div>
                <div class="echo-item-wrapper echo-item-wrapper-root">
                   <div class="echo-item-subwrapper">
                      <div class="echo-item-subcontainer">
                         <div class="echo-item-frame">
                            <div class="echo-item-modeSwitch echo-clickable" style="display: none;"></div>
                            <span class="echo-item-tweetDate"></span>
                            <div class="echo-item-authorName echo-linkColor">'.$username.'</div>
                            <span class="echo-item-tweetUserName"></span>
                            <div class="echo-clear"></div>
                            <div class="echo-item-data">
                               <div class="echo-item-re"></div>
                               <div class="echo-item-body echo-primaryColor">
                                  <span class="echo-item-text">
                                     <div>'.$comment.'</div>
                                  </span>
                                  <span class="echo-item-textEllipses" style="display: none;">...</span><span class="echo-item-textToggleTruncated echo-linkColor echo-clickable" style="display: none;"></span>
                               </div>
                            </div>
                            <div class="echo-item-footer echo-secondaryColor echo-secondaryFont">
                               <a href="'.$sourceUri.'"><img class="echo-item-sourceIcon echo-clickable" style="display: block;" src="http://cdn.echoenabled.com/images/favicons/facebook.png"></a>
                               <div class="echo-item-from">&nbsp;from&nbsp;<a href="#" class="echo-secondaryColor">Facebook</a></div>
                               <div class="echo-item-via">&nbsp;via&nbsp;<a href="http://aboutecho.com/" class="echo-secondaryColor">Echo</a></div>
                               <div class="echo-item-controls"></div>
                               <div class="echo-clear"></div>
                            </div>
                         </div>
                      </div>
                      <div class="echo-clear"></div>
                   </div>
                </div>
                <div class="echo-clear"></div>
                <div class="echo-item-childrenMarker"></div>
             </div>
             <div class="echo-item-expandChildren echo-item-container-child echo-trinaryBackgroundColor echo-clickable"><span class="echo-item-expandChildrenLabel echo-message-icon"></span></div>
             <div class="echo-item-children"></div>
             <div class="echo-item-childrenByCurrentActorLive"></div>
          </div>';

        }

      }
    }
    return $output;

  }
}

function usanetwork_social_show_on_now_twitter_response($node, $numCommentsToShow=2) {
if (!path_is_admin(current_path())) {

  $output = '';
  $lang = LANGUAGE_NONE;
  $arg = arg();

  if (empty($node) && isset($arg[1])) {
  $node = node_load($arg[1]);
  }

  if (!isset($node->nid)) {
  drupal_not_found();
  }

  $echoAppKey = variable_get('usanetwork_social_chat_echo_app_key', '');
  $vars = 'var echoAppKey = "' . $echoAppKey . '"; ';

  // TWEETS SECTION
  $showTwitter = isset($node->field_show_twitter_page[$lang][0]['value']) ? $node->field_show_twitter_page[$lang][0]['value'] : 0 ;
  if ($showTwitter) {
    $eql = isset($node->field_twitter_eql_template[$lang][0]['value']) ? $node->field_twitter_eql_template[$lang][0]['value'] : '';
    $eql = empty($eql) ? variable_get('usanetwork_social_twitter_echo_query_template', '') : $eql;

    $tokens = array();
    $tokens['[CHILDRENOF]'] = isset($node->field_twitter_childrenof[$lang][0]['value']) ? $node->field_twitter_childrenof[$lang][0]['value'] : '';
    $tokens['[SHOW]'] = isset($node->field_twitter_show[$lang][0]['value']) ? $node->field_twitter_show[$lang][0]['value'] : '';
    $tokens['[FEED]'] = isset($node->field_twitter_feed[$lang][0]['value']) ? $node->field_twitter_feed[$lang][0]['value'] : '';
    $tokens['[STATE]'] = isset($node->field_twitter_state[$lang][0]['value']) ? $node->field_twitter_state[$lang][0]['value'] : '';
    $tokens['[SOURCE]'] = isset($node->field_twitter_source[$lang][0]['value']) ? $node->field_twitter_source[$lang][0]['value'] : '';
    $tokens['[MARKERS]'] = isset($node->field_twitter_markers[$lang][0]['value']) ? $node->field_twitter_markers[$lang][0]['value'] : '';
    $tokens['[TAGS]'] = isset($node->field_twitter_tags[$lang][0]['value']) ? $node->field_twitter_tags[$lang][0]['value'] : '';
    $tokens['[SORTORDER]'] = isset($node->field_twitter_sortorder[$lang][0]['value']) ? $node->field_twitter_sortorder[$lang][0]['value'] : '';
    $tokens['[SAFEHTML]'] = isset($node->field_twitter_safehtml[$lang][0]['value']) ? $node->field_twitter_safehtml[$lang][0]['value'] : '';
    $tokens['[ITEMSPERPAGE]'] = 'itemsPerPage:' . $numCommentsToShow; // isset($node->field_twitter_itemsperpage[$lang][0]['value']) ? $node->field_twitter_itemsperpage[$lang][0]['value'] : '';
    $tokens['[CHILDREN]'] = isset($node->field_twitter_children[$lang][0]['value']) ? $node->field_twitter_children[$lang][0]['value'] : '';

    $eql = urlencode(str_replace(array_keys($tokens), array_values($tokens), $eql));
    $echoAppKey = variable_get('usanetwork_social_twitter_echo_app_key', '');

    $echoApi = 'http://api.echoenabled.com/v1/search?appkey=prod.usanetwork&q='.$eql;

    $session = curl_init($echoApi);
    curl_setopt($session, CURLOPT_HEADER, false);
    //curl_setopt($session, CURLOPT_PROXY, 'localhost:1540');
    curl_setopt($session, CURLOPT_RETURNTRANSFER, true);
    $response = json_decode(trim(curl_exec($session)));

    if (isset($response->entries)) {
    foreach ($response->entries as $entries) {
      $username = (isset($entries->actor->title)) ? strval($entries->actor->title) : '';
      $link = (isset($entries->actor->links[0])) ? strval($entries->actor->links[0]) : '';
      $id = (isset($entries->object->id)) ? strval($entries->object->id) : '';
      $avatar = (isset($entries->actor->avatar)) ? strval($entries->actor->avatar) : '//c0.echoenabled.com/images/avatar-default.png';
      $comment = strip_tags(strval($entries->object->content));
      $sourceIcon = (isset($entries->source->icon)) ? strval($entries->source->icon) : '';
      $sourceName = strval($entries->source->name);
      $sourceUri = (isset($entries->source->uri)) ? strval($entries->source->uri) : '';
      if($sourceUri != '') {
        $tweetId = explode("/status/", $sourceUri);
      }
      $markers = (isset($entries->object->markers) &&
      is_array($entries->object->markers) &&
      count($entries->object->markers) > 0) ? $entries->object->markers : null; // $entries->object->markers is an array

      if ($sourceName == 'usanetwork') {
        $sourceUri = 'http://www.usanetwork.com';
      }
      $time = usanetwork_social_ago(strtotime(strval($entries->postedTime)));
      $output .= '
              <div class="echo-item-content">
               <div class="echo-item-container echo-item-container-root echo-item-depth-0">
                  <div class="echo-item-avatar-wrapper">
                     <div class="echo-item-avatar"><a href="'.$link.'"><img src="'.$avatar.'" style="width: 48px; height: 48px;"></a></div>
                  </div>
                  <div class="echo-item-wrapper echo-item-wrapper-root">
                     <div class="echo-item-subwrapper">
                        <div class="echo-item-subcontainer">
                           <div class="echo-item-frame">
                              <div class="echo-item-modeSwitch echo-clickable" style="display: none;"></div>
                              <div class="echo-item-authorName echo-linkColor echo-item-tweetScreenName"><a href="'.$link.'">'.$username.'</a></div>
                              <span class="echo-item-tweetUserName"><a class="echo-secondaryFont echo-secondaryColor" href="'.$link.'">@'.$username.'</a></span>
                              <div class="echo-clear"></div>
                              <div class="echo-item-data">
                                 <div class="echo-item-re"></div>
                                 <div class="echo-item-body echo-primaryColor"> <span class="echo-item-text">'.$comment.'</span><span class="echo-item-textEllipses" style="display: none;">...</span><span class="echo-item-textToggleTruncated echo-linkColor echo-clickable" style="display: none;"></span></div>
                              </div>
                              <div class="echo-item-footer echo-secondaryColor echo-secondaryFont">
                                 <a href="'.$sourceUri.'"><img class="echo-item-sourceIcon echo-clickable" style="display: block;" src="http://cdn.echoenabled.com/images/favicons/twitter.png"></a>
                                 <div class="echo-item-date" style="display: none;">'.$time.'</div>
                                 <div class="echo-item-from">&nbsp;from&nbsp;<a href="https://twitter.com/saadz94/status/388261974410534912" class="echo-secondaryColor">Twitter</a></div>
                                 <div class="echo-item-via">&nbsp;via&nbsp;<a href="http://aboutecho.com/" class="echo-secondaryColor">Echo</a></div>
                                 <div class="echo-item-controls"><a class="echo-item-control echo-clickable echo-item-intentControl echo-secondaryColor echo-item-control-Reply" href="https://twitter.com/intent/tweet?in_reply_to='.$tweetId[1].'&amp;tweet_id='.$tweetId[1].'"><span class="echo-item-twitterIntentsIcon echo-item-twitterIntentsIconReply">&nbsp;</span><span>Reply</span></a><span class="echo-item-control-delim"> . </span><a class="echo-item-control echo-clickable echo-item-intentControl echo-secondaryColor echo-item-control-Retweet" href="https://twitter.com/intent/retweet?in_reply_to='.$tweetId[1].'&amp;tweet_id='.$tweetId[1].'"><span class="echo-item-twitterIntentsIcon echo-item-twitterIntentsIconRetweet">&nbsp;</span><span>Retweet</span></a><span class="echo-item-control-delim"> . </span><a class="echo-item-control echo-clickable echo-item-intentControl echo-secondaryColor echo-item-control-Favorite" href="https://twitter.com/intent/favorite?in_reply_to='.$tweetId[1].'&amp;tweet_id='.$tweetId[1].'"><span class="echo-item-twitterIntentsIcon echo-item-twitterIntentsIconFavorite">&nbsp;</span><span>Favorite</span></a></div>
                                 <div class="echo-clear"></div>
                              </div>
                           </div>
                        </div>
                        <div class="echo-clear"></div>
                     </div>
                  </div>
                  <div class="echo-clear"></div>
                  <div class="echo-item-childrenMarker"></div>
               </div>
               <div class="echo-item-expandChildren echo-item-container-child echo-trinaryBackgroundColor echo-clickable"><span class="echo-item-expandChildrenLabel echo-message-icon"></span></div>
               <div class="echo-item-children"></div>
               <div class="echo-item-childrenByCurrentActorLive"></div>
            </div>';
          }
        }
      return $output;
    }
  }
}
