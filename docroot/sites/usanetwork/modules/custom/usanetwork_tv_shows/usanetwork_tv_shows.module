<?php

/**
 * @file
 * Code for the usanetwork_tv_shows feature.
 */
include_once 'usanetwork_tv_shows.features.inc';

define('USANETWORK_TV_SHOWS_FIELD_NAME', 'field_show');
define('USANETWORK_TV_SHOWS_CAROUSEL_NUMBER', 3);

/**
 *  Implements hook_block_info().
 */
function usanetwork_tv_shows_block_info() {
  $blocks = array();

  $blocks['usanetwork_tv_shows_submenu'] = array(
    'info' => t('TV Show: submenu block'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );

  $blocks['usanetwork_tv_shows_aspot'] = array(
    'info' => t('TV Shows: A-Spot'),
    'cache' => DRUPAL_NO_CACHE,
  );

  $blocks['usanetwork_tv_shows_latest'] = array(
    'info' => t('TV Show: latest block'),
    'cache' => DRUPAL_CACHE_PER_PAGE,
  );
  
  // Catch up & Explore
  $blocks['usanetwork_tv_shows_coex'] = array(
    'info' => t('TV Shows: Catch up, Explore'),
    'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}

/**
 *  Implements hook_block_view().
 */
function usanetwork_tv_shows_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'usanetwork_tv_shows_submenu':
      $block['subject'] = '';
      $block['content'] = _usanetwork_tv_shows_submenu();
      break;
    
    case 'usanetwork_tv_shows_aspot':
      $block['subject'] = '';
      $block['content'] = array(
        '#markup' => _usanetwork_tv_shows_aspot_block(),
        '#attached' => array(
          'js' => array(
            path_to_theme('aurora_usa') . '/javascripts/matchmedia.js',
            path_to_theme('aurora_usa') . '/javascripts/picturefill.js',
            path_to_theme('aurora_usa') . '/javascripts/show-aspot.js',
          ),
        ),
      );
      break;

   case 'usanetwork_tv_shows_latest':
      $show = menu_get_object();
      if (!is_object($show) || (!isset($show->type) && $show->type != 'tv_show')) {
        return '';
      }
      $block['subject'] = '';
      $block['content'] = _usanetwork_tv_shows_latest($show);
      break;

    case 'usanetwork_tv_shows_coex':
      $block['subject'] = '';
      $block['content'] = _usanetwork_tv_shows_catchup_explore_block();
      break;
  }

  return $block;
}

/**
 *  Implements hook_theme().
 */
function usanetwork_tv_shows_theme($existing, $type, $theme, $path) {
  return array(
    'usanetwork_tv_shows_aspot' => array(
      'variables' => array(
        'show' => NULL,
        'episodes' => array(
          0 => array(
            'url' => NULL,
            'title' => NULL,
            'series_and_number' => NULL,
            'duration' => NULL,
            'image_url' => NULL,
          ),
        ),
      ),
      'template' => 'templates/usanetwork-tv-shows-aspot',
    ),
    'usanetwork_tv_shows_catchup_explore' => array(
      'variables' => array(
        'is_catch_up' => NULL,
        'is_explore' => NULL,
        'catch_up' => array(// Carousel lines
          0 => array(
            'caption' => NULL,
            'title' => NULL,
            'additional_text' => NULL,
            'elements' => array(), // Array of pre-rendered 'usanetwork_tv_shows_catchup_explore_content_element' elements
          )
        ),
        'explore' => array(
        ),
      ),
      'template' => 'templates/usanetwork-tv-shows-catchup-explore',
    ),
    'usanetwork_tv_shows_catchup_explore_content_element' => array(
      'variables' => array(
        'class' => NULL,
        'node_classes' => array(),
        'title' => NULL,
        'additional' => array(
          'normal' => NULL,
          'span' => NULL,
        ),
        'media_player_icon' => TRUE,
      ),
      'template' => 'templates/usanetwork-tv-shows-catchup-explore-content-element',
    ),
    'usanetwork_tv_shows_submenu' => array(
      'variables' => array(
        'show_title' => NULL,
        'weekday' => NULL,
        'time' => NULL,
        'social_icons' => array(),
        'show_menu_video_url' => NULL,
        'show_menu_video_img' => NULL,
        'show_menu_video_title' => NULL,
        'show_menu_video_caption' => NULL,
        'show_menu_tab_items' => NULL,
      ),
      'template' => 'templates/usanetwork-tv-shows-submenu',
    ),
    'usanetwork_tv_shows_latest_item' => array(
      'variables' => array(
        'item_title' => NULL,
        'show_class' => NULL,
        'url' => NULL,
        'show_title' => NULL,
        'additional' => NULL,
        'duration' => NULL,
        'icon_type' => NULL,
        'image' => NULL,
      ),
      'template' => 'templates/usanetwork-tv-shows-latest-item',
    ),
  );
}


/**
 * Implements hook_image_default_styles().
 */
function usanetwork_tv_shows_image_default_styles() {
  $styles = array();

  $styles['634x349'] = array(
    'effects' => array(
      array(
        'name' => 'image_scale_and_crop',
        'data' => array(
          'width' => 634,
          'height' => 349,
        ),
        'weight' => 0,
      ),
    ),
  );

  return $styles;
}

/**
 * Implements hook_form_FORM_ID_alter().
 * this is a straight rip from pub_tv old relations fields
 */
function usanetwork_tv_shows_form_tv_episode_node_form_alter(&$form, &$form_state) {

  // Add AJAX handling to the the show field so that users only see seasons for
  // the selected show.
  $form['field_show'][LANGUAGE_NONE]['#ajax'] = array(
    'event' => 'change',
    'callback' => 'usanetwork_tv_shows_season_option_populate_js',
    'wrapper' => 'season-wrapper',
    'effect' => 'fade',
  );
  $form['field_show'][LANGUAGE_NONE]['#prefix'] = '<div id="show-wrapper">';
  $form['field_show'][LANGUAGE_NONE]['#suffix'] = '</div>';

  // Hide the seasons field until the user has selected a show.
  $form['field_season'][LANGUAGE_NONE]['#states'] = array(
    'disabled' => array(
      ':input[name="field_show[' . LANGUAGE_NONE . ']"]' => array(
        'value' => '_none',
      ),
    ),
  );

  $form['field_season'][LANGUAGE_NONE]['#description'] = t('You must select a TV Show before selecting a season.');
  $form['field_season'][LANGUAGE_NONE]['#prefix'] = '<div id="season-wrapper">';
  $form['field_season'][LANGUAGE_NONE]['#suffix'] = '</div>';


  // Check if a value for show has already been provided.
  $selected_show = '';
  if (isset($form_state['values']['field_show'][LANGUAGE_NONE][0]['target_id'])) {
    $selected_show = $form_state['values']['field_show'][LANGUAGE_NONE][0]['target_id'];
  }
  elseif (isset($form_state['node']->field_show[LANGUAGE_NONE][0]['target_id'])) {
    $selected_show = $form_state['node']->field_show[LANGUAGE_NONE][0]['target_id'];
  }

  // If a value for show has already been provided, reset the form accordingly.
  if (!empty($selected_show)) {
    // Get the list of seasons based on the user-entered show value.
    $query = new EntityFieldQuery('entity_type', 'node');
    $query->entityCondition('bundle', 'tv_season');
    $query->fieldCondition('field_show', 'target_id', $selected_show);
    $result = $query->execute();

    // If the first element of the options aray is "- Select -" (et. al.) then
    // add it to the beginning of our new options array.
    $keys = array_keys($form['field_season'][LANGUAGE_NONE]['#options']);
    if (!is_null($keys[0]) && !is_numeric($keys[0])) {
      $options = array_slice($form['field_season'][LANGUAGE_NONE]['#options'], 0, 1);
    }
    else {
      $options = array();
    }

    // Add each season that belongs to the user-selected show to the options
    // array.
    if (isset($result['node'])) {
      $news_items_nids = array_keys($result['node']);
      $nodes = entity_load('node', $news_items_nids);
      foreach ($nodes as $node) {
        $options[$node->nid] = check_plain($node->title);
      }
    }
    else {
      drupal_set_message(t('There are no seasons associated with the show you selected. Please !url first.', array('!url' => l(t('create a season'), 'node/add/tv-season'))), 'error');
      watchdog('pub_tv', 'While creating an episode, a user chose a season that does not belong to the selected show.', array(), WATCHDOG_WARNING);
    }
    $form['field_season'][LANGUAGE_NONE]['#description'] = '';
    $form['field_season'][LANGUAGE_NONE]['#options'] = $options;
  }


  // If a user re-selects "- Select a value -" on the node add form, or if the
  // slected show has no seasons, make sure the season field is re-disabled.
  if ((isset($form_state['values']['field_show']) && is_null($form_state['values']['field_show'][LANGUAGE_NONE][0]['target_id'])) || (!empty($selected_show) && !isset($result['node']))) {
    $form['field_season'][LANGUAGE_NONE]['#disabled'] = TRUE;
  }

  $form['#attached']['js'][] = drupal_get_path('module', 'usanetwork_tv_shows') . '/js/usanetwork_tv_episode.js';

  // Add a form validator.
  $form['#validate'][] = 'usanetwork_tv_shows_episode_form_validate';
}

/**
 * Implements hook_usanetwork_overlay_prerender().
 */
function usanetwork_tv_shows_usanetwork_overlay_prerender() {
  
}

/**
 * AJAX callback function that populates the "season" entity reference field
 * with seasons for the user specifid show.
 *
 * @see usanetwork_tv_shows_form_tv_episode_node_form_alter()
 */
function usanetwork_tv_shows_season_option_populate_js($form, $form_state) {
  return $form['field_season'];
}

/**
 * Form validation for the episode node form.
 */
function usanetwork_tv_shows_episode_form_validate($form, &$form_state) {
  $selected_season = $form_state['values']['field_season'][LANGUAGE_NONE][0]['target_id'];
  $selected_show = $form_state['values']['field_show'][LANGUAGE_NONE][0]['target_id'];

  if ($selected_season) {
    $season_node = node_load($selected_season);
    if ($season_node->field_show[LANGUAGE_NONE][0]['target_id'] !== $selected_show) {
      form_set_error('field_season', t('The season you selected belongs to a different show than the show you selected on this form.'));
    }
  }
}

/**
 * Returns show assosiated with current page.
 * TODO may be depricated
 */
function _usanetwork_tv_show_menu_get_show(&$entity_type = NULL, $position = 1, $path = NULL) {
  $show = false;
  $entity = _usanetwork_menu_get_object($entity_type, $position, $path);
  if ($entity) {
    list(,, $bundle) = entity_extract_ids($entity_type, $entity);
    if ($entity_type == 'node' && $bundle == 'tv_show') {
      $show = $entity;
    }
    elseif (!empty($entity->{USANETWORK_TV_SHOWS_FIELD_NAME})) {
      $show_ref = reset(field_get_items($entity_type, $entity, USANETWORK_TV_SHOWS_FIELD_NAME));
      if ($show_ref) {
        $show = node_load($show_ref['target_id']);
      }
    }
  }

  return $show;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function usanetwork_tv_shows_form_tv_show_node_form_alter(&$form, &$form_state, $form_id) {
  $form['#attached']['js'][] = drupal_get_path('module', 'usanetwork_tv_shows') . '/js/usanetwork_tv_shows.js';
}

/**
 * Selects content related with show content.
 *
 * @param integer $limit - limits query items, 0 means that all the available
 * pieces of content should be pulled.
 *
 * @param string $sort - sorting order
 *
 * @param string $sort_by - sorting field name
 *
 * @param array $filters - consists of filters for query
 * (you may ignore this param if you want to select all the content):
 * array(
 *   'bundle' => array(
 *     'values' => array('media_gallery', 'post'),
 *     // OR 'values' => 'media_gallery',
 *     'operator' => 'IN', // default 'IN' if array and default '=' if not array
 *   ),
 * );
 */
function _usanetwork_tv_shows_get_related_content($show_id, $limit = 0, $sort = 'DESC', $sort_by = 'entity_id', $filters = array()) {
  $content_items = array();

  // Apply sorter alias for nodes
  $node_sorter = _usanetwork_tv_shows_detect_related_content_node_sorter($sort_by);

  // Apply sorter alias for files
  $file_sorter = _usanetwork_tv_shows_detect_related_content_file_sorter($sort_by);

  // Pull nodes
  $nodes = _usanetwork_tv_shows_pull_related_nodes($show_id, 0, $limit, $sort, $node_sorter, $filters);

  // Pull files
  $files = _usanetwork_tv_shows_pull_related_files($show_id, $limit, $sort, $file_sorter, $filters);

  // Merge nodes and files
  if (!empty($nodes) && !empty($files)) {
    $content_items = array_merge($nodes, $files);
  }
  elseif (!empty($nodes)) {
    $content_items = $nodes;
  }
  elseif (!empty($files)) {
    $content_items = $files;
  }

  // Sort items according sorter alias
  usort($content_items, function($a, $b) use ($node_sorter, $file_sorter, $sort) {
    $a_sorter = $a->entity_type == 'node' ? $node_sorter : $file_sorter;

    $b_sorter = $b->entity_type == 'node' ? $node_sorter : $file_sorter;

    if ($a->$a_sorter == $b->$b_sorter) {
      return 0;
    }
    else {
      if ($a->$a_sorter > $b->$b_sorter) {
        return $sort == 'ASC' ? 1 : -1;
      }
      return $sort == 'ASC' ? -1 : 1;
    }
  });

  // Crop extra elements
  if ($limit > 0) {
    array_splice($content_items, $limit);
  }

  return $content_items;
}

/**
 * Alters node filters
 */
function _usanetwork_tv_shows_detect_related_content_node_sorter($sort_by) {
  // There are no available aliases at the moment.
  return $sort_by;
}

/**
 * Alters file filters
 */
function _usanetwork_tv_shows_detect_related_content_file_sorter($sort_by) {
  $filter_aliases = array(
    'changed' => 'timestamp',
  );

  if (isset($filter_aliases[$sort_by])) {
    return $filter_aliases[$sort_by];
  }

  return $sort_by;
}

/**
 * Pulls nodes related with show content.
 *
 * @param integer $show_id - node id of the show
 *
 * @param integer $start_from - the number of records that should be ignored
 *
 * @param integer $limit - limits query items, 0 means that all the available
 * pieces of content should be pulled.
 *
 * @param string $sort - sorting order
 *
 * @param string $sort_by - sorting field name
 *
 * @param array $filters - consists of filters for query
 * (you may ignore this param if you want to select all the content):
 * array(
 *   'bundle' => array(
 *     'values' => array('media_gallery', 'post'),
 *     // OR 'values' => 'media_gallery',
 *     'operator' => 'IN', // default 'IN' if array and default '=' if not array
 *   ),
 * );
 */
function _usanetwork_tv_shows_pull_related_nodes($show_id, $start_from = 0, $limit = 0, $direction = 'DESC', $sort_by = 'changed', $filters = array()) {
  $query = db_select('field_data_field_show', 'fshow');
  $query->fields('fshow', array('entity_type', 'bundle', 'entity_id'));
  // Attach content node
  $query->join('node', 'n', 'fshow.entity_id=n.nid');
  $query->fields('n', array('nid', 'title', 'created', 'changed'));
  // Attach promo title
  $query->leftJoin('field_data_field_promo_text_line_1', 'fp_title', 'n.nid=fp_title.entity_id');
  $query->addField('fp_title', 'field_promo_text_line_1_value', 'promo_title');
  // Attach show node
  $query->join('node', 'sn', 'fshow.field_show_target_id=sn.nid');
  $query->addField('sn', 'title', 'show_title');
  // Attach associated videos for promos
  $query->leftJoin('field_data_field_promo_assoc_video', 'assoc', 'assoc.entity_id=n.nid');
  $query->addField('assoc', 'field_promo_assoc_video_target_id', 'assoc_fid');
  // Attach promo season number
  $query->leftJoin('field_data_field_mpx_season_number', 'fvp_season', 'fvp_season.entity_id=assoc.field_promo_assoc_video_target_id');
  $query->addField('fvp_season', 'field_mpx_season_number_value', 'promo_season');
  // Attach promo episode number
  $query->leftJoin('field_data_field_mpx_episode_number', 'fvp_episode', 'fvp_episode.entity_id=assoc.field_promo_assoc_video_target_id');
  $query->addField('fvp_episode', 'field_mpx_episode_number_value', 'promo_episode');
  // Attach promo duration value
  $query->leftJoin('field_data_field_mpx_duration', 'fvp_duration', 'fvp_duration.entity_id=assoc.field_promo_assoc_video_target_id');
  $query->addField('fvp_duration', 'field_mpx_duration_value', 'promo_duration');

  $query->condition('fshow.field_show_target_id', $show_id);
  $query->condition('fshow.deleted', 0);
  $query->condition('n.status', 1);
  $query->condition('fshow.entity_type', 'node');

  $query->orderBy($sort_by, $direction);

  if ($limit > 0) {
    $query->range($start_from, $limit);
  }

  if (!empty($filters)) {
    foreach ($filters as $filter_field_name => $filter_value) {
      $values = !empty($filter_value['values']) ? $filter_value['values'] : NULL;

      if (!empty($values)) {
        $operator = !empty($filter_value['operator'])
            ? $filter_value['operator']
            : (is_array($values)
                ? 'IN'
                : '='
            );

        if (is_array($values) && count($values) == 1) {
          $values = reset($values);
          $operator = '=';
        }

        $query->condition($filter_field_name, $values, $operator);
      }
    }
  }

  return $query->execute()->fetchAll();
}

/**
 * Pulls files related with show content.
 *
 * @param integer $limit - limits query items, 0 means that all the available
 * pieces of content should be pulled.
 *
 * @param string $sort - sorting order
 *
 * @param string $sort_by - sorting field name
 *
 * @param array $filters - consists of filters for query
 * (you may ignore this param if you want to select all the content):
 * array(
 *   'bundle' => array(
 *     'values' => array('media_gallery', 'post'),
 *     // OR 'values' => 'media_gallery',
 *     'operator' => 'IN', // default 'IN' if array and default '=' if not array
 *   ),
 * );
 */
function _usanetwork_tv_shows_pull_related_files($show_id, $limit = 0, $direction = 'DESC', $sort_by = 'timestamp', $filters = array(), $season_num = FALSE, $episode_num = FALSE) {
  $query = db_select('field_data_field_show', 'fshow');
  $query->fields('fshow', array('entity_type', 'bundle', 'entity_id'));
  $query->join('file_managed', 'f', 'fshow.entity_id=f.fid');
  $query->fields('f', array('created', 'timestamp'));
  $query->leftJoin('mpx_video', 'mpx_video_data', 'f.fid=mpx_video_data.fid');
  $query->addField('mpx_video_data', 'title', 'title');
  $query->join('node', 'sn', 'fshow.field_show_target_id=sn.nid');

  if ($season_num) {
    $query->leftJoin('field_data_field_mpx_season_number', 'season_num', 'f.fid=season_num.entity_id');
    $query->addField('season_num', 'field_mpx_season_number_value', 'season_number');
    $query->condition('season_num.field_mpx_season_number_value', $season_num);
  }
  
  if ($episode_num) {
    $query->leftJoin('field_data_field_mpx_episode_number', 'episode_num', 'f.fid=episode_num.entity_id');
    $query->addField('episode_num', 'field_mpx_episode_number_value', 'episode_number');
    $query->condition('episode_num.field_mpx_episode_number_value', $episode_num);
  }

  $query->addField('sn', 'title', 'show_title');
  $query->condition('fshow.field_show_target_id', $show_id);
  $query->condition('fshow.deleted', 0);
  $query->condition('fshow.entity_type', 'file');
  $db_or = db_or();
  $db_or->condition('mpx_video_data.status', 1);
  $db_or->isNull('mpx_video_data.status');
  $query->condition($db_or);

  $query->orderBy($sort_by, $direction);

  if ($limit > 0) {
    $query->range(0, $limit);
  }

  if (!empty($filters)) {
    foreach ($filters as $filter_field_name => $filter_value) {
      $values = !empty($filter_value['values']) ? $filter_value['values'] : NULL;

      if (!empty($values)) {
        $operator = !empty($filter_value['operator'])
            ? $filter_value['operator']
            : (is_array($values)
                ? 'IN'
                : '='
            );

        $query->condition($filter_field_name, $values, $operator);
      }
    }
  }

  return $query->execute()->fetchAll();
}

/**
 * Renders content from returned settings array of "_usanetwork_tv_shows_get_related_content()".
 *
 * @param array $query_result - the result of "_usanetwork_tv_shows_get_related_content()"
 * @param array $content_view_modes - array of applicable view modes for content:
 * array(
 *   'view_mode_name' => array(
 *     'node' => array(           // applies only for listed nodes
 *       'node_bundle_name1',
 *       'node_bundle_name2'
 *     ),
 *   ),
 *   'view_mode_name2' => array(
 *     'node' => array(),         // applies for all listed nodes
 *     'file' => array('image'),  // applies for files with type "image"
 *   ),
 * );
 */
function _usanetwork_tv_shows_render_related_content($query_result, $content_view_modes) {
  $content = array();

  if (!empty($query_result) && !empty($content_view_modes)) {
    foreach ($query_result as $query_item) {
      $view_mode = _usanetwork_tv_shows_detect_related_content_view_mode($query_item, $content_view_modes);

      if (!empty($view_mode)) {
        $content[] = _usanetwork_tv_shows_render_related_content_item($query_item, $view_mode);
      }
    }
  }

  return $content;
}

/**
 * Pulls related video from all shows instead $ignore_show_nids.
 */
function _usanetwork_tv_shows_pull_videos($ignore_show_nids = array(), $start_from = 0, $limit = 0) {
  $query = db_select('file_managed', 'f');
  $query->fields('f', array('fid'));
  $query->addField('f', 'uri', 'image_uri'); // URI should be returned with alias
  // Join show IDs
  $query->leftJoin('field_data_field_show', 'field_show', 'f.fid=field_show.entity_id');
  $query->addField('field_show', 'field_show_target_id', 'show_nid');
  // Join show node
  $query->leftJoin('node', 'show_node', 'field_show.field_show_target_id=show_node.nid');
  $query->addField('show_node', 'title', 'show_title');
  // Join full episode flag
  $query->leftJoin('field_data_field_mpx_full_episode', 'field_full', 'f.fid=field_full.entity_id');
  $query->addField('field_full', 'field_mpx_full_episode_value', 'is_full');
  // Join video duration
  $query->leftJoin('field_data_field_mpx_duration', 'field_duration', 'f.fid=field_duration.entity_id');
  $query->addField('field_duration', 'field_mpx_duration_value', 'duration');
  // Join season number
  $query->leftJoin('field_data_field_mpx_season_number', 'field_season', 'f.fid=field_season.entity_id');
  $query->addField('field_season', 'field_mpx_season_number_value', 'season_number');
  // Join episode number
  $query->leftJoin('field_data_field_mpx_episode_number', 'field_episode', 'f.fid=field_episode.entity_id');
  $query->addField('field_episode', 'field_mpx_episode_number_value', 'episode_number');
  // Join mpx_video data
  $query->leftJoin('mpx_video', 'v', 'f.fid=v.fid');
  $query->addField('v', 'title', 'video_title');

  $query->condition('v.status', 1);
  $query->orderBy('v.airdate', 'DESC');

  if (!empty($ignore_show_nids)) {
    if (count($ignore_show_nids) == 1) {
      $query->condition('field_show.field_show_target_id', reset($ignore_show_nids), '<>');
    }
    else {
      $query->condition('field_show.field_show_target_id', $ignore_show_nids, 'NOT IN');
    }
  }

  if ($limit > 0) {
    $query->range($start_from, $limit);
  }

  return $query->execute()->fetchAll();
}

/**
 * Renders related content item from db_select array.
 */
function _usanetwork_tv_shows_render_related_content_item($query_item, $view_mode) {
  $content_item = array();

  switch ($query_item->entity_type) {
    case 'node':
      $content_item = node_view(node_load($query_item->entity_id), $view_mode);
      break;

    case 'file':
      $content_item = file_view(file_load($query_item->entity_id), $view_mode);
      break;
  }

  return !empty($content_item) ? render($content_item) : '';
}

/**
 * Detects first available view mode for related content item.
 */
function _usanetwork_tv_shows_detect_related_content_view_mode($query_item, $content_view_modes) {
  foreach ($content_view_modes as $view_mode_name => $view_mode_elements) {
    if (isset($view_mode_elements[$query_item->entity_type])) {
      if (empty($view_mode_elements[$query_item->entity_type])) {
        return $view_mode_name;
      }
      else {
        if (in_array($query_item->bundle, $view_mode_elements[$query_item->entity_type])) {
          return $view_mode_name;
        }
      }
    }

    return NULL;
  }
}

/**
 * Render shows menu items
 */
function usanetwork_tv_shows_footer_links() {
  $query_result = views_get_view_result('usa_nav', 'block');
  $links = array();
  foreach ($query_result as $row) {
    $new = '';
    if ($row->flag_content_node_timestamp) {
      $new = '<span>' . t('New!') . '</span> ';
    }
    $links[] = array(
      'data' => l($new . $row->node_title, 'node/' . $row->nid, array('html' => TRUE)),
      'class' => array(
        'menu-item'
      ),
    );
  }
  return theme('usanetwork_item_list', array(
    'warpper_attributes' => array(
      'class' => array(
        'shows-menu',
      ),
    ),
    'title_tag' => 'h2',
    'title_attributes' => array(
      'class' => array(
        'menu-title',
        'shows-menu-title',
      ),
    ),
    'title' => t('Shows'),
    'items' => $links,
    'type' => 'ul',
    'attributes' => array(
      'class' => array(
        'menu'
      )
    ),
      )
  );
}

/**
 * Renders A-Spot block for Show.
 */
function _usanetwork_tv_shows_aspot_block() {
  $show_node = _usanetwork_menu_show_menu_get_current_show_node();

  if (!empty($show_node)) {
    $show_episodes = usanetwork_schedule_pull_latest_episodes($show_node->nid, 5);

    $theme_variables = array(
      'show' => usanetwork_aspot_render($show_node),
      'episodes' => array(),
    );

    if (!empty($show_episodes)) {
      foreach ($show_episodes as $episode_data) {
        $episode_file = file_load($episode_data->fid);
        $episode_image_uri = '';

        $episode_image_uri_wrapper = file_stream_wrapper_get_instance_by_uri($episode_file->uri);

        if ($episode_image_uri_wrapper) {
          $episode_image_uri = $episode_image_uri_wrapper->getLocalThumbnailPath();
        }

        $episode_theme_variables = array(
          'url' => url('file/' . $episode_data->fid),
          'title' => $episode_data->title,
          'series_and_number' => 'S' . $episode_data->field_mpx_season_number_value . ' ' . t('Episode') . ' ' . $episode_data->field_mpx_episode_number_value,
          'duration' => gmdate('H:i:s', $episode_data->field_mpx_duration_value),
          'image_url' => image_style_url('300x169_video', $episode_image_uri),
        );

        $theme_variables['episodes'][] = $episode_theme_variables;
      }
    }

    if (!empty($theme_variables)) {
      return theme('usanetwork_tv_shows_aspot', $theme_variables);
    }
  }

  return '';
}

/**
 * Renders "Catch up, Explore block".
 */
function _usanetwork_tv_shows_catchup_explore_block() {
  $show_node = _usanetwork_menu_show_menu_get_current_show_node();

  if (!empty($show_node)) {

    $theme_variables = array();
    //Analyze catch-up carousel
    $theme_variables['is_catch_up'] = FALSE;
    for ($i = 1; $i <= USANETWORK_TV_SHOWS_CAROUSEL_NUMBER; $i++) {
      $field_ctchup_carousel = field_get_items('node', $show_node, "field_ctchup_carousel_$i");
      if ($field_ctchup_carousel) {
        $theme_variables['is_catch_up'] = TRUE;
        $theme_variables['catch_up'][$i]['elements'] = _usanetwork_tv_shows_get_cuexcarousel($field_ctchup_carousel);
        $theme_variables['catch_up'][$i]['caption'] = _usanetwork_get_field_item('node', $show_node, "field_ctchup_pretitle_$i", 'value');
        $theme_variables['catch_up'][$i]['title'] = _usanetwork_get_field_item('node', $show_node, "field_ctchup_title_$i", 'value');
        $theme_variables['catch_up'][$i]['additional_text'] = _usanetwork_get_field_item('node', $show_node, "field_ctchup_posttitle_$i", 'value');
        $theme_variables['catch_up'][$i]['carousel_position'] = ($i % 2 == 0) ? 'right'
              : 'left';
      }
    }

    //Analyze explore carousel
    $theme_variables['is_explore'] = FALSE;
    for ($i = 1; $i <= USANETWORK_TV_SHOWS_CAROUSEL_NUMBER; $i++) {
      $field_explr_carousel = field_get_items('node', $show_node, "field_explr_carousel_$i");
      if ($field_explr_carousel) {
        $theme_variables['is_explore'] = TRUE;
        $theme_variables['explore'][$i]['elements'] = _usanetwork_tv_shows_get_cuexcarousel($field_explr_carousel);
        $theme_variables['explore'][$i]['caption'] = _usanetwork_get_field_item('node', $show_node, "field_explr_pretitle_$i", 'value');
        $theme_variables['explore'][$i]['title'] = _usanetwork_get_field_item('node', $show_node, "field_explr_title_$i", 'value');
        $theme_variables['explore'][$i]['additional_text'] = _usanetwork_get_field_item('node', $show_node, "field_explr_posttitle_$i", 'value');
        $theme_variables['catch_up'][$i]['carousel_position'] = ($i % 2 == 0) ? 'right'
              : 'left';
      }
    }

    if (!empty($theme_variables)) {
      $tets = theme('usanetwork_tv_shows_catchup_explore', $theme_variables);
      return $tets;
    }
  }

  return '';
}

/**
 * Wraps elements for "Catch Up - Explore" block carousel.
 */
function _usanetwork_tv_shows_get_cuexcarousel($carousel) {
  $items = array();

  foreach ($carousel as $show_number => $carousel_item) {
    $episode_class = NULL;

    if ($show_number == 0) {
      $episode_class = 'first';
    }

    if ($show_number == count($carousel) - 1) {
      $episode_class = 'last';
    }

    $promo = _usanetwork_promo_featured_content($carousel_item['target_id']);

    $theme_variables = array(
      'class' => $promo['show_class'],
      'title' => $promo['caption'],
      'title' => $promo['title'],
      'additional' => array(
        'normal' => NULL,
        'span' => NULL,
      ),
      'media_player_icon' => $promo['icon-type'],
    );

    $items[] = theme('usanetwork_tv_shows_catchup_explore_content_element', $theme_variables);
  }

  return $items;
}

/**
 * Counts number of images in media gallery with nid=$node_nid.
 */
function _usanetwork_tv_shows_get_media_items_count($node_nid) {
  $query = db_select('field_data_field_media_items', 'fmi');
  $query->condition('fmi.entity_id', $node_nid);
  $query->addExpression('COUNT(*)');

  $result = $query->execute()->fetchCol();

  if (is_array($result)) {
    return reset($result);
  }

  return $result;
}

/**
 * Returns human-readable aliases of node content types for consumptionator page.
 */
function _usanetwork_tv_shows_get_content_type_aliases() {
  return array(
    'media_gallery' => t('Gallery'),
    'usanetwork_promo' => t('Promo'),
  );
}

function _usanetwork_tv_shows_get_content_image_url($node) {
  if (!is_object($node)) {
    $node = node_load($node);
  }

  if ($node) {
    $field_name = '';
    $image_uri = 0;

    switch ($node->type) {
      case 'media_gallery':
        $field_name = 'field_cover_item';
        break;

      case 'usanetwork_promo':
        $field_name = 'field_promo_regular_image';
        break;
    }

    if (!empty($field_name)) {
      $field_item = field_get_items('node', $node, $field_name);

      if (!empty($field_item)) {
        $image_uri = $field_item[0]['uri'];
      }
    }

    return $image_uri;
  }

  return '';
}

function _usanetwork_tv_shows_submenu() {
  $show = menu_get_object();

  if (!is_object($show) || (!isset($show->type) && $show->type != 'tv_show')) {
    return '';
  }

  $display_title = field_get_items('node', $show, 'field_display_title');
  if (is_array($display_title) && !empty($display_title[0]['safe_value'])) {
    $show_title = $display_title[0]['safe_value'];
  }
  else {
    $show_title = $show->title;
  }
  $show_title = decode_entities($show_title);
  $usa_tv_tune_in_date = field_get_items('node', $show, 'field_usa_tv_tune_in_date');
  if (is_array($usa_tv_tune_in_date) && !empty($usa_tv_tune_in_date[0]['value'])) {
    $show_tunein = explode(' ', $usa_tv_tune_in_date[0]['value']);
    $show_weekday = array_shift($show_tunein);
    $show_time = implode(' ', $show_tunein);
  }

  $social_links = array();
  foreach (array('facebook', 'twitter', 'instagram', 'pinterest', 'youtube', 'googleplus') as $social_network) {
    $social_bar_link_field = field_get_items('node', $show, 'field_usa_link_' . $social_network);
    if ($social_bar_link_field) {
      $social_links[] = l('', $social_bar_link_field[0]['url'], array('attributes' => array('class' => $social_network)));
    }
  }

  $promo_target = field_get_items('node', $show, 'field_featured_in_menu');
  if ($promo_target) {
    $promo_item = node_load($promo_target[0]['target_id']);
    $promo_image = field_get_items('node', $promo_item, 'field_promo_regular_image');
    $promo_link = field_get_items('node', $promo_item, 'field_promo_link');
    $promo_text_line1 = field_get_items('node', $promo_item, 'field_promo_text_line_1');
    $promo_text_line2 = field_get_items('node', $promo_item, 'field_promo_text_line_2');

    if ($promo_image) {
      $preview_image = theme('image_style', array(
        'style_name' => 'episode_preview_temp',
        'path' => $promo_image[0]['uri'],
      ));
    }

    if ($promo_link) {
      $promo_link_url = $promo_link[0]['url'];
    }

    if ($promo_text_line1) {
      $promo_text_title = $promo_text_line1[0]['value'];
    }

    if ($promo_text_line2) {
      $promo_text_caption = $promo_text_line2[0]['value'];
    }
  }

  $show_menus = array();
  $promo_menu_links = field_get_items('node', $show, 'field_show_links');
  if ($promo_menu_links) {
    foreach ($promo_menu_links as $key => $link) {
      $show_menu_item = entity_load('field_collection_item', array($link['value']));
      $show_menu_item_child = field_get_items('field_collection_item', reset($show_menu_item), 'field_child_link');
      if ($show_menu_item_child) {
        $show_menus[$key]['child'] = array();
        foreach ($show_menu_item_child as $child_link) {
          $show_menus[$key]['child'][] = l($child_link['title'], $child_link['url']);
        }
      }
      $show_menu_item_main_link = field_get_items('field_collection_item', reset($show_menu_item), 'field_main_link');
      if ($show_menu_item_main_link) {
        $show_menus[$key]['main_link'] = l(drupal_ucfirst($show_menu_item_main_link[0]['title']), $show_menu_item_main_link[0]['url']);
      }
    }
  }

  return theme('usanetwork_tv_shows_submenu', array(
    'show_title' => $show_title,
    'weekday' => $show_weekday,
    'time' => $show_time,
    'social_icons' => $social_links,
    'show_menu_video_url' => isset($promo_link_url)
      ? $promo_link_url
      : NULL,
    'show_menu_video_img' => isset($preview_image)
      ? $preview_image
      : NULL,
    'show_menu_video_title' => isset($promo_text_title)
      ? $promo_text_title
      : NULL,
    'show_menu_video_caption' => isset($promo_text_caption)
      ? $promo_text_caption
      : NULL,
    'show_menu_tab_items' => $show_menus,
  ));
}

function _usanetwork_tv_shows_discription_item($show, $field_list, &$description_vars) {
  
  foreach ($field_list as $target => $field_name) {
    $field_value = field_get_items('node', $show, $field_name);
    if ($field_value) {
      $field = reset($field_value);

      switch ($target) {
        case 'title':
          $description_vars['title'] = $field['value'];
          break;
        case 'caption':
          $description_vars['caption'] = $field['value'];
          break;
        case 'additional_text':
          $description_vars['additional_text'] = $field['value'];
          break;
        default:
          break;
      }
    }
  }
}

function _usanetwork_tv_shows_latest($show) {
  $related_to_show = _usanetwork_tv_shows_get_related_content($show->nid, 20);

  $description_vars = array(
    'caption' => t('All new!'),
    'title' => t('Latest'),
    'additional_text' => t('Photos, polls & more'),
  );
  
  _usanetwork_tv_shows_discription_item($show, array('title' => 'field_hp_promos_block_title', 'caption' => 'field_caption_text', 'additional_text' => 'field_additional_text'), $description_vars);

  $output[] = theme('usanetwork_home_carousel_description_item', $description_vars);


  foreach ($related_to_show as $entity_data) {
    $entity = entity_load_single($entity_data->entity_type, $entity_data->entity_id);

    if ($entity_data->entity_type == 'node') {
      $type = $entity_data->bundle;
    }
    else if ($entity_data->entity_type == 'file') {
      $type = $entity->filemime;
    }
    else {
      continue;
    }

    $related_content_data = _usanetwork_related_content($type, $entity, FALSE);

    if ($related_content_data['season_number'] && $related_content_data['episode_number']) {
      $additional = t('S@season_num episode @episode_num', array(
        '@season_num' => $related_content_data['season_number']['value'],
        '@episode_num' => $related_content_data['episode_number']['value']
          )
      );
    }

    $image = theme_image_style(array(
      'style_name' => '300x250',
      'path' => $related_content_data['image_url'],
      'width' => 300,
      'height' => 250,
    ));

    $latest_items[] = theme('usanetwork_tv_shows_latest_item', array(
      'item_title' => NULL,
      'show_class' => NULL,
      'url' => $related_content_data['url'],
      'show_title' => $show->title,
      'additional' => isset($additional)
          ? $additional
          : NULL,
      'duration' => $related_content_data['time'],
      'icon_type' => $related_content_data['icon_type'],
      'image' => $image,
        )
    );
  }
  $output[] = theme('usanetwork_item_list', array(
    'warpper_attributes' => array(
      'class' => array(
        'carousel',
        'carousel-left',
        'start',
      ),
    ),
    'title_tag' => 'h2',
    'title_attributes' => array(
      'class' => NULL
    ),
    'title' => NULL,
    'items' => $latest_items,
    'type' => 'ul',
    'attributes' => array(),
    'suffix' => array()
  ));
  return implode(PHP_EOL, $output);
}
