<?php
/**
 * @file
 * Code for the usanetwork_tve_video feature.
 */

include_once 'usanetwork_tve_video.features.inc';

function usanetwork_tve_video_theme_registry_alter(&$theme_registry) {
  if (isset($theme_registry['tve_auth_welcome_window'])) {
    $theme_registry['tve_auth_welcome_window']['template'] = drupal_get_path('module', 'usanetwork_tve_video').'/templates/tve_auth_welcome_window';
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function usanetwork_tve_video_preprocess_pub_mpx_video(&$variables, $hook) {
  usanetwork_tve_video_add_custom_player_variables($variables, 'vod');
}

/**
 * Implements hook_preprocess_HOOK().
 */
function usanetwork_tve_video_preprocess_usanetwork_tve_live_video(&$variables, $hook) {
  usanetwork_tve_video_add_custom_player_variables($variables, 'live');
}

/**
 * Adds the extra advertisement/other custom parameters to the player iframe src.
 *
 * @param $variables
 * @param string $type
 */
function usanetwork_tve_video_add_custom_player_variables(&$variables, $type = 'vod') {
  if (empty($variables)) {
    $variables['pub_mpx_player_parameters'] = array();
  }
  $mvpd_id = '';
  if (isset($_COOKIE['nbcu_user_settings']) && is_string($_COOKIE['nbcu_user_settings'])) {
    // Gets the logged in user mvpd provider and passes it to player for freewheel ads.
    $cookie_value = (array) drupal_json_decode($_COOKIE['nbcu_user_settings']);
    // Validate variable.
    if ($cookie_value) {
      $mvpd_id = isset($cookie_value['selectedProvider']) ? $cookie_value['selectedProvider'] : '';
    }
  }
  
  $variables['pub_mpx_player_parameters']['mbr'] = 'true';
  
  if (!empty($mvpd_id)) {
    $variables['pub_mpx_player_parameters']['MVPDid'] = $mvpd_id;
  }
}

/**
 * Implements hook_theme().
 */
function usanetwork_tve_video_theme($existing, $type, $theme, $path) {
  return array(
    'usanetwork_tve_live_video' => array(
      'variables' => array(
        'file' => NULL,
        'player_id' => NULL,
        'width' => NULL,
        'height' => NULL,
      ),
    ),
    'usanetwork_tve_video_auth_menu' => array(
      'variables' => array(),
      'template' => 'templates/usanetwork-tve-video-auth-menu',
    ),
  );
}

/**
 * Theme function to render live video.
 */
function theme_usanetwork_tve_live_video($variables) {

  $file = (object) $variables['file'];

  $mpx_account = _media_theplatform_mpx_get_account_data($file->mpx_video_data['parent_account']);
  $mpx_account_pid = $mpx_account->account_pid;
  $mpx_account_default_player = media_theplatform_mpx_get_mpx_player_by_player_id($mpx_account->default_player);

  $player_id = !empty($variables['player_id']) ? $variables['player_id'] :
      (!empty($file->mpx_player_data['pid']) ? $file->mpx_player_data['pid'] : $mpx_account_default_player['pid']);

  $player_source = '//player.theplatform.com/p/' . $mpx_account_pid . '/' . $player_id;
  $player_parameters = array(
    'query' => (isset($variables['pub_mpx_player_parameters']) ? $variables['pub_mpx_player_parameters'] : array()),
    'external' => true,
  );
  $iframe_tag = array();
  $iframe_tag['element']['#tag'] = 'iframe';
  $iframe_tag['element']['#value'] = 'Your browser does not support iframes.';
  $iframe_tag['element']['#attributes'] = array(
    'src' => url($player_source, $player_parameters),
    'frameborder' => 0,
    'allowfullscreen' => '',
    'id' => 'pdk-player',
  );

  if (!empty($variables['width'])) {
    $iframe_tag['element']['#attributes']['width'] = $variables['width'];
  }
  if (!empty($variables['height'])) {
    $iframe_tag['element']['#attributes']['height'] = $variables['height'];
  }

  return theme('html_tag', $iframe_tag);
}

/*
 * Helper function for determine video page
 */
function _usanetwork_tve_video_is_video_page() {
  $is_video_page = FALSE;
  $current_menu_item = menu_get_item();
  $current_menu_item_path = $current_menu_item['path'];

  if (($current_menu_item_path == 'videos/live') || ($current_menu_item_path == 'node/%/microsite')) {
    $is_video_page = TRUE;
  } else {
    $file = menu_get_object('file');
    if ($file) {
      $is_video_page = TRUE;
    }
  }

  return $is_video_page;
}

/*
 * Implements hook_js_alter().
 */
function usanetwork_tve_video_js_alter(&$javascript) {
//  if (path_is_admin(current_path())) {
  $view_tve_script = _usanetwork_tve_video_is_video_page();
  if (!$view_tve_script) {
    $tve_analytics_js_path = drupal_get_path('module', 'pub_analytics') . '/js/tve-analytics.js';
    if (isset($javascript[$tve_analytics_js_path])) {
      unset($javascript[$tve_analytics_js_path]);
    }
    $drupal_settings = $javascript['settings']['data'];
    foreach ($drupal_settings as $key => $value) {
      if (array_key_exists('tve_mvpd', $value)) {
        unset($javascript['settings']['data'][$key]);
      }
      if (array_key_exists('tve_auth', $value)) {
        unset($javascript['settings']['data'][$key]);
      }
    }
  }
}

/**
 * Implements hook_page_alter().
 *
 * Trying fix more button issue 
 */
function usanetwork_tve_video_page_alter(&$page) {
//  if (path_is_admin(current_path())) {
  $view_tve_script = _usanetwork_tve_video_is_video_page();
  if (!$view_tve_script) {
    if (isset($page['page_bottom']['tve_adobe_pass'])) {
      unset($page['page_bottom']['tve_adobe_pass']);
    }
    if (isset($page['page_bottom']['tve_auth_modal_windows'])) {
      unset($page['page_bottom']['tve_auth_modal_windows']);
    }
    if (isset($page['page_bottom']['tve_auth'])) {
      unset($page['page_bottom']['tve_auth']);
    }
  }
}

/**
 * Implements hook_block_info().
 */
function usanetwork_tve_video_block_info() {
  $blocks['usanetwork_tve_video_auth_menu'] = array(
    'info' => t('MPX Sign In Block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
    'region' => 'header',
    'status' => 0,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function usanetwork_tve_video_block_view($delta = '') {
  $block = array();
  if ('usanetwork_tve_video_auth_menu' == $delta) {
    $block['content'] =  usanetwork_tve_video_auth_menu();
  }

  return $block;
}

/**
 * Realization of usanetwork_tve_video_auth_menu block
 */
function usanetwork_tve_video_auth_menu() {
  $menu_items = _usa_auth_prepare_menu_items();
  $auth_links = array(
    '#theme' => 'item_list',
    '#items' => $menu_items,
    '#attributes' => array('class' => array('tve-header-links', 'inline')),
    '#prefix' => '<div class="links-wrapper">',
    '#suffix' => '</div>',
  );
  $theme_variables = array(
    'authbar' => drupal_render($auth_links),
  );
  return theme('usanetwork_tve_video_auth_menu', $theme_variables);
}


/**
 * Process variables for file_entity.
 */
function usanetwork_tve_video_preprocess_file_entity(&$vars) {
  $file = $vars['file'];
  if (in_array($file->type, _pub_mpx_get_mpx_account_video_file_types(TRUE))) {
    if (isset($vars['view_mode']) && $vars['view_mode'] == 'full') {
      drupal_add_js(drupal_get_path('module', 'usanetwork_tve_video') . '/js/usa_config_tve_auth2/usa-tve-endcard.js', array('scope' => 'footer', 'weight' => -1));
    }
  }
}
