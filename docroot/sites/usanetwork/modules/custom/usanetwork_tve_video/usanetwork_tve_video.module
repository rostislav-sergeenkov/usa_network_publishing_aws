<?php
/**
 * @file
 * Code for the usanetwork_tve_video feature.
 */

include_once 'usanetwork_tve_video.features.inc';

/**
 * Implements hook_theme_registry_alter().
 */
function usanetwork_tve_video_theme_registry_alter(&$theme_registry) {
  if (isset($theme_registry['tve_auth_welcome_window'])) {
    $theme_registry['tve_auth_welcome_window']['template'] = drupal_get_path('module', 'usanetwork_tve_video').'/templates/tve_auth_welcome_window';
  }
  if (isset($theme_registry['tve_auth2_login_window'])) {
    $theme_registry['tve_auth2_login_window']['template'] = drupal_get_path('module', 'usanetwork_tve_video').'/templates/usa_tve_auth2_login_window';
  }
  if (isset($theme_registry['tve_auth2_errors_window'])) {
    $theme_registry['tve_auth2_errors_window']['template'] = drupal_get_path('module', 'usanetwork_tve_video').'/templates/usa_tve_auth2_errors_window';
  }
  if (isset($theme_registry['tve_auth2_welcome_window'])) {
    $theme_registry['tve_auth2_welcome_window']['template'] = drupal_get_path('module', 'usanetwork_tve_video').'/templates/usa_tve_auth2_welcome_window';
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function usanetwork_tve_video_preprocess_pub_mpx_video(&$variables, $hook) {
  usanetwork_tve_video_add_custom_player_variables($variables, 'vod');
}

/**
 * Implements hook_preprocess_HOOK().
 * Deprecated
 */
function usanetwork_tve_video_preprocess_usanetwork_tve_live_video(&$variables, $hook) {
  usanetwork_tve_video_add_custom_player_variables($variables, 'live');
}

/**
 * Adds the extra advertisement/other custom parameters to the player iframe src.
 *
 * @param $variables
 * @param string $type
 */
function usanetwork_tve_video_add_custom_player_variables(&$variables, $type = 'vod') {
  if (empty($variables)) {
    $variables['pub_mpx_player_parameters'] = array();
  }
  $mvpd_id = '';
  if (isset($_COOKIE['nbcu_user_settings']) && is_string($_COOKIE['nbcu_user_settings'])) {
    // Gets the logged in user mvpd provider and passes it to player for freewheel ads.
    $cookie_value = (array) drupal_json_decode($_COOKIE['nbcu_user_settings']);
    // Validate variable.
    if ($cookie_value) {
      $mvpd_id = isset($cookie_value['selectedProvider']) ? $cookie_value['selectedProvider'] : '';
    }
  }
  
  $variables['pub_mpx_player_parameters']['mbr'] = 'true';
  
  if (!empty($mvpd_id)) {
    $variables['pub_mpx_player_parameters']['MVPDid'] = $mvpd_id;
  }
}

/**
 * Implements hook_theme().
 */
function usanetwork_tve_video_theme($existing, $type, $theme, $path) {
  return array(
    //Deprecated
    'usanetwork_tve_live_video' => array(
      'variables' => array(
        'file' => NULL,
        'player_id' => NULL,
        'width' => NULL,
        'height' => NULL,
      ),
    ),
    'usanetwork_tve_player_mpx_video' => array(
      'variables' => array(
        'file' => NULL,
        'player_id' => NULL,
        'width' => NULL,
        'height' => NULL,
      ),
    ),
    'usanetwork_tve_login_menu' => array(
      'variables' => array(
      ),
      'template' => 'templates/usanetwork-tve-login-menu',
    ),
    'usa_tve_auth2_login_modal_status' => array(
      'template' => 'templates/usa_tve_auth2_login_modal_status',
    ),
  );
}

/**
 * Theme function to render live video.
 * Deprecated
 */
function theme_usanetwork_tve_live_video($variables) {

  $file = (object) $variables['file'];

  $mpx_account = _media_theplatform_mpx_get_account_data($file->mpx_video_data['parent_account']);
  $mpx_account_pid = $mpx_account->account_pid;
  $mpx_account_default_player = media_theplatform_mpx_get_mpx_player_by_player_id($mpx_account->default_player);

  $player_id = !empty($variables['player_id']) ? $variables['player_id'] :
      (!empty($file->mpx_player_data['pid']) ? $file->mpx_player_data['pid'] : $mpx_account_default_player['pid']);

  $player_source = '//player.theplatform.com/p/' . $mpx_account_pid . '/' . $player_id;
  $player_parameters = array(
    'query' => (isset($variables['pub_mpx_player_parameters']) ? $variables['pub_mpx_player_parameters'] : array()),
    'external' => true,
  );
  $iframe_tag = array();
  $iframe_tag['element']['#tag'] = 'iframe';
  $iframe_tag['element']['#value'] = 'Your browser does not support iframes.';
  $iframe_tag['element']['#attributes'] = array(
    'src' => url($player_source, $player_parameters),
    'frameborder' => 0,
    'allowfullscreen' => '',
    'id' => 'pdk-player',
  );

  if (!empty($variables['width'])) {
    $iframe_tag['element']['#attributes']['width'] = $variables['width'];
  }
  if (!empty($variables['height'])) {
    $iframe_tag['element']['#attributes']['height'] = $variables['height'];
  }

  return theme('html_tag', $iframe_tag);
}

/*
 * Helper function for determine video page
 */
function _usanetwork_tve_video_is_video_page() {
  $is_video_page = FALSE;
  $current_menu_item = menu_get_item();
  $current_menu_item_path = $current_menu_item['path'];

  if (($current_menu_item_path == 'videos/live') || ($current_menu_item_path == 'node/%/microsite')) {
    $is_video_page = TRUE;
  } else {
    $file = menu_get_object('file');
    if ($file) {
      $is_video_page = TRUE;
    }
  }

  return $is_video_page;
}

/*
 * Implements hook_js_alter().
 */
function usanetwork_tve_video_js_alter(&$javascript) {
//  if (path_is_admin(current_path())) {
  $view_tve_script = _usanetwork_tve_video_is_video_page();
  if (!$view_tve_script) {
    $tve_analytics_js_path = drupal_get_path('module', 'pub_analytics') . '/js/tve-analytics.js';
    if (isset($javascript[$tve_analytics_js_path])) {
      unset($javascript[$tve_analytics_js_path]);
    }
  }
}

/**
 * Implements hook_page_alter().
 *
 * Trying fix more button issue 
 */
function usanetwork_tve_video_page_alter(&$page) {
//  if (path_is_admin(current_path())) {
  $view_tve_script = _usanetwork_tve_video_is_video_page();
  if (!$view_tve_script) {
    if (isset($page['page_bottom']['tve_adobe_pass'])) {
      unset($page['page_bottom']['tve_adobe_pass']);
    }
    if (isset($page['page_bottom']['tve_auth_modal_windows'])) {
      unset($page['page_bottom']['tve_auth_modal_windows']);
    }
    if (isset($page['page_bottom']['tve_auth'])) {
      unset($page['page_bottom']['tve_auth']);
    }
  } else {
    // Attach hidden modal windows to the bottom of the page.
    $usa_modal_windows_html = theme('usa_tve_auth2_login_modal_status');
    $page['page_bottom']['usanetwork_tve_video_modal_windows'] = array(
        '#markup' => $usa_modal_windows_html,
    );
  }
}

/**
 * Implements hook_library_alter().
 * Remove TVE js and css that don't work for usa
 */
function usanetwork_tve_video_library_alter(&$libraries, $module) {
  if ($module == 'tve_auth2') {
    if (isset($libraries['tve_auth2'])) {
      unset($libraries['tve_auth2']['js'][libraries_get_path('tve') . '/dist/auth/tve-auth' . _tve_auth2_js_extension()]);
      unset($libraries['tve_auth2']['css']);
    }
  }
}


/**
 * Implements hook_block_info().
 */
function usanetwork_tve_video_block_info() {
  $blocks['usanetwork_tve_video_auth_menu'] = array(
    'info' => t('MPX Sign In Block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
    'region' => 'header',
    'status' => 0,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function usanetwork_tve_video_block_view($delta = '') {
  $block = array();
  if ('usanetwork_tve_video_auth_menu' == $delta) {
    $block['content'] =  usanetwork_tve_video_auth_menu();
  }

  return $block;
}

/**
 * Realization of usanetwork_tve_video_auth_menu block
 */
function usanetwork_tve_video_auth_menu() {
  return theme('usanetwork_tve_login_menu');
}

/**
 * Process variables for file_entity.
 */
function usanetwork_tve_video_preprocess_file_entity(&$vars) {
  $file = $vars['file'];
  if (in_array($file->type, _pub_mpx_get_mpx_account_video_file_types(TRUE))) {
    if (isset($vars['view_mode']) && $vars['view_mode'] == 'full') {
      drupal_add_js(drupal_get_path('module', 'usanetwork_tve_video') . '/js/usa_config_tve_auth2/usa-tve-auth2.js', array('scope' => 'footer', 'weight' => -2));
      drupal_add_js(drupal_get_path('module', 'usanetwork_tve_video') . '/js/usa_config_tve_auth2/usa-tve-custom-services.js', array('scope' => 'footer', 'weight' => 0));
      drupal_add_js(drupal_get_path('module', 'usanetwork_tve_video') . '/js/usa_config_tve_auth2/usa-tve-endcard.js', array('scope' => 'footer', 'weight' => 1));
      drupal_add_js(drupal_get_path('module', 'usanetwork_tve_video') . '/js/usa_config_tve_auth2/usa-tve-login-button.js', array('scope' => 'footer', 'weight' => 2));
      drupal_add_js(drupal_get_path('module', 'usanetwork_tve_video') . '/js/usa_config_tve_auth2/usa-tve-logout-button.js', array('scope' => 'footer', 'weight' => 3));
      drupal_add_js(drupal_get_path('module', 'usanetwork_tve_video') . '/js/usa_config_tve_auth2/usa-tve-player-container.js', array('scope' => 'footer', 'weight' => 4));
    }
  }
}

/*
 * Theme for player
 */
function theme_usanetwork_tve_player_mpx_video($variables) {
  _tve_player_add_custom_player_variables($variables, 'vod');

  $file = (object) $variables['file'];
  if (!isset($file->fid)) {
    return _tve_player_error('Could not render player: Invalid file object.');
  }

  $mpx_account = _media_theplatform_mpx_get_account_data($file->mpx_video_data['parent_account']);
  $mpx_account_default_player = media_theplatform_mpx_get_mpx_player_by_player_id($mpx_account->default_player);

  $player = pub_mpx_player_data_load($file);
  $player_id = !empty($variables['player_id']) ? $variables['player_id'] :
    (!empty($player['pid']) ? $player['pid'] : $mpx_account_default_player['pid']);

  $player = _usanetwork_media_theplatform_mpx_get_mpx_player_by_pid($player_id);

  $player_pid = !empty($player['pid']) ? $player['pid'] : NULL;
  if (!$player_pid) {
    return _tve_player_error('Could not render player: Invalid player PID.');
  }

  $mpx_account_id = !empty($player['parent_account']) ? $player['parent_account'] : NULL;
  if (!$mpx_account_id) {
    return _tve_player_error('Could not render player: No MPX account id found.');
  }

  $mpx_account = _media_theplatform_mpx_get_account_data($mpx_account_id);
  $mpx_account_pid = isset($mpx_account->account_pid) ? $mpx_account->account_pid : NULL;
  if (!$mpx_account_pid) {
    return _tve_player_error('Could not render player: Invalid MPX account.');
  }

  $account_mpx_url = $mpx_account->account_id;
  $account_mpx_url_array = explode('/', $account_mpx_url);
  $account_mpx_id = end($account_mpx_url_array);

  $released_file_pid = NULL;
  if (!empty($file->field_mpx_main_released_file_pid[LANGUAGE_NONE][0]['value'])) {
    $released_file_pid = $file->field_mpx_main_released_file_pid[LANGUAGE_NONE][0]['value'];
  }
  elseif (!empty($file->field_mpx_main_released_file_pid[0]['value'])) {
    $released_file_pid = $file->field_mpx_main_released_file_pid[0]['value'];
  }

  if (!$released_file_pid) {
    return _tve_player_error('Could not render player: Released file pid not found.');
  }

//  $released_url = '//link.theplatform.com/s/' . $mpx_account_pid . '/' . $released_file_pid;
  $player_source = '//player.theplatform.com/p/' . $mpx_account_pid . '/' . $player_pid;

  if (!_tve_player_get_player_template_config('use_set_release_url', FALSE)) {
    $player_source .= '/select/media/guid/' . $account_mpx_id . '/'. $released_file_pid;
  }

  $player_tag = array(
    'element' => array(
      '#tag' => 'div',
      '#value' => '',
      '#attributes' => array(
        'data-usa-tve-player'=> "pdk-player",
        'data-src' => url($player_source, array('external' => TRUE)),
        'data-id' => 'pdk-player',
        'data-mbr' => 'true',
        'class' => 'pdk-player-wrap',
      ),
    ),
  );

  // Normal flow.
  $pdk_controller_url = "http://player.theplatform.com/pdk/{$mpx_account_pid}/tpPdkController.js";

  drupal_add_js($pdk_controller_url, 'external');

  return theme('html_tag', $player_tag);
}

/*
 * Helper function Returns associative array of mpx_player data for given player pid.
 */
function _usanetwork_media_theplatform_mpx_get_mpx_player_by_pid($player_pid) {
  return db_query('SELECT * FROM {mpx_player} WHERE pid = :player_pid',
    array(':player_pid' => $player_pid))->fetchAssoc();
}

/**
 * Implements hook_menu().
 */
function usanetwork_tve_video_menu() {
  $items['admin/usanetwork/tve-stage-settings'] = array(
    'title' => t('TVE Stage Settings'),
    'description' => t('Apply settings for stage server'),
    'page callback' => 'usanetwork_tve_video_stage_settings',
    'access arguments' => array('administer usanetwork'),
    'file' =>  'usanetwork_tve_video.admin.inc',
  );
  return $items;
}
