<?php

define('USANETWORK_USANOW_ITUNES_ID', '661695783');
define('USANETWORK_USANOW_IOS_URL', 'https://itunes.apple.com/us/app/usa-now/id661695783');
define('USANETWORK_USANOW_ANDROID_URL', 'https://play.google.com/store/apps/details?id=com.usanetwork.watcher');
define('USANETWORK_DEEP_LINKING_IOS_SCHEME', 'usatve://');
define('USANETWORK_DEEP_LINKING_WINDOWS_APP_ID', 'eee92128-e791-463d-abfc-2a7df28a2b5d');

/**
 * Implements hook_entity_view().
 */
function usanetwork_video_mobile_entity_view($entity, $entity_type, $view_mode, $langcode) {
  if ($entity_type == 'file' && in_array($entity->type, _pub_mpx_get_mpx_account_video_file_types(TRUE)) && $view_mode == 'full') {

    $full_episode = FALSE;
    if ($full_episode_field_value = _usanetwork_get_field_item('file', $entity, 'field_mpx_full_episode', 'value')) {
      $full_episode = $full_episode_field_value == '1' ? TRUE : FALSE;
    }

    if ($full_episode) {
      // add itunes meta
      $apple_itunes_app_tag = array(
        '#tag' => 'meta',
        '#attributes' => array(
          'name' => 'apple-itunes-app',
          'content' => 'app-id=' . USANETWORK_USANOW_ITUNES_ID,
        )
      );
      $windows_app_tag_id = array(
        '#tag' => 'meta',
        '#attributes' => array(
          'name' => 'msApplication-ID',
          'content' => USANETWORK_DEEP_LINKING_WINDOWS_APP_ID,
        ),
      );
//        $windows_app_tag_family = array(
//          '#tag' => 'meta',
//          '#attributes' => array(
//            'name' => 'msApplication-PackageFamilyName',
//            'content' => SYFY_DEEP_LINKING_WINDOWS_FAMILY_ID,
//          ),
//        );

      $js_settings['usa']['msAppId'] = USANETWORK_DEEP_LINKING_WINDOWS_APP_ID;
      $js_settings['usa']['itunesAppId'] = USANETWORK_USANOW_ITUNES_ID;

      $advert_id = _usanetwork_get_field_item('file', $entity, 'field_mpx_external_advertiser_id', 'value');
      if (!empty($advert_id)) {
        $ios_link = USANETWORK_DEEP_LINKING_IOS_SCHEME . '?target=videoAsset&ID=' . $advert_id;
        $apple_itunes_app_tag['#attributes']['content'] .= ', app-argument=' . $ios_link;
        $js_settings['usa']['deepLinking'] = $ios_link;
      }

      $entity->content['#attached']['drupal_add_html_head'][] = array($apple_itunes_app_tag, 'usa_apple_itunes_app');
      $entity->content['#attached']['drupal_add_html_head'][] = array($windows_app_tag_id, 'usa_windows_app_id');

      drupal_add_js($js_settings, 'setting');

      // attach javascript
      $entity->content['#attached']['js'][] = array(
        'type' => 'setting',
        'data' => array(
          'usanetwork_video_mobile' => array(
            'url' => array(
              'iOS' => USANETWORK_USANOW_IOS_URL,
              'android' => USANETWORK_USANOW_ANDROID_URL,
            ),
            'modal' => '<div class="wrap"><h3>' . t('Want to watch episodes of your favorite shows?') . '</h3><hr>'
            . '<img class="mobile-logo-exp" src="' . url(drupal_get_path('module', 'usanetwork_video_mobile') . '/img/logo-mobile-exp.png') . '">'
            . '<div id="mobileVideoModalButtons">'
//            . '<input type="button" value="' . t('Download USA NOW app') . '" class="download-app-button">'
              . '<a href="" class="download-app-button">Download USA NOW app</a>'
              . '<a href="" class="close-reveal-modal">No thanks, keep browsing</a>'
//            . '<input type="button" value="' . t('No thanks, keep browsing') . '" class="close-reveal-modal">' . '</div>'
            . '</div>',
          ),
        ),
      );
      $entity->content['#attached']['js'][] = drupal_get_path('module', 'usanetwork_video_mobile') . '/usanetwork_video_mobile.js';
      $entity->content['#attached']['css'][] = drupal_get_path('module', 'usanetwork_video_mobile') . '/usanetwork_video_mobile.css';
    }
  }
}
