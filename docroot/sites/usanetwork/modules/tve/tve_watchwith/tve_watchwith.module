<?php

/**
 * @file
 * TVE Watchwith module.
 */

define('TVE_WATCHWITH_CONTAINER_ID', 'tve-sidecar');
define('TVE_WATCHWITH_PLAYER_ID', 'pdk-player');
define('TVE_WATCHWITH_NODE_TYPE', 'tv_episode');

/**
 * Implements hook_permission().
 */
function tve_watchwith_permission() {
  $permissions = array(
    'administer tve watchwith' => array(
      'title' => t('Administer TVE Watchwith Sidecar'),
      'description' => t('Perform administration tasks for TVE Watchwith Sidecar module.'),
    ),
  );

  return $permissions;
}

/**
 * Implements hook_menu().
 */
function tve_watchwith_menu() {
  $items = array();
  $items['admin/config/services/watchwith'] = array(
    'title' => 'TVE Watchwith Sidecar',
    'description' => 'Watchwith Sidecar configuration settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_tve_watchwith_admin_form'),
    'access arguments' => array('administer tve watchwith'),
    'file' => 'tve_watchwith.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_page_alter().
 */
function tve_watchwith_page_alter(&$page) {
  if (!_tve_watchwith_is_sidecar_load_required()) {
    return;
  }

  // Add Watchwith js and css to pages that match the configured pattern.

  drupal_add_js(
    variable_get('tve_watchwith_js_path'),
    array(
      'type' => 'external',
      'scope' => 'header',
    )
  );

  drupal_add_css(
    variable_get('tve_watchwith_css_path'),
    array(
      'type' => 'external',
      'scope' => 'header',
    )
  );

  $page['page_bottom']['tve_watchwith']['#attached']['js'][drupal_get_path('module', 'tve_watchwith') . '/js/watchwith.js'] = array(
    'type' => 'file',
    'scope' => 'footer',
  );
}

/**
 * Implements hook_preprocess_node().
 */
function tve_watchwith_preprocess_node(&$variables) {
  $node = $variables['node'];
  if (TVE_WATCHWITH_NODE_TYPE == $node->type) {
    $variables['watchwith_sidecar'] = NULL;
    if (!_tve_watchwith_is_sidecar_load_required()) {
      return;
    }

    // Gets the anvato id from the node object and passes it to sidecar load function.
    $external_advertiser_id = field_get_items('node', $node, 'field_mpx_external_advertiser_id');
    $external_advertiser_id = isset($external_advertiser_id[0]['value']) ?
      $external_advertiser_id[0]['value'] :
      NULL;

    _tve_watchwith_load_sidecar($external_advertiser_id);

    $variables['watchwith_sidecar'] = _tve_watchwith_get_sidecar_container_html();
    $variables['watchwith_hide_sidecar_tabs'] = variable_get('tve_watchwith_hide_sidecar_tabs', 1);

    $default_no_content_message = variable_get('tve_watchwith_default_no_content_message', array());
    $variables['watchwith_error_message'] = isset($default_no_content_message['value']) ? $default_no_content_message['value'] : '';
  }
}

/**
 * Loads the sidecar parameters into Drupal.settings.
 *
 * @param string $airing_id
 */
function _tve_watchwith_load_sidecar($airing_id = '') {
  $sidecar_parameters = array(
    'elementId' => TVE_WATCHWITH_CONTAINER_ID,
    'playerId' => TVE_WATCHWITH_PLAYER_ID,
    'airingId' => $airing_id,
    'key' => variable_get('tve_watchwith_api_key'),
    'landscape' => variable_get('tve_watchwith_sidecar_layout') == 'landscape',
    'showAllEvents' => (bool) variable_get('tve_watchwith_show_all_events'),
    'airingIdSource' => 'anvatoAssetId',
  );

  $ga_id = variable_get('tve_watchwith_google_analytics_id');
  if (!is_null($ga_id)) {
    $sidecar_parameters['googleAnalyticsId'] = $ga_id;
  }

  // Adds the javascript to load sidecar.
  drupal_add_js(
    array(
      'tve_watchwith' => $sidecar_parameters,
    ),
    'setting'
  );
}

/**
 * Returns rendered Watchwith Sidecar container html element.
 *
 * @return string
 */
function _tve_watchwith_get_sidecar_container_html() {
  $variables = array();
  $variables['element']['#tag'] = 'div';
  $variables['element']['#value'] = '';
  $variables['element']['#attributes'] = array(
    'id' => TVE_WATCHWITH_CONTAINER_ID,
  );

  return theme('html_tag', $variables);
}

/**
 * Returns TRUE if current url matches allowed paths configured in
 * the watchwith administrative section.
 *
 * @return bool
 */
function _tve_watchwith_is_sidecar_load_required() {
  if (!variable_get('tve_watchwith_enable', 1)) {
    return FALSE;
  }

  $current_path = drupal_get_path_alias(current_path());
  $allowed_paths = variable_get('tve_watchwith_widget_display_path', '');

  return drupal_match_path($current_path, $allowed_paths);
}
