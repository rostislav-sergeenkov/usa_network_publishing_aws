<?php

define('NBCU_SEO_XMLSITEMAP_PATH', 'nbcu_xmlsitemap');
define('NBCU_SEO_XMLSITEMAP_PREPROCESS_COUNT', 500);

/**
 * Implements hook_menu().
 */
function nbcu_seo_menu() {
  $items = array();

  $types = nbcu_seo_xmlsitemap_types();
  foreach ($types as $type) {
    $items[$type . '.xml'] = array(
      'page callback' => 'nbcu_seo_xmlsitemap_output',
      'page arguments' => array($type),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
      'file' => 'nbcu_seo.xmlsitemap.inc',
    );
  }

  $items['sitemapindex.xml'] = array(
    'page callback' => 'nbcu_seo_xmlsitemap_index',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    'file' => 'nbcu_seo.xmlsitemap.inc',
  );

  return $items;
}

/**
 * Implements hook_cron().
 */
function nbcu_seo_cron() {
  module_load_include('xmlsitemap.inc', 'nbcu_seo');
  module_load_include('generate.inc', 'xmlsitemap');

  // If there were no new or changed links, skip.
  $need_regenerate = FALSE;
  $regenerate = variable_get('nbcu_seo_xmlsitemap_regenerate_needed', array());
  foreach ($regenerate as $smid => &$types) {
    $sitemap = xmlsitemap_sitemap_load($smid);
    foreach ($types as $type => &$flag) {
      $file = nbcu_seo_xmlsitemap_sitemap_get_file($sitemap, 1, $type);
      if (!file_exists($file)) {
        $flag = TRUE;
      }
      $need_regenerate |= $flag;
    }
  }
  variable_set('nbcu_seo_xmlsitemap_regenerate_needed', $regenerate);
  if (!$need_regenerate) {
    return;
  }

  // If the minimum sitemap lifetime hasn't been passed, skip.
  $lifetime = REQUEST_TIME - variable_get('xmlsitemap_generated_last', 0);
  if ($lifetime < variable_get('xmlsitemap_minimum_lifetime', 0)) {
    return;
  }

  // Regenerate the sitemap XML files.
  xmlsitemap_run_unprogressive_batch('nbcu_seo_xmlsitemap_regenerate_batch');
}

/**
 * Implements hook_nbcu_seo_xmpsitemap_link_type().
 */
function nbcu_seo_nbcu_seo_xmpsitemap_link_type($link) {
  $types = array();

  // check if link has images
  if ($link['type'] == 'node' && $link['subtype'] == 'media_gallery') {
    // load images associated with node
    $query = db_select('file_usage', 'fu')
      ->fields('fu', array('fid'));
    $query->leftJoin('file_managed', 'f', 'fu.fid = f.fid');
    $query->condition('f.type', 'image', '=');
    $query->condition('fu.type', 'node', '=');
    $query->condition('fu.id', $link['id'], '=');

    $fids = $query->execute()->fetchCol();
    $files = file_load_multiple($fids);

    if (!empty($files)) {
      $types['image'] = 'image';
    }
  }

  // check if link has videos
  if (module_exists('pub_mpx')) {
    if ($link['type'] == 'file' && in_array($link['subtype'], _pub_mpx_get_mpx_account_video_file_types(TRUE))) {
      $types['video'] = 'video';
    }
  }

  return $types;
}

/**
 * Implements hook_flush_caches().
 */
function nbcu_seo_flush_caches() {
  return array('cache_xmlsitemap_link');
}

/**
 * Returns list of xml sitemap types.
 */
function nbcu_seo_xmlsitemap_types() {
  $types =& drupal_static(__FUNCTION__, NULL);
  if ($types == NULL) {
    $types = array();
    drupal_alter('nbcu_seo_xmlsitemap_types', $types);
  }
  return $types;
}
