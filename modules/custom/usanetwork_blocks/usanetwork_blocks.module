<?php

/**
 * @file
 * USA blocks - custom blocks that are not generated with views or stored elsewhere
 */


/**
 * Implements hook_block_info().
 */
function usanetwork_blocks_block_info() {
  $blocks = array();
  $blocks['fpo_ad_rectangle'] = array(
    'info' => t('FPO: rectangle ad block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['fpo_ad_skyscraper'] = array(
    'info' => t('FPO: skyscraper ad block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['fpo_ad_leaderboard'] = array(
    'info' => t('FPO: leaderboard ad block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['fpo_ad_pusher'] = array(
    'info' => t('FPO: pushdown 970x90 ad block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['fpo_block'] = array(
    'info' => t('FPO: generic block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['usa_meganav'] = array(
    'info' => t('USA: mega nav'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['usa_social_footer'] = array(
    'info' => t('USA: social footer'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['usa_on_now_block'] = array(
    'info' => t('USA: on now block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['usa_tv_show_menu'] = array(
    'info' => t('USA: TV Show Menu'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function usanetwork_blocks_block_view($delta) {
  $block = array();
  //The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'fpo_ad_rectangle':
      $block['subject'] = '';
      $block['content'] = usanetwork_blocks_fpo_ad_rectangle();
      break;
    case 'fpo_ad_skyscraper':
      $block['subject'] = '';
      $block['content'] = usanetwork_blocks_fpo_ad_skyscraper();
      break;
    case 'fpo_ad_leaderboard':
      $block['subject'] = '';
      $block['content'] = usanetwork_blocks_fpo_ad_leaderboard();
      break;
    case 'fpo_ad_pusher':
      $block['subject'] = '';
      $block['content'] = usanetwork_blocks_fpo_ad_pusher();
      break;
    case 'fpo_block':
      $block['subject'] = t('Generic block');
      $block['content'] = usanetwork_blocks_fpo_block();
      break;
    case 'usa_meganav':
      $block['subject'] = '';
      $block['content'] = usanetwork_blocks_usa_meganav();
      break;
    case 'usa_social_footer':
      $block['subject'] = t('Follow Us:');
      $block['content'] = usanetwork_blocks_usa_social_footer();
      break;
    case 'usa_on_now_block':
      $block['subject'] = '';
      $block['content'] = usanetwork_blocks_on_now_block();
      break;
    case 'usa_tv_show_menu':
      $block['subject'] = '';
      $block['content'] = usanetwork_blocks_tv_show_menu();
      break;
  }
  return $block;
}

/**
 * Implements hook_theme().
 */
function usanetwork_blocks_theme($existing, $type, $theme, $path) {
  // @TODO: add variables, make these real theme functions
  return array(
   'usa_meganav' => array(
      'variables' => array(
        ),
      'path' => $path . '/theme',
      'template' => 'usa-meganav',
    ),
   'usa_social_footer' => array(
      'variables' => array(
        ),
      'path' => $path . '/theme',
      'template' => 'usa-social-footer',
    ),
  );
}

/**
 * Block callback for the FPO rectangle ad block
 */
function usanetwork_blocks_fpo_ad_rectangle() {
  $render = array();

  $render['fpo_ad']['body'] = array(
    '#type' => 'markup',
    '#prefix' => '<div class="ad" style="width: 300px; height: 250px; text-align: center; background: #ddd;">',
    '#markup' => t('300x250 ad unit'),
    '#suffix' => '</div>',
  );

  return $render;
}

/**
 * Block callback for the FPO rectangle ad block
 */
function usanetwork_blocks_fpo_ad_skyscraper() {
  $render = array();

  $render['fpo_ad']['body'] = array(
    '#type' => 'markup',
    '#prefix' => '<div class="ad" style="width: 160px; height: 600px; text-align: center; background: #ddd;">',
    '#markup' => t('160x600 ad unit'),
    '#suffix' => '</div>',
  );

  return $render;
}


/**
 * Block callback for the FPO rectangle ad block
 */
function usanetwork_blocks_fpo_ad_leaderboard() {
  $render = array();

  $render['fpo_ad']['body'] = array(
    '#type' => 'markup',
    '#prefix' => '<div class="ad" style="width: 728px; height: 90px; text-align: center; background: #ddd;">',
    '#markup' => t('728x90 ad unit'),
    '#suffix' => '</div>',
  );

  return $render;
}

/**
 * Block callback for the FPO slider or super 970 x 90 ad block
 */
function usanetwork_blocks_fpo_ad_pusher() {
  $render = array();

  $render['fpo_ad']['body'] = array(
    '#type' => 'markup',
    '#prefix' => '<div class="ad" style="width: 970px; height: 90px; text-align: center; background: #ddd;">',
    '#markup' => t('728x90 ad unit'),
    '#suffix' => '</div>',
  );

  return $render;
}

/**
 * Block callback for the FPO generic block
 */
function usanetwork_blocks_fpo_block() {
  $render = array();

  $render['fpo_block']['body'] = array(
    '#type' => 'markup',
    '#prefix' => '<div class="body">',
    '#markup' => t('I am a generic placement only block. See me be that. :)'),
    '#suffix' => '</div>',
  );

  return $render;
}

/**
 * Block callback for the On Now block
 */
function usanetwork_blocks_on_now_block() {
  $render = array();
  
  // JS to determine the current timezone from the user browser
  drupal_add_js(drupal_get_path('module', 'usanetwork_blocks') . '/js/jstz-1.0.4.min.js');

  $tv_url = variable_get('usanetwork_tv_schedule', '');
  // return empty block if the tv schedule url is empty
  if (empty($tv_url)) {
    return ''; 
  }

  // fetch today's schedule
  $tv_schedule = file_get_contents($tv_url);
  $tv_schedule = drupal_json_decode($tv_schedule);

  // fetch yesterday's schedule to load the schedule from 00:00 AM till 5:59 AM
  $tv_schedule_prev_day = file_get_contents($tv_url . '?sdate=' . date('m/d/Y', time() - 60 * 60 * 24));
  $tv_schedule_prev_day = drupal_json_decode($tv_schedule_prev_day);

  $full_tv_schedule = array('data' => array());
  $start_search = false;
  // get the tv schedule from 00:00 AM till 5:59 AM
  foreach ($tv_schedule_prev_day['data'] as $key => $val) {
    if (strpos($key, 'PM') !== FALSE) {
      $start_search = true;
    }
    if ($start_search && strpos($key, 'AM') !== FALSE) {
      $full_tv_schedule['data'][$key] = $val;
    } 
  }
  // get the tv schedule from 6:00 AM till end of the day
  foreach ($tv_schedule['data'] as $key => $val) {
    if (!isset($full_tv_schedule['data'][$key])) {
      $full_tv_schedule['data'][$key] = $val;
    }
  } 

  // expose the tv schedule as JS variable to determine the on on show based on the user timezone and for other modules to consume it
  $vars = 'var tv_schedule = ' . drupal_json_encode($full_tv_schedule) . ';';

  // switch to ET timezone to perform calculations and then switch back to original timezone
  $orginal_tz = date_default_timezone_get();
  date_default_timezone_set('America/New_York');
  $et_time = floatval(date('U'));

  foreach ($full_tv_schedule['data'] as $dt => $show) {
    $show_dt = strtotime(date('Y-m-d ').$dt);
    if ($et_time < $show_dt) {
      if (empty($last_dt)) {
        $last_dt = $dt;
      }
      $show_name = $full_tv_schedule['data'][$last_dt]['show'] .': '. $full_tv_schedule['data'][$last_dt]['episode'];
      break;
    }
    $last_dt = $dt;
  }
  date_default_timezone_set($orginal_tz);

  // expose default et show for rest of the world
  $show_name = strtoupper($show_name);
  $vars .= 'var on_now_default_show = "' . $show_name . '";';

  drupal_add_js($vars, array('type' => 'inline'));
  drupal_add_js(drupal_get_path('module', 'usanetwork_blocks') . '/js/usanetwork_tv_schedule.js');

  // Handles the JS disabled browser scenario
  $markup = '&nbsp;<noscript>' . $show_name . '</noscript>';

  $render['on_now_block']['body'] = array(
    '#type' => 'markup',
    '#markup' => $markup,
  );

  return $render;
}

/**
 * Block callback for the usa_meganav block
 */
function usanetwork_blocks_usa_meganav() {
  $render = array();

  $render['meganav'] = array(
    '#type' => 'markup',
    '#markup' => theme('usa_meganav', array()),
  );

  return $render;
}

/**
 * Block callback for the usa_social_footer block
 */
function usanetwork_blocks_usa_social_footer() {
  $render = array();

  $render['socialfeet'] = array(
    '#type' => 'markup',
    '#markup' => theme('usa_social_footer', array()),
  );

  return $render;
}


/**
 * Block for displaying TV show menu
 */
function usanetwork_blocks_tv_show_menu() {
  $arg = arg();
  $lang = LANGUAGE_NONE;
  $links = array();
  $output = '';

  if (isset($arg[1])) {
    $node = node_load($arg[1]);
  }

  // return empty block if the node id is empty
  if (!isset($node->nid) || empty($node->nid)) {
    return '';
  }

  // Get the field collection items.
  $fc_fields = field_get_items('node', $node, 'field_show_links');
  
  // Extract the field collection item ids
  $ids = array();
  foreach ($fc_fields as $fc_field) {
    $ids[] = $fc_field['value'];
  }
  
  // Load up the field collection items
  $items = field_collection_item_load_multiple($ids);
  
  // Loop through the items and extract field values
  foreach ($items as $item) {
    $mlinks = array();
    $link_fields = field_get_items('field_collection_item', $item, 'field_main_link');
    foreach ($link_fields as $link) {
      $mlinks['data'] = empty($link['url']) ? $link['title'] : l($link['title'], $link['url']); 
    }

    $link_fields = field_get_items('field_collection_item', $item, 'field_child_link');
    foreach ($link_fields as $link) {
      $mlinks['children'][] = empty($link['url']) ? $link['title'] : l($link['title'], $link['url']); 
    }
    $links[] = $mlinks;
  }

  if (!empty($links)) {
    $output .= '<div class="tv-show-menu-trigger">'. $node->title  .'</div>';
    $output .= '<div id="tv-show-menu">' . theme('item_list', array('items' => $links)) . '</div>';
  }
  return $output;
}

