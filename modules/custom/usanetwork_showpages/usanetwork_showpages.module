<?php

/**
 * @file
 * Code for the usanetwork_showpages feature.
 * this manages the landing or section pages per show
 */

include_once 'usanetwork_showpages.features.inc';

/**
 * Implementation of hook_menu().
 */
function usanetwork_showpages_menu() {
  // tv show photos landing page
  $items['node/%node/photos'] = array(
    'title' => t('Photos'),
    'page callback' => 'usanetwork_showpages_photos',
    'page arguments' => array(1),
    'access callback' => 'usanetwork_showpages_menu_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
  );
  // tv show episodes landing page
  $items['node/%node/episodes'] = array(
    'title' => t('Episodes'),
    'page callback' => 'usanetwork_showpages_episodes',
    'page arguments' => array(1),
    'access callback' => 'usanetwork_showpages_menu_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
  );
  // tv show cast landing page
  $items['node/%node/cast'] = array(
    'title' => t('Cast'),
    'page callback' => 'usanetwork_showpages_cast',
    'page arguments' => array(1),
    'access callback' => 'usanetwork_showpages_menu_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
  );
  // tv show videos landing page
  $items['node/%node/videos'] = array(
    'title' => t('Videos'),
    'page callback' => 'usanetwork_showpages_videos',
    'page arguments' => array(1),
    'access callback' => 'usanetwork_showpages_menu_access',
    'access arguments' => array(1),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Shpw pages menu access callback to restrict only tv_show nodes 
 */
function usanetwork_showpages_menu_access($node) {
  return $node->type == 'tv_show' && user_access('access content');
}

/**
 * Implements hook_block_info().
 */
function usanetwork_showpages_block_info() {
  $blocks = array();
  $blocks['show_banner'] = array(
    'info' => t('Show banner: title, section, tune-in date'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function usanetwork_showpages_block_view($delta) {
  $block = array();
  //The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'show_banner':
      $block['subject'] = '';
      $block['content'] = usanetwork_showpages_showbanner();
      break;
  }
  return $block;
}

/**
 * Implements hook_theme().
 */
function usanetwork_showpages_theme($existing, $type, $theme, $path) {
  return array(
   'show_banner' => array(
      'variables' => array(
        'show_name' => NULL,
        'show_section' => NULL,
        'show_tunein' => NULL
        ),
      'path' => $path . '/theme',
      'template' => 'show-banner',
    ),
  );
}

/**
 * Block callback for show banner
 */
function usanetwork_showpages_showbanner() {
  $render = array();
  $lang = LANGUAGE_NONE;
  // for our logic, this will be the show nid
  $show = '';
  // these are for the theme function
  $show_name = '';
  $show_section = '';
  $show_tunein = '';

  // see if we are on a node page
  if ($node = menu_get_object()) {
    $field_name = "field_show";
    // see if we are on a show node
    if ($node->type == 'tv_show') {
      $show = $node->nid;
      $show_title = isset($node->field_display_title[$lang][0]['safe_value']) ? $node->field_display_title[$lang][0]['safe_value'] : $node->title;
      $show_title = decode_entities($show_title);
      $show_tunein = isset($node->field_usa_tv_tune_in_date[$lang][0]['safe_value']) ? $node->field_usa_tv_tune_in_date[$lang][0]['safe_value'] : '';
      $show_url = 'node/' . $node->nid;
      $show_name = l($show_title, $show_url);
      // see if we are in a show social subsection
      if (arg(2) == 'social') {
        $show_section = t('Social');
      }
      if (arg(2) == 'games') {
        $show_section = t('Games');
      }
      if (arg(2) == 'features') {
        $show_section = t('Features');
      }
      if (arg(2) == 'quizzes') {
        $show_section = t('Quizzes');
      }
    }
    // looks for nodes with a value in field_show
    if (!empty($node->$field_name)) {
      $show_nid = field_get_items('node', $node, $field_name);
      $show_nid = $show_nid[0]['target_id'];
      $show = node_load($show_nid);
      $show_title = isset($show->field_display_title[$lang][0]['safe_value']) ? $show->field_display_title[$lang][0]['safe_value'] : $show->title;
      $show_title = decode_entities($show_title);
      $show_tunein = isset($show->field_usa_tv_tune_in_date[$lang][0]['safe_value']) ? $show->field_usa_tv_tune_in_date[$lang][0]['safe_value'] : '';
      $show_url = 'node/' . $show->nid;
      $show_name = l($show_title, $show_url);
      switch ($node->type) {
        case 'person':
          $show_section = t('Characters & Crew');
          break;
        case 'tv_episode':
          $show_section = t('Episode Guide');
          break;
        case 'media_gallery':
          $show_section = t('Photos');
          break;
        case 'usa_video':
        case 'usa_tve_video':
          $show_section = t('Videos');
          break;
        case 'usanetwork_static_page':
        case 'catchall_page':
          $custompath = drupal_get_path_alias('node/'.$node->nid);
          $path_parts = explode('/', $custompath);
          if ($path_parts['1'] == 'features') {
            $show_section = t('Features');
          }
          if ($path_parts['1'] == 'quizzes') {
            $show_section = t('Quizzes');
          }
          if ($path_parts['1'] == 'games') {
            $show_section = t('Games');
          }
          break;
      }
    }
    // render the theme function
    $render['show_banner']['#markup'] = theme('show_banner', array('show_name' => $show_name, 'show_section' => $show_section, 'show_tunein' => $show_tunein));
  }

  return $render;
}

/**
 * Menu callback of show photos page
 * load the panel page for the most recently posted gallery
 * associated with a show
 */
function usanetwork_showpages_photos($node) {
  $render = array();

  // if there is no show NID get out of there
  if (!isset($node->nid)) {
    return;
  }
  $show = $node->nid;
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node');
  $query->entityCondition('bundle', array('media_gallery'));
  $query->propertyCondition('status', 1);
  $query->fieldCondition('field_show', 'target_id', $show);
  $query->fieldCondition('field_episode', 'target_id', 'NULL', '!=');
  $query->propertyOrderBy('created', 'DESC');
  $query->range(0, 1);
  // execute the query
  $result = $query->execute();
  // load the related gallery
  // then go to that page
  if (!empty($result['node'])) {
    $nid = array_keys($result['node']);
    $nid = $nid[0];
    drupal_goto('node/' . $nid);
  }
  // or go back to the show node
  drupal_goto('node/' . $show);
}

/**
 * Menu callback of show episodes page
 * load the panel page for the most recently aired episode
 * associated with a show
 */
function usanetwork_showpages_episodes($node) {
  $render = array();
  $lang = LANGUAGE_NONE;

  // if there is no show NID get out of there
  if (!isset($node->nid)) {
    return;
  }
  $show = $node->nid;
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node');
  $query->entityCondition('bundle', array('tv_episode'));
  $query->propertyCondition('status', 1);
  $query->fieldCondition('field_show', 'target_id', $show);
  $query->fieldCondition('field_original_air_date', 'value', 'NULL', '!=');
  $query->fieldOrderBy('field_original_air_date', 'value', 'DESC');
  $query->range(0, 1);
  // execute the query
  $result = $query->execute();
  // load the latest episode
  // then go to that page
  if (!empty($result['node'])) {
    $nid = array_keys($result['node']);
    $nid = $nid[0];
    drupal_goto('node/' . $nid);
  }
  // or go back to the show node
  drupal_goto('node/' . $show);
}

/**
 * Menu callback of show cast page
 * load the panel page for the first member listed in the draggable cast view
 * associated with a show
 */
function usanetwork_showpages_cast($node) {
  $render = array();
  $lang = LANGUAGE_NONE;

  // if there is no NID get out of there
  if (!isset($node->nid)) {
    return;
  }

  // grab the first element from the draggable view
  $view = views_get_view('usa_cast');
  $view->set_display('block_1');
  $view->args = array($node->nid);
  $view->pre_execute();
  $view->execute();
  
  if (!empty($view->result)) {
    $cast_nid = $view->result[0]->nid;
  }
  $view->destroy();

  // then go to that page
  if (isset($cast_nid)) {
    drupal_goto('node/' . $cast_nid);
  }
  
  // or go back to the show node
  drupal_goto('node/' . $show);
}

/**
 * Menu callback of show videos page
 * Redirect the user to the video Page of the most-recently-published Full Episode Video associated with the show
 */
function usanetwork_showpages_videos($node) {
  $lang = LANGUAGE_NONE;

  // if there is no show NID get out of there
  if (!isset($node->nid)) {
    return;
  }
  $show = $node->nid;
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node');
  $query->entityCondition('bundle', array('usa_video'));
  $query->propertyCondition('status', 1);
  $query->fieldCondition('field_show', 'target_id', $show);
  $query->fieldCondition('field_full_episode', 'value', '1', '=');
  $query->fieldOrderBy('field_video_air_date', 'value', 'desc');
  $query->range(0, 1);
  // execute the query
  $result = $query->execute();
  // load the latest episode
  // then go to that page
  if (!empty($result['node'])) {
    $nid = array_keys($result['node']);
    $nid = $nid[0];
    drupal_goto('node/' . $nid);
  } else {
    $query = new EntityFieldQuery();
    $query->entityCondition('entity_type', 'node');
    $query->entityCondition('bundle', array('usa_video'));
    $query->propertyCondition('status', 1);
    $query->fieldCondition('field_show', 'target_id', $show);
    $query->fieldOrderBy('field_video_air_date', 'value', 'desc');
    $query->range(0, 1);
    // execute the query
    $result = $query->execute();
    // load the latest episode
    // then go to that page
    if (!empty($result['node'])) {
      $nid = array_keys($result['node']);
      $nid = $nid[0];
      drupal_goto('node/' . $nid);
    }
    // or go back to the show node
    drupal_goto('node/' . $show);
  }
}

/**
  * Implements hook_preprocess_html()
  * custom titles for show related pages
  * where we do not want the code in a feature override module
  * or the theme
  */
function usanetwork_showpages_preprocess_html(&$vars) {
  $head_title = NULL;
  $node = menu_get_object();
  $lang = LANGUAGE_NONE;
  // nodes with show references
  $show = array();

  // see if we are on a node page
  if ($node = menu_get_object()) {
    
    // see if we are on a show node
    if ($node->type == 'tv_show') {
      $show = $node->nid;
      // see if we are in a show subsection
      // custom module or dynamic based on path
      switch (arg(2)) {
       // video landing 
       case 'videos':
          $headtitle = t("@show Videos", array('@show' => $node->title));
          $vars['title'] = $headtitle;
          break;
        // GAME_TITLE | Games | SHOW_NAME | SITE_TITLE
        case 'games':
          $head_title = t("@title | Games | @showname | USA Network", array('@showname' => $show->title, '@title' => $node->title));
          break;
        // FEATURE_TITLE | Features | SHOW_NAME | SITE_TITLE
        case 'features':
          $head_title = t("@title | Features | @showname | USA Network", array('@showname' => $show->title, '@title' => $node->title));
          break;
        // quiz_TITLE | Quizzes | SHOW_NAME | SITE_TITLE
        case 'quizzes':
          $head_title = t("@title | Quizzes | @showname | USA Network", array('@showname' => $show->title, '@title' => $node->title));
          break;
      }
    }
    // looks for nodes with a value in field_show
    if (!empty($node->field_show)) {
      $show_nid = field_get_items('node', $node, 'field_show');
      $show_nid = $show_nid[0]['target_id'];
      $show = node_load($show_nid);
      switch ($node->type) {
      // person pages have 2 cases
        case 'person':
          $role = array();
          $actor = array();
          $role = field_get_items('node', $node, 'field_role');
          $actor = field_get_items('node', $node, 'field_usa_actor_name');
          // check for role and actor field
          // CHARACTER_NAME played by ACTOR_NAME | Characters & Crew | SHOW_NAME | SITE_TITLE
          if ($role[0]['taxonomy_term']->name == 'Character' && !empty($actor)) {
            $head_title = t("@person played by @actor | Characters & Crew | @showname | USA Network", array('@showname' => $show->title, '@person' => $node->title, '@actor' => $actor[0]['safe_value']));
          }
          // everyone else
          // CHARACTER_NAME | Characters & Crew | SHOW_NAME | SITE_TITLE
          else {
            $head_title = t("@person | Characters & Crew | @showname | USA Network", array('@showname' => $show->title, '@person' => $node->title));
          }
          break;
        // EPISODE_TITLE - Season SEASON_NUMBER | Episode Guide | SHOW_NAME | SITE_TITLE
        case 'tv_episode':
          $season_nid = field_get_items('node', $node, 'field_season');
          $season = $season_nid[0]['target_id'];
          $season = node_load($season);
          $head_title = t("@episode - @season | Episode Guide | @showname | USA Network", array('@showname' => $show->title, '@episode' => $node->title, '@season' => $season->title));
          break;
        // GALLERY_TITLE | Photo Galleries | SHOW_NAME | SITE_TITLE
        case 'media_gallery':
          $head_title = t("@title | Photo Galleries | @showname | USA Network", array('@showname' => $show->title, '@title' => $node->title));
          break;
        // VIDEO_TITLE | Videos | SHOW_NAME | SITE_TITLE
        case 'usa_video':
        case 'usa_tve_video':
          $head_title = t("@video | Videos | @showname | USA Network", array('@showname' => $show->title, '@video' => $node->title));
          break;
        // SAME LOGIC AS CUSTOM PATHS ABOVE
        case 'usanetwork_static_page':
        case 'catchall_page':
          $custompath = drupal_get_path_alias('node/'.$node->nid);
          $path_parts = explode('/', $custompath);
          if ($path_parts['1'] == 'features') {
            $head_title = t("@title | Features | @showname | USA Network", array('@showname' => $show->title, '@title' => $node->title));
          }
          if ($path_parts['1'] == 'quizzes') {
            $head_title = t("@title | Quizzes | @showname | USA Network", array('@showname' => $show->title, '@title' => $node->title));
          }
          if ($path_parts['1'] == 'games') {
            $head_title = t("@title | Games | @showname | USA Network", array('@showname' => $show->title, '@title' => $node->title));
          }
          break;
      }
    }
    // end of node types
  }

  // If there are head titles print the new ones
  if (!empty($head_title)) {
    $vars['head_title'] = $head_title;
  }

}
