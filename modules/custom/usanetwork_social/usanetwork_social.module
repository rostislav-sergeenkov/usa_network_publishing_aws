<?php

/**
 * @file
 * Code for the usanetwork_social feature.
 */

include_once 'usanetwork_social.features.inc';

/**
 * Implementation of hook_menu().
 */
function usanetwork_social_menu() {
  // admin pages
  $items['admin/usanetwork/social-settings'] = array(
    'title' => t('Social Settings'),
    'description' => t('Administer USA Network social settings.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('usanetwork_social_settings_form'),
    'access arguments' => array('administer usanetwork'),
    'file' => 'usanetwork_social.admin.inc',
    'weight' => -10,
  );

  // tv show social page
  $items['node/%node/social'] = array(
    'title' => t('Social'),
    'page callback' => 'usanetwork_social_landing_page',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_LOCAL_TASK,
  );
  // tv show twitter page
  $items['node/%node/social/twitter'] = array(
    'title' => t('Twitter'),
    'page callback' => 'usanetwork_social_twitter',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  // tv show facebook page
  $items['node/%node/social/facebook'] = array(
    'title' => t('Facebook'),
    'page callback' => 'usanetwork_social_facebook',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_LOCAL_TASK,
  );
  // tv show chat with fans page
  $items['node/%node/social/chat-with-fans'] = array(
    'title' => t('Chat with Fans'),
    'page callback' => 'usanetwork_social_chat_with_fans',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function usanetwork_social_form_node_form_alter(&$form, &$form_state) {
  $lang = LANGUAGE_NONE;

  if ($form['type']['#value'] == 'tv_show') {

    // set the sitewide values as default values for each show
    // eql template
    if (!isset($form['field_twitter_eql_template'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_eql_template'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_eql_template'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_echo_query_template', '');
    }
    // childrenof
    if (!isset($form['field_twitter_childrenof'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_childrenof'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_childrenof'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_childrenof', '');
    }
    // feed
    if (!isset($form['field_twitter_feed'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_feed'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_feed'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_feed', '');
    }
    // state
    if (!isset($form['field_twitter_state'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_state'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_state'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_state', '');
    }
    // source
    if (!isset($form['field_twitter_source'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_source'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_source'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_source', '');
    }
    // markers
    if (!isset($form['field_twitter_markers'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_markers'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_markers'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_markers', '');
    }
    // tags
    if (!isset($form['field_twitter_tags'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_tags'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_tags'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_tags', '');
    }
    // sortorder
    if (!isset($form['field_twitter_sortorder'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_sortorder'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_sortorder'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_sortorder', '');
    }
    // safehtml
    if (!isset($form['field_twitter_safehtml'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_safehtml'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_safehtml'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_safehtml', '');
    }
    // itemsperpage
    if (!isset($form['field_twitter_itemsperpage'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_itemsperpage'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_itemsperpage'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_itemsperpage', '');
    }
    // children
    if (!isset($form['field_twitter_children'][$lang][0]['value']['#default_value']) ||
      empty($form['field_twitter_children'][$lang][0]['value']['#default_value'])) {
      $form['field_twitter_children'][$lang][0]['value']['#default_value'] = variable_get('usanetwork_social_twitter_children', '');
    }
  }
}

/**
 * Menu callback of social landing page
 */
function usanetwork_social_landing_page($node) {
  $tabs = array();
  $tabs[] = l(t('Twitter'), 'node/' . $node->nid . '/social/twitter');
  $tabs[] = l(t('Facebook'), 'node/' . $node->nid . '/social/facebook');
  $tabs[] = l(t('Chat with Fans'), 'node/' . $node->nid . '/social/chat-with-fans');
  
  return theme('item_list', array('items' => $tabs));
}

/**
 * Menu callback of social twitter page
 */
function usanetwork_social_twitter($node) {
  $output = '';
  $lang = LANGUAGE_NONE;

  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/jquery-pack.js');
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/stream.js');
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/twitter-intents.js');
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/inlinemedia.js');
  drupal_add_js(drupal_get_path('module', 'usanetwork_social') . '/js/twitter-page.js');

 
  if (!isset($node->nid)) {
    drupal_not_found();
  }
  
  // check if the show twitter page flag is enabled
  if (!isset($node->field_show_twitter_page[$lang][0]['value']) || empty($node->field_show_twitter_page[$lang][0]['value'])) {
    drupal_goto('node/'.$node->nid.'/social');
  }

  $eql = isset($node->field_twitter_eql_template[$lang][0]['value']) ? $node->field_twitter_eql_template[$lang][0]['value'] : '';
  $eql = empty($eql) ? variable_get('usanetwork_social_twitter_echo_query_template', '') : $eql;
  
  // if EQL is empty, show social landing page
  if (empty($eql)) {
    drupal_goto('node/'.$node->nid.'/social');
  }
  
  $tokens = array();

  $tokens['[CHILDRENOF]'] = isset($node->field_twitter_childrenof[$lang][0]['value']) ? $node->field_twitter_childrenof[$lang][0]['value'] : '';
  $tokens['[SHOW]'] = isset($node->field_twitter_show[$lang][0]['value']) ? $node->field_twitter_show[$lang][0]['value'] : '';
  $tokens['[FEED]'] = isset($node->field_twitter_feed[$lang][0]['value']) ? $node->field_twitter_feed[$lang][0]['value'] : '';
  $tokens['[STATE]'] = isset($node->field_twitter_state[$lang][0]['value']) ? $node->field_twitter_state[$lang][0]['value'] : '';
  $tokens['[SOURCE]'] = isset($node->field_twitter_source[$lang][0]['value']) ? $node->field_twitter_source[$lang][0]['value'] : '';
  $tokens['[MARKERS]'] = isset($node->field_twitter_markers[$lang][0]['value']) ? $node->field_twitter_markers[$lang][0]['value'] : '';
  $tokens['[TAGS]'] = isset($node->field_twitter_tags[$lang][0]['value']) ? $node->field_twitter_tags[$lang][0]['value'] : '';
  $tokens['[SORTORDER]'] = isset($node->field_twitter_sortorder[$lang][0]['value']) ? $node->field_twitter_sortorder[$lang][0]['value'] : '';
  $tokens['[SAFEHTML]'] = isset($node->field_twitter_safehtml[$lang][0]['value']) ? $node->field_twitter_safehtml[$lang][0]['value'] : '';
  $tokens['[ITEMSPERPAGE]'] = isset($node->field_twitter_itemsperpage[$lang][0]['value']) ? $node->field_twitter_itemsperpage[$lang][0]['value'] : '';
  $tokens['[CHILDREN]'] = isset($node->field_twitter_children[$lang][0]['value']) ? $node->field_twitter_children[$lang][0]['value'] : '';
  
  $eql = str_replace(array_keys($tokens), array_values($tokens), $eql);
  $echoAppKey = variable_get('usanetwork_social_twitter_echo_app_key', '');
 
  $output .= '<div id="echoAppKey" style="display: none;">' . $echoAppKey . '</div>';
  $output .= '<div id="echoQuery" style="display: none;">' . $eql . '</div>';
  $output .= '<div id="echo-stream">&nbsp;</div>';

  return $output;
}

/**
 * Menu callback of social facebook page
 */
function usanetwork_social_facebook($node) {
  return t('Facebook Feed: Placeholder');
}

/**
 * Menu callback of social chat with fans page
 */
function usanetwork_social_chat_with_fans($node) {
  return t('Chat with Fans Feed: Placeholder');
}
