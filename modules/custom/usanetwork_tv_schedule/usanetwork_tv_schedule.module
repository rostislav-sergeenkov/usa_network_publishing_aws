<?php

/**
 * Implementation of hook_menu().
 */
function usanetwork_tv_schedule_menu() {
  // admin pages
  $items['admin/usanetwork/tv-schedule-settings'] = array(
    'title' => t('TV Schedule Settings'),
    'description' => t('Administer TV schedule settings.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('usanetwork_tv_schedule_settings_form'),
    'access arguments' => array('administer usanetwork'),
    'file' =>  'usanetwork_tv_schedule.admin.inc',
  );

  $items['schedule'] = array(
    'title' => t('Schedule'),
    'page callback' => 'uusanetwork_tv_schedule_schedule_page',
    'access arguments' => array('access content'),
  );
 
  return $items;
}

/**
 * TV schedule page menu callback
 */
function uusanetwork_tv_schedule_schedule_page() {
  $output = '';
  drupal_add_css(drupal_get_path('module', 'usanetwork_tv_schedule') . '/css/usanetwork_tv_schedule.css');

  $xml_feed = variable_get('usanetwork_tv_schedule_xml_feed', '');
  
  if (empty($xml_feed)) {
    drupal_not_found();
  }

  $sdate = date('Y_m_d');
  if (isset($_GET['sdate']) && !empty($_GET['sdate'])) {
    $sdate = $_GET['sdate'];
  }

  $xml_feed = str_replace('YYYY_MM_DD', $sdate, $xml_feed);

  $tvs = simplexml_load_file($xml_feed);

  if (!isset($tvs->Schedules->Schedule->ScheduleItem) || empty($tvs->Schedules->Schedule->ScheduleItem)) {
    drupal_not_found();
  }
   
  $header = array(
    t('TIME (ET)'),
    t('PROGRAM'),
    t('EPISODE'),
    t('RATING'),
  );
  $rows = array();
  foreach ($tvs->Schedules->Schedule->ScheduleItem as $item) {
    $start_time = (array) $item->StartTime;
    $program = (array) $item->ProgramName;
    $episode = (array) $item->TitleName;
    $rating = (array) $item->Rating;
    $cur_date = (array) $item->ScheduleDate;

    $rows[] = array(
      preg_replace('/:[0-9][0-9] /', ' ', $start_time[0]),
      $program[0],
      $episode[0],
      $rating[0],
    );
  }

  $cpath = current_path();
  $ctime = strtotime($cur_date[0]);
  
  $output .= l('<', $cpath, array('attributes' => array('class' => array('prev-day')), 'query' => array('sdate' => date('Y_m_d', $ctime-86400))));
  $output .= date('l M d, Y', $ctime);
  $output .= l('>', $cpath, array('attributes' => array('class' => array('next-day')), 'query' => array('sdate' => date('Y_m_d', $ctime+86400))));
  
  $output .= empty($rows) ? '' : theme('table',array('header' =>  $header, 'rows' => $rows, 'attributes' => array('width' => '100%')));

  return $output;
}
