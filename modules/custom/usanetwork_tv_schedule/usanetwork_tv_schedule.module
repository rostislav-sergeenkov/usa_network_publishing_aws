<?php

/**
 * Implementation of hook_menu().
 */
function usanetwork_tv_schedule_menu() {
  // admin pages
  $items['admin/usanetwork/tv-schedule-settings'] = array(
    'title' => t('TV Schedule Settings'),
    'description' => t('Administer TV schedule settings.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('usanetwork_tv_schedule_settings_form'),
    'access arguments' => array('administer usanetwork'),
    'file' =>  'usanetwork_tv_schedule.admin.inc',
  );

  $items['schedule'] = array(
    'title' => t('Schedule'),
    'page callback' => 'uusanetwork_tv_schedule_schedule_page',
    'access arguments' => array('access content'),
  );
 
  return $items;
}

/**
 * Implements hook_block_info().
 */
function usanetwork_tv_schedule_block_info() {
  $blocks = array();
  $blocks['usa_on_now_block'] = array(
    'info' => t('USA: on now block'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function usanetwork_tv_schedule_block_view($delta) {
  $block = array();
  //The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'usa_on_now_block':
      $block['subject'] = '';
      $block['content'] = usanetwork_tv_schedule_on_now_block();
      break;
  }
  return $block;
}

/**
 * Block callback for the On Now block
 */
function usanetwork_tv_schedule_on_now_block() {
  $render = array();
  
  // JS to determine the current timezone from the user browser
  drupal_add_js(drupal_get_path('module', 'usanetwork_tv_schedule') . '/js/jstz-1.0.4.min.js');

  $tv_url = variable_get('usanetwork_tv_schedule', '');
  // return empty block if the tv schedule url is empty
  if (empty($tv_url)) {
    return ''; 
  }

  // fetch today's schedule
  $tv_schedule = file_get_contents($tv_url);
  $tv_schedule = drupal_json_decode($tv_schedule);

  // fetch yesterday's schedule to load the schedule from 00:00 AM till 5:59 AM
  $tv_schedule_prev_day = file_get_contents($tv_url . '?sdate=' . date('m/d/Y', time() - 60 * 60 * 24));
  $tv_schedule_prev_day = drupal_json_decode($tv_schedule_prev_day);

  $full_tv_schedule = array('data' => array());
  $start_search = false;
  // get the tv schedule from 00:00 AM till 5:59 AM
  foreach ($tv_schedule_prev_day['data'] as $key => $val) {
    if (strpos($key, 'PM') !== FALSE) {
      $start_search = true;
    }
    if ($start_search && strpos($key, 'AM') !== FALSE) {
      $full_tv_schedule['data'][$key] = $val;
    } 
  }
  // get the tv schedule from 6:00 AM till end of the day
  foreach ($tv_schedule['data'] as $key => $val) {
    if (!isset($full_tv_schedule['data'][$key])) {
      $full_tv_schedule['data'][$key] = $val;
    }
  } 

  // expose the tv schedule as JS variable to determine the on on show based on the user timezone and for other modules to consume it
  $vars = 'var tv_schedule = ' . drupal_json_encode($full_tv_schedule) . ';';

  // switch to ET timezone to perform calculations and then switch back to original timezone
  $orginal_tz = date_default_timezone_get();
  date_default_timezone_set('America/New_York');
  $et_time = floatval(date('U'));

  foreach ($full_tv_schedule['data'] as $dt => $show) {
    $show_dt = strtotime(date('Y-m-d ').$dt);
    if ($et_time < $show_dt) {
      if (empty($last_dt)) {
        $last_dt = $dt;
      }
      $show_name = $full_tv_schedule['data'][$last_dt]['show'] .': '. $full_tv_schedule['data'][$last_dt]['episode'];
      break;
    }
    $last_dt = $dt;
  }
  date_default_timezone_set($orginal_tz);

  // expose default et show for rest of the world
  $show_name = strtoupper($show_name);
  $vars .= 'var on_now_default_show = "' . $show_name . '";';

  drupal_add_js($vars, array('type' => 'inline'));
  drupal_add_js(drupal_get_path('module', 'usanetwork_tv_schedule') . '/js/usanetwork_tv_schedule.js');

  // Handles the JS disabled browser scenario
  $markup = '&nbsp;<noscript>' . $show_name . '</noscript>';

  $render['on_now_block']['body'] = array(
    '#type' => 'markup',
    '#markup' => $markup,
  );

  return $render;
}

/**
 * TV schedule page menu callback
 */
function uusanetwork_tv_schedule_schedule_page() {
  $output = '';
  drupal_add_css(drupal_get_path('module', 'usanetwork_tv_schedule') . '/css/usanetwork_tv_schedule.css');

  $xml_feed = variable_get('usanetwork_tv_schedule_xml_feed', '');
  
  if (empty($xml_feed)) {
    drupal_not_found();
  }

  // switch to ET timezone to perform calculations and then switch back to original timezone
  $orginal_tz = date_default_timezone_get();
  date_default_timezone_set('America/New_York');
  $et_time = floatval(date('U'));

  $sdate = date('Y_m_d');
  if (isset($_GET['sdate']) && !empty($_GET['sdate'])) {
    $sdate = $_GET['sdate'];
    $et_time = strtotime(str_replace('_', '-', $sdate) . date(' H:i:s'));
  }

  // replace the tokens in the XML URL
  $xml_feed = str_replace('YYYY_MM_DD', $sdate, $xml_feed);

  $result = drupal_http_request($xml_feed);
  if ($result->headers['content-type'] != 'application/xml') {
    drupal_not_found();
  }

  $tvs = simplexml_load_file($xml_feed);

  if (!isset($tvs->Schedules->Schedule->ScheduleItem) || empty($tvs->Schedules->Schedule->ScheduleItem)) {
    drupal_not_found();
  }
   
  $header = array(
    t('TIME (ET)'),
    t('PROGRAM'),
    t('EPISODE'),
    t('RATING'),
  );
  $rows = array();
  $first = true;
  foreach ($tvs->Schedules->Schedule->ScheduleItem as $item) {
    $classes = array();
    
    $start_time = (array) $item->StartTime;
    $program = (array) $item->ProgramName;
    $episode = (array) $item->TitleName;
    $rating = (array) $item->Rating;
    $cur_date = (array) $item->ScheduleDate;
    $cal_date = (array) $item->CalendarScheduleDate;
    $day_part = (array) $item->Daypart;

    // convert to timestamp to determine on-air / off-air
    $show_time = strtotime($cal_date[0] .' '. $start_time[0]);

    // add styles to show hide the row based on on air value
    $classes[] = ($et_time >= $show_time) ? 'off-air' : 'on-air';

    // add classes like primetime to style differently
    $classes[] = strtolower($day_part[0]); 

    if ($first && $classes[0] == 'on-air') {
      $cnt = count($rows);
      $rows[$cnt-1]['class'][0] = 'on-air';
      $first = false;
    }

    $show = trim(preg_replace('/\(.*\)/', '', $program[0]));
    $nid = usanetwork_tv_schedule_get_nid_by_title($show, 'tv_show');
    if (empty($nid)) {
      $show = $program[0];
    } else {
      $path = drupal_get_path_alias('node/'.$nid);
      $show = l($program[0], $path);
    }

    $row = array(
      preg_replace('/:[0-9][0-9] /', ' ', $start_time[0]),
      $show,
      $episode[0],
      $rating[0],
    );
    $rows[] = array('data' => $row, 'class' => $classes);
    
  }

  $cpath = current_path();
  $ctime = strtotime($cur_date[0]);
  
  $output .= '<div class="schedule-header">';
  $output .= l('<', $cpath, array('attributes' => array('class' => array('prev-day')), 'query' => array('sdate' => date('Y_m_d', $ctime-86400))));
  $output .= '<span class="schedule-date">' . date('l M d, Y', $ctime) . '</span>';
  $output .= l('>', $cpath, array('attributes' => array('class' => array('next-day')), 'query' => array('sdate' => date('Y_m_d', $ctime+86400))));
  $output .= '</div>';
  
  $output .= empty($rows) ? '' : theme('table',array('header' =>  $header, 'rows' => $rows, 'attributes' => array('width' => '100%')));

  // switch back to original server time zone
  date_default_timezone_set($orginal_tz);

  return $output;
}

/**
 * Get node id given the title and type
 */
function usanetwork_tv_schedule_get_nid_by_title($title, $type) {
  $nid = 0;
  $query = new EntityFieldQuery();
  
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', $type)
    ->propertyCondition('title', $title)
    ->propertyCondition('status', 1)
    ->range(0, 1);
  
  $result = $query->execute();

  if (isset($result['node'])) {
    $nid = array_keys($result['node']);
    $nid = $nid[0];
  }
 
  return $nid;
}
