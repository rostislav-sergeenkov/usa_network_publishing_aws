<?php
/**
 * @file
 * Code for the usanetwork_tve_video feature.
 */

include_once 'usanetwork_tve_video.features.inc';

function usanetwork_tve_video_theme_registry_alter(&$theme_registry) {
  if (isset($theme_registry['tve_auth_welcome_window'])) {
    $theme_registry['tve_auth_welcome_window']['template'] = drupal_get_path('module', 'usanetwork_tve_video').'/templates/tve_auth_welcome_window';
  }
}

/**
 * Implements hook_theme().
 */
function usanetwork_tve_video_theme($existing, $type, $theme, $path) {

  $items = array();
  $items['usanetwork_tve_live_video'] = array(
    'variables' => array(
      'file' => NULL,
      'player_id' => NULL,
      'width' => NULL,
      'height' => NULL,
    ),
  );

  return $items;
}

/**
 * Theme function to render mpx video.
 */
function theme_usanetwork_tve_live_video($variables) {

  $file = (object) $variables['file'];

  $mpx_account = _media_theplatform_mpx_get_account_data($file->mpx_video_data['parent_account']);
  $mpx_account_pid = $mpx_account->account_pid;
  $mpx_account_default_player = media_theplatform_mpx_get_mpx_player_by_player_id($mpx_account->default_player);

  $player_id = !empty($variables['player_id']) ? $variables['player_id'] :
      (!empty($file->mpx_player_data['pid']) ? $file->mpx_player_data['pid'] : $mpx_account_default_player['pid']);

  $player_source = '//player.theplatform.com/p/' . $mpx_account_pid . '/' . $player_id;
  $player_parameters = array(
    'query' => (isset($variables['pub_mpx_player_parameters']) ? $variables['pub_mpx_player_parameters'] : array()),
    'external' => true,
  );
  $iframe_tag = array();
  $iframe_tag['element']['#tag'] = 'iframe';
  $iframe_tag['element']['#value'] = 'Your browser does not support iframes.';
  $iframe_tag['element']['#attributes'] = array(
    'src' => url($player_source, $player_parameters),
    'frameborder' => 0,
    'allowfullscreen' => '',
    'id' => 'pdk-player',
  );

  if (!empty($variables['width'])) {
    $iframe_tag['element']['#attributes']['width'] = $variables['width'];
  }
  if (!empty($variables['height'])) {
    $iframe_tag['element']['#attributes']['height'] = $variables['height'];
  }

  return theme('html_tag', $iframe_tag);
}
