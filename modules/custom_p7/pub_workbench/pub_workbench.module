<?php

/**
 * @file
 *
 * Module file for Publisher Workbench.
 */

include_once 'pub_workbench.features.inc';

/**
 * Implements hook_menu_alter().
 */
function pub_workbench_menu_alter(&$items) {
  $items['admin/workbench/content']['title'] = 'Dashboard';
  $items['admin/workbench/content/edited']['access callback'] = FALSE;
}

/**
 * Implements hook_views_default_alter().
 */
function pub_workbench_views_default_views_alter(&$views) {
  // Disable some of the Workbench Views.
  if (isset($views['workbench_current_user'])) {
    $views['workbench_current_user']->disabled = TRUE;
  }
  if (isset($views['workbench_edited'])) {
    $views['workbench_edited']->disabled = TRUE;
  }
  if (isset($views['workbench_recent_content'])) {
    $views['workbench_recent_content']->disabled = TRUE;
  }
  if (isset($views['workbench_moderation'])) {
    $views['workbench_moderation']->disabled = TRUE;
  }
  if (isset($views['state_flow_states_by_node'])) {
    $views['state_flow_states_by_node']->disabled = TRUE;
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function pub_workbench_form_node_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['revision_information'])) {
    $form['revision_information']['#access'] = FALSE;
  }
  if (isset($form['options'])) {
    // State Flow Entity Changes.
    $form['options']['#weight'] = -11;
    $form['options']['revision'] = $form['revision_information']['revision'];
    // We have to unset here we can't simply do #access = FALSE;
    unset($form['revision_information']['revision']);
    $form['options']['revision']['#weight'] = -10;
    $form['options']['state_flow']['event']['#title'] = t('Moderation State');
    $form['options']['#attributes']['class'][] = 'required-fields';
    $form['options']['promote']['#default_value'] = 0;
    $form['options']['promote']['#access'] = FALSE;
    $form['options']['sticky']['#default_value'] = 0;
    $form['options']['sticky']['#access'] = FALSE;
    $form['options']['#attached']['js'][drupal_get_path('module', 'pub_workbench') . '/pub_workbench.js'] = array(
      'weight' => 10
    );
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function pub_workbench_form_revision_scheduler_add_form_alter(&$form, &$form_state, $form_id){
  if (isset($form['datetime']['#date_format'])) {
    $form['datetime']['#date_format'] = variable_get('date_format_edit_date', 'm/d/Y - h:i A');
    $form['datetime']['#date_increment'] = 5;
  }
}

/**
 * Implements hook_workbench_content_alter().
 */
function pub_workbench_workbench_content_alter(&$output) {
  // Use our custom pub_workbench_current_user over workbench's defaults.
  $output['workbench_current_user']['#view'] = 'pub_workbench_current_user';
  $output['workbench_edited']['#view'] = 'pub_workbench_edited';
  $output['workbench_recent_content']['#view'] = 'pub_workbench_recent_content';
}

/**
 * Implementation of hook_preprocess_views_view_table().
 *
 * This is done to convert the "profile image" field to a thumbnail for image files.
 *
 */
function pub_workbench_preprocess_views_view_field(&$variables) {
  $view = $variables['view'];
  if ($view->name == 'pub_workbench_current_user'  && isset($variables['field']->definition['field_name']) &&  $variables['field']->definition['field_name'] == 'field_profile_image') {
    if (empty($variables['output'])) {
      // We could put the default picture here
      $variables['output'] = theme('image', array(
        'path' => drupal_get_path('module', 'workbench') . '/images/profile_default.png',
        'attributes' => array(
          'width' => '100px',
         ),
      ));
    }
  }
}

/**
 * Implements hook_workbench_module_implements_alter().
 */
function pub_workbench_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_node_form_alter' || $hook == 'form_alter') {
    // Move pub_workbench_form_node_form_alter() to the end of the list.
    // I did this in code instead of database because we want to be after,
    // workbench, workbench_moderation, state_flow_entity, state_machine.
    // A decent amount of modules, better done in code ;-/.
    if (isset($implementations['pub_workbench'])) {
      $group = $implementations['pub_workbench'];
      unset($implementations['pub_workbench']);
      $implementations['pub_workbench'] = $group;
    }
  }
}
