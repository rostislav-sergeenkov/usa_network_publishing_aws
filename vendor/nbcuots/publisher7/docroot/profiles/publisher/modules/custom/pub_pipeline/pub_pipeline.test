<?php

/**
 * @file
 * Tests for Pub Pipeline.
 */

class PubPipelineBaseTestCase extends PublisherWebTestCase {

  protected $env_indicator_user;
  protected $pipeline_info = array(
    'build_time' => 'Build time: 13:56 07/13/2014',
      'build_commit_list' => array(
        'data' => 'Build commit list: ',
        'children' => array(
          '<a href="https://github.com/NBCUOTS/Publisher7/commit/e31dd05e63f1c4be41306767ca1f2196828a9153">e31dd05</a>',
          '<a href="https://github.com/NBCUOTS/Publisher7/commit/2b5ca8a8b62fbd52d372e10a3039d5a31e53539b">2b5ca8a</a>',
          '<a href="https://github.com/NBCUOTS/Publisher7/commit/ad3434e60a6bb311195813ee4b6f4d49db9cc396">ad3434e</a>',
        ),
      ),
      'deploy_time' => 'Deploy time: 14:05 07/13/2014',
      'deploy_commit_list' => array(
        'data' => 'Deploy commit list: ',
        'children' => array(
          '<a href="https://github.com/NBCUOTS/Publisher7/commit/e31dd05e63f1c4be41306767ca1f2196828a9153">e31dd05</a>',
          '<a href="https://github.com/NBCUOTS/Publisher7/commit/2b5ca8a8b62fbd52d372e10a3039d5a31e53539b">2b5ca8a</a>',
          '<a href="https://github.com/NBCUOTS/Publisher7/commit/ad3434e60a6bb311195813ee4b6f4d49db9cc396">ad3434e</a>',
        ),
      ),
    );

  function setUp() {

    // Enable any modules required for the test.
    parent::setUp('pub_pipeline');
    // Create an admin user with permissions needed to run tests.
    $this->env_indicator_user = $this->drupalCreateUser(array('access environment indicator', 'access content', 'view files'));
  }

  function userLogin() {
    $edit = array(
      'name' => $this->env_indicator_user->mail,
      'pass' => $this->env_indicator_user->pass_raw,
    );
    $this->drupalPost('user/login', $edit, t('Log in'));
  }
}


class PubPipelineInfoPresentTest extends PubPipelineBaseTestCase {
  /**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => t('Pub Pipeline Info Present'),
      'description' => t('Check if Pipeline info is present in HTML source code.'),
      'group' => t('Publisher'),
    );
  }

  public function testPipelineInfo() {
    $pipeline_div = '<div id="pub-pipeline"';
    $build_time = 'Build time: 13:56 07/13/2014';
    variable_set('pub_pipeline_info', $this->pipeline_info);

    // Test that the user will get the markup in the source. The JS event handler does not get tested here though.
    $this->userLogin($this->env_indicator_user);
    $this->drupalGet('<front>');
    $this->assertRaw($pipeline_div, 'The #pub-pipeline div is present in the source code.');
    $this->assertRaw($build_time, 'The variable_set() added a Pipeline info render array.');
  }
}
